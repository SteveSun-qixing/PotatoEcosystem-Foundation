# 阶段5：界面组件模块

**阶段状态**: 待开发  
**优先级**: P1  
**依赖**: 阶段2完成  
**预计工作量**: 较高  
**可并行**: 与阶段4、阶段6可并行开发

---

## 一、阶段目标

完成4个界面组件模块的开发：
1. UIControls（基础控件库）
2. WindowManager（窗口管理器）
3. DragDropSystem（拖拽系统）
4. IFrameWrapper（网页框架组件）

---

## 二、模块开发顺序

```
UIControls（基础控件）← 其他模块的基础
      ↓
WindowManager（窗口管理）← 依赖 UIControls
      ↓
DragDropSystem（拖拽系统）← 依赖 UIControls
      ↓
IFrameWrapper（iframe封装）← 卡片渲染的核心
```

---

## 三、任务清单

### 模块5.1：UIControls（基础控件库）

#### 任务5.1.1：定义模块接口

```typescript
export interface IUIControls {
  // 创建控件
  createButton(config: ButtonConfig): UIButton;
  createInput(config: InputConfig): UIInput;
  createSelect(config: SelectConfig): UISelect;
  createSlider(config: SliderConfig): UISlider;
  createCheckbox(config: CheckboxConfig): UICheckbox;
  createDialog(config: DialogConfig): UIDialog;
  
  // 控件主题
  setTheme(themeId: string): void;
}

export interface UIComponent {
  readonly id: string;
  render(): HTMLElement;
  destroy(): void;
  setDisabled(disabled: boolean): void;
  setVisible(visible: boolean): void;
}

export interface ButtonConfig {
  text: string;
  onClick?: () => void;
  variant?: 'primary' | 'secondary' | 'text';
  size?: 'small' | 'medium' | 'large';
  disabled?: boolean;
}

export interface InputConfig {
  type?: 'text' | 'password' | 'number' | 'email';
  placeholder?: string;
  value?: string;
  onChange?: (value: string) => void;
  validation?: (value: string) => string | null;
}
```

#### 任务5.1.2：实现基础控件

**控件列表**:
1. Button - 按钮
2. Input - 输入框
3. Select - 下拉选择
4. Slider - 滑块
5. Checkbox - 复选框
6. Radio - 单选框
7. Switch - 开关
8. Dialog - 弹窗
9. Toast - 提示
10. Tooltip - 工具提示

**设计原则**:
- 只实现功能逻辑，不包含样式
- 暴露 CSS 类名和变量接口
- 支持主题注入

---

### 模块5.2：WindowManager（窗口管理器）

#### 任务5.2.1：定义模块接口

```typescript
export interface IWindowManager {
  // 窗口操作
  createWindow(config: WindowConfig): IWindow;
  closeWindow(windowId: string): void;
  
  // 窗口查询
  getWindow(windowId: string): IWindow | null;
  getAllWindows(): IWindow[];
  getActiveWindow(): IWindow | null;
  
  // 窗口层级
  bringToFront(windowId: string): void;
  sendToBack(windowId: string): void;
  
  // 布局
  arrangeWindows(arrangement: WindowArrangement): void;
}

export interface IWindow {
  readonly id: string;
  title: string;
  position: { x: number; y: number };
  size: { width: number; height: number };
  state: WindowState;
  
  // 操作
  move(x: number, y: number): void;
  resize(width: number, height: number): void;
  minimize(): void;
  maximize(): void;
  restore(): void;
  close(): void;
  focus(): void;
  
  // 内容
  setContent(content: HTMLElement): void;
  getContent(): HTMLElement;
  
  // 事件
  on(event: WindowEvent, handler: EventHandler): () => void;
}

export type WindowState = 'normal' | 'minimized' | 'maximized' | 'closed';
export type WindowEvent = 'move' | 'resize' | 'minimize' | 'maximize' | 'restore' | 'close' | 'focus' | 'blur';
```

#### 任务5.2.2：实现窗口功能

**功能要求**:
1. 窗口创建和销毁
2. 窗口拖动和缩放
3. 窗口最小化/最大化/还原
4. 窗口层级管理（z-index）
5. 窗口焦点管理

---

### 模块5.3：DragDropSystem（拖拽系统）

#### 任务5.3.1：定义模块接口

```typescript
export interface IDragDropSystem {
  // 注册可拖动元素
  registerDraggable(element: HTMLElement, config: DraggableConfig): () => void;
  
  // 注册放置区域
  registerDropZone(element: HTMLElement, config: DropZoneConfig): () => void;
  
  // 拖拽状态
  isDragging(): boolean;
  getCurrentDragData(): DragData | null;
  
  // 事件监听
  on(event: DragEvent, handler: DragEventHandler): () => void;
}

export interface DraggableConfig {
  data: unknown;
  dragImage?: HTMLElement;
  effectAllowed?: 'copy' | 'move' | 'link' | 'all';
  onDragStart?: (event: DragStartEvent) => void;
  onDragEnd?: (event: DragEndEvent) => void;
}

export interface DropZoneConfig {
  accept?: string[];    // 接受的数据类型
  onDragEnter?: (event: DragEnterEvent) => void;
  onDragOver?: (event: DragOverEvent) => void;
  onDragLeave?: (event: DragLeaveEvent) => void;
  onDrop?: (event: DropEvent) => void;
}

export interface DragData {
  type: string;
  data: unknown;
  source: HTMLElement;
}
```

#### 任务5.3.2：实现拖拽功能

**功能要求**:
1. 支持原生 HTML5 拖拽 API
2. 支持从操作系统拖入文件
3. 支持跨组件拖拽
4. 实时视觉反馈（预览、指示线）
5. 支持修饰键（Ctrl/Shift）

---

### 模块5.4：IFrameWrapper（网页框架组件）

#### 任务5.4.1：定义模块接口

```typescript
export interface IFrameWrapper {
  // 创建 iframe
  create(config: IFrameConfig): Promise<ManagedIFrame>;
  
  // 获取 iframe
  get(id: string): ManagedIFrame | null;
  
  // 销毁 iframe
  destroy(id: string): void;
  
  // 通信
  postMessage(iframeId: string, message: unknown, targetOrigin?: string): void;
}

export interface IFrameConfig {
  id?: string;
  html?: string;         // 直接加载 HTML 内容
  src?: string;          // 加载 URL
  width?: string | number;
  height?: string | number;
  transparent?: boolean;
  sandbox?: SandboxOption[];
  allowScripts?: boolean;
}

export interface ManagedIFrame {
  readonly id: string;
  readonly element: HTMLIFrameElement;
  readonly contentWindow: Window | null;
  
  // 操作
  setContent(html: string): void;
  setSrc(url: string): void;
  resize(width: number | string, height: number | string): void;
  
  // 通信
  postMessage(message: unknown, targetOrigin?: string): void;
  onMessage(handler: (message: MessageEvent) => void): () => void;
  
  // 生命周期
  destroy(): void;
}

export type SandboxOption = 
  | 'allow-scripts'
  | 'allow-same-origin'
  | 'allow-forms'
  | 'allow-popups'
  | 'allow-modals';
```

#### 任务5.4.2：实现 iframe 功能

**功能要求**:
1. 安全的 iframe 创建和管理
2. 沙箱权限控制
3. 安全的消息通信
4. 透明背景支持
5. 自动调整大小

**安全设计**:
- 默认启用 sandbox
- 限制脚本执行
- 消息来源验证

---

## 四、验收标准

- [ ] 四个模块全部实现
- [ ] 控件支持主题注入
- [ ] 测试覆盖率 ≥ 80%
- [ ] 代码提交到 Git 仓库

---

**文档版本**: 1.0.0  
**最后更新**: 2026-02-01
