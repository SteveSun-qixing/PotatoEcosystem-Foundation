# 阶段4：网络通信模块

**阶段状态**: 待开发  
**优先级**: P1  
**依赖**: 阶段2, 阶段3完成  
**预计工作量**: 中等  
**可并行**: 与阶段5、阶段6可并行开发

---

## 一、阶段目标

完成4个网络通信模块的开发：
1. HTTPClient（HTTP客户端）
2. DownloadManager（下载管理器）
3. CacheManager（缓存管理器）
4. ProtocolAdapter（协议适配器）

---

## 二、模块开发顺序

```
HTTPClient（HTTP客户端）← 基础网络请求
      ↓
CacheManager（缓存管理）← 依赖 HTTPClient
      ↓
DownloadManager（下载管理）← 依赖 HTTPClient, CacheManager
      ↓
ProtocolAdapter（协议适配）← 整合所有网络能力
```

---

## 三、任务清单

### 模块4.1：HTTPClient（HTTP客户端）

#### 任务4.1.1：定义模块接口

```typescript
export interface IHTTPClient {
  // 基础请求方法
  request<T>(config: RequestConfig): Promise<HTTPResponse<T>>;
  
  // 便捷方法
  get<T>(url: string, config?: RequestConfig): Promise<HTTPResponse<T>>;
  post<T>(url: string, data?: unknown, config?: RequestConfig): Promise<HTTPResponse<T>>;
  put<T>(url: string, data?: unknown, config?: RequestConfig): Promise<HTTPResponse<T>>;
  delete<T>(url: string, config?: RequestConfig): Promise<HTTPResponse<T>>;
  
  // 配置
  setDefaultHeaders(headers: Record<string, string>): void;
  setTimeout(timeout: number): void;
  
  // 拦截器
  addRequestInterceptor(interceptor: RequestInterceptor): () => void;
  addResponseInterceptor(interceptor: ResponseInterceptor): () => void;
}

export interface RequestConfig {
  url?: string;
  method?: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH';
  headers?: Record<string, string>;
  params?: Record<string, string>;
  data?: unknown;
  timeout?: number;
  responseType?: 'json' | 'text' | 'blob' | 'arraybuffer';
}

export interface HTTPResponse<T = unknown> {
  status: number;
  statusText: string;
  headers: Record<string, string>;
  data: T;
}
```

#### 任务4.1.2：实现请求功能

**功能要求**:
1. 基于 Fetch API 实现
2. 支持超时控制
3. 支持请求取消
4. 支持重试机制

---

### 模块4.2：CacheManager（缓存管理器）

#### 任务4.2.1：定义模块接口

```typescript
export interface ICacheManager {
  // 缓存操作
  get<T>(key: string): Promise<CacheEntry<T> | null>;
  set<T>(key: string, value: T, options?: CacheOptions): Promise<void>;
  delete(key: string): Promise<boolean>;
  has(key: string): Promise<boolean>;
  
  // 批量操作
  clear(pattern?: string): Promise<number>;
  
  // 缓存统计
  getStats(): Promise<CacheStats>;
  
  // 缓存策略
  setDefaultTTL(ttl: number): void;
  setMaxSize(maxSize: number): void;
}

export interface CacheEntry<T> {
  key: string;
  value: T;
  createdAt: number;
  expiresAt?: number;
  metadata?: Record<string, unknown>;
}

export interface CacheOptions {
  ttl?: number;        // 过期时间（毫秒）
  tags?: string[];     // 标签，用于批量清理
}

export interface CacheStats {
  size: number;
  count: number;
  hitRate: number;
}
```

#### 任务4.2.2：实现缓存存储

**功能要求**:
1. 内存缓存
2. 支持过期策略（TTL）
3. 支持大小限制（LRU淘汰）
4. 支持标签清理

---

### 模块4.3：DownloadManager（下载管理器）

#### 任务4.3.1：定义模块接口

```typescript
export interface IDownloadManager {
  // 下载操作
  download(url: string, options?: DownloadOptions): Promise<DownloadTask>;
  
  // 任务管理
  pause(taskId: string): Promise<void>;
  resume(taskId: string): Promise<void>;
  cancel(taskId: string): Promise<void>;
  
  // 任务查询
  getTask(taskId: string): DownloadTask | null;
  getAllTasks(): DownloadTask[];
  
  // 队列管理
  setMaxConcurrent(max: number): void;
}

export interface DownloadTask {
  id: string;
  url: string;
  status: DownloadStatus;
  progress: number;       // 0-100
  bytesDownloaded: number;
  totalBytes: number;
  speed: number;          // bytes/s
  error?: Error;
  
  // 事件
  onProgress?: (progress: number) => void;
  onComplete?: (result: ArrayBuffer) => void;
  onError?: (error: Error) => void;
}

export type DownloadStatus = 'pending' | 'downloading' | 'paused' | 'completed' | 'failed' | 'cancelled';

export interface DownloadOptions {
  savePath?: string;
  filename?: string;
  headers?: Record<string, string>;
  onProgress?: (progress: number) => void;
}
```

#### 任务4.3.2：实现下载功能

**功能要求**:
1. 进度跟踪
2. 断点续传（Range 请求）
3. 并发控制
4. 下载队列

---

### 模块4.4：ProtocolAdapter（协议适配器）

#### 任务4.4.1：定义模块接口

```typescript
export interface IProtocolAdapter {
  // 资源获取
  fetch(uri: string, options?: FetchOptions): Promise<ResourceResult>;
  
  // 协议注册
  registerProtocol(protocol: string, handler: IProtocolHandler): void;
  
  // 支持的协议
  getSupportedProtocols(): string[];
  
  // 资源检查
  exists(uri: string): Promise<boolean>;
  getMetadata(uri: string): Promise<ResourceMetadata>;
}

export interface IProtocolHandler {
  protocol: string;
  fetch(uri: string, options?: FetchOptions): Promise<ArrayBuffer>;
  exists(uri: string): Promise<boolean>;
  getMetadata(uri: string): Promise<ResourceMetadata>;
}

// 支持的协议
// - file://  本地文件
// - http://  HTTP资源
// - https:// HTTPS资源
// - chips:// 薯片内部资源
```

#### 任务4.4.2：实现协议处理器

**功能要求**:
1. FileProtocolHandler - 本地文件
2. HTTPProtocolHandler - HTTP/HTTPS
3. ChipsProtocolHandler - 薯片资源

---

## 四、验收标准

- [ ] 四个模块全部实现
- [ ] 测试覆盖率 ≥ 80%
- [ ] 代码提交到 Git 仓库

---

**文档版本**: 1.0.0  
**最后更新**: 2026-02-01
