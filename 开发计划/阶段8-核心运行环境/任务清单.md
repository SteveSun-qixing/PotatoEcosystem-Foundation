# 阶段8：核心运行环境模块

**阶段状态**: 待开发  
**优先级**: P2  
**依赖**: 阶段2完成  
**预计工作量**: 较高  
**可并行**: 与阶段7可并行开发

---

## 一、阶段目标

完成3个核心运行环境模块的开发：
1. RuntimeManager（运行时管理器）
2. ElectronFramework（Electron框架封装）
3. ChromiumCore（Chromium内核封装）

---

## 二、模块开发顺序

```
RuntimeManager（运行时管理）← 核心，管理模块生命周期
      ↓
ChromiumCore（Chromium封装）← 网页渲染基础
      ↓
ElectronFramework（Electron封装）← 桌面应用封装
```

---

## 三、任务清单

### 模块8.1：RuntimeManager（运行时管理器）

#### 任务8.1.1：定义模块接口

```typescript
export interface IRuntimeManager {
  // 模块管理
  loadModule(moduleId: string): Promise<IModule>;
  unloadModule(moduleId: string): Promise<void>;
  reloadModule(moduleId: string): Promise<IModule>;
  
  // 模块查询
  getModule(moduleId: string): IModule | null;
  getAllModules(): IModule[];
  isModuleLoaded(moduleId: string): boolean;
  
  // 模块依赖
  resolveDependencies(moduleId: string): string[];
  
  // 生命周期
  initialize(): Promise<void>;
  shutdown(): Promise<void>;
  
  // 事件
  onModuleLoad(handler: (moduleId: string) => void): () => void;
  onModuleUnload(handler: (moduleId: string) => void): () => void;
  onModuleError(handler: (moduleId: string, error: Error) => void): () => void;
  
  // 性能监控
  getModuleStats(moduleId: string): ModuleStats;
  getAllStats(): Map<string, ModuleStats>;
}

export interface ModuleStats {
  moduleId: string;
  loadTime: number;
  memoryUsage: number;
  callCount: number;
  errorCount: number;
  lastActive: number;
}

export interface ModuleDescriptor {
  id: string;
  name: string;
  version: string;
  description: string;
  dependencies: string[];
  entry: string;
  services: ServiceDescriptor[];
}

export interface ServiceDescriptor {
  name: string;
  method: string;
  inputSchema?: object;
  outputSchema?: object;
}
```

#### 任务8.1.2：实现模块加载器

**功能要求**:
1. 动态加载 ES 模块
2. 依赖解析和顺序加载
3. 循环依赖检测
4. 模块缓存

#### 任务8.1.3：实现生命周期管理

**功能要求**:
1. 模块初始化钩子
2. 模块销毁钩子
3. 错误隔离（单个模块错误不影响其他）
4. 优雅关闭

#### 任务8.1.4：实现模块注册表

**功能要求**:
1. 模块描述符存储
2. 服务路由表
3. 依赖关系图

---

### 模块8.2：ChromiumCore（Chromium内核封装）

#### 任务8.2.1：定义模块接口

```typescript
export interface IChromiumCore {
  // 浏览器视图
  createWebView(config: WebViewConfig): IWebView;
  
  // 渲染进程通信
  sendToRenderer(viewId: string, channel: string, data: unknown): void;
  onRendererMessage(channel: string, handler: (viewId: string, data: unknown) => void): () => void;
  
  // DevTools
  openDevTools(viewId: string): void;
  closeDevTools(viewId: string): void;
  
  // 版本信息
  getChromiumVersion(): string;
  getV8Version(): string;
}

export interface IWebView {
  readonly id: string;
  readonly element: HTMLElement;
  
  // 导航
  loadURL(url: string): Promise<void>;
  loadHTML(html: string): Promise<void>;
  reload(): void;
  stop(): void;
  goBack(): void;
  goForward(): void;
  
  // 状态
  getURL(): string;
  getTitle(): string;
  isLoading(): boolean;
  canGoBack(): boolean;
  canGoForward(): boolean;
  
  // 内容
  executeJavaScript(code: string): Promise<unknown>;
  insertCSS(css: string): Promise<string>;
  
  // 缩放
  setZoomFactor(factor: number): void;
  getZoomFactor(): number;
  
  // 事件
  onDidStartLoading(handler: () => void): () => void;
  onDidStopLoading(handler: () => void): () => void;
  onDidFailLoad(handler: (error: Error) => void): () => void;
  onPageTitleUpdated(handler: (title: string) => void): () => void;
  
  // 生命周期
  destroy(): void;
}

export interface WebViewConfig {
  preload?: string;
  partition?: string;
  enableRemoteModule?: boolean;
  webSecurity?: boolean;
  allowRunningInsecureContent?: boolean;
}
```

#### 任务8.2.2：实现 WebView 封装

**功能要求**:
1. 创建和管理 WebView 实例
2. 页面导航
3. JavaScript 执行
4. CSS 注入
5. 缩放控制

#### 任务8.2.3：实现安全策略

**功能要求**:
1. 内容安全策略（CSP）
2. 沙箱隔离
3. 预加载脚本安全
4. 跨域控制

---

### 模块8.3：ElectronFramework（Electron框架封装）

#### 任务8.3.1：定义模块接口

```typescript
export interface IElectronFramework {
  // 窗口管理
  createWindow(config: WindowConfig): Promise<IBrowserWindow>;
  getWindow(windowId: number): IBrowserWindow | null;
  getAllWindows(): IBrowserWindow[];
  getFocusedWindow(): IBrowserWindow | null;
  
  // 应用生命周期
  isReady(): boolean;
  whenReady(): Promise<void>;
  quit(): void;
  relaunch(): void;
  
  // 系统集成
  getPath(name: PathName): string;
  setPath(name: PathName, path: string): void;
  
  // 文件系统
  showOpenDialog(options: OpenDialogOptions): Promise<OpenDialogResult>;
  showSaveDialog(options: SaveDialogOptions): Promise<SaveDialogResult>;
  showMessageBox(options: MessageBoxOptions): Promise<MessageBoxResult>;
  
  // 剪贴板
  clipboard: IClipboard;
  
  // 系统托盘
  createTray(iconPath: string): ITray;
  
  // 菜单
  setApplicationMenu(menu: IMenu | null): void;
  
  // 协议处理
  registerProtocol(scheme: string, handler: ProtocolHandler): void;
  unregisterProtocol(scheme: string): void;
  
  // IPC
  ipcMain: IIPCMain;
}

export interface IBrowserWindow {
  readonly id: number;
  
  // 窗口操作
  show(): void;
  hide(): void;
  close(): void;
  destroy(): void;
  focus(): void;
  blur(): void;
  
  // 窗口状态
  minimize(): void;
  maximize(): void;
  unmaximize(): void;
  restore(): void;
  isMinimized(): boolean;
  isMaximized(): boolean;
  isVisible(): boolean;
  isFocused(): boolean;
  
  // 位置和大小
  setBounds(bounds: Rectangle): void;
  getBounds(): Rectangle;
  setPosition(x: number, y: number): void;
  getPosition(): [number, number];
  setSize(width: number, height: number): void;
  getSize(): [number, number];
  center(): void;
  
  // 标题
  setTitle(title: string): void;
  getTitle(): string;
  
  // 内容
  loadURL(url: string): Promise<void>;
  loadFile(filePath: string): Promise<void>;
  
  // 事件
  on(event: WindowEvent, handler: () => void): () => void;
  
  // WebContents
  webContents: IWebContents;
}

export type PathName = 'home' | 'appData' | 'userData' | 'temp' | 'documents' | 'downloads' | 'desktop';

export interface IClipboard {
  readText(): string;
  writeText(text: string): void;
  readHTML(): string;
  writeHTML(markup: string): void;
  readImage(): NativeImage;
  writeImage(image: NativeImage): void;
  clear(): void;
}
```

#### 任务8.3.2：实现窗口管理

**功能要求**:
1. 创建和管理 BrowserWindow
2. 窗口状态管理
3. 多窗口协调

#### 任务8.3.3：实现系统集成

**功能要求**:
1. 原生文件对话框
2. 剪贴板操作
3. 系统托盘
4. 应用菜单
5. 协议注册（chips://）

#### 任务8.3.4：实现 IPC 通信

**功能要求**:
1. 主进程与渲染进程通信
2. 同步和异步消息
3. 消息序列化

---

## 四、验收标准

- [ ] 三个模块全部实现
- [ ] 模块生命周期管理正确
- [ ] Electron 集成正常
- [ ] 测试覆盖率 ≥ 80%
- [ ] 代码提交到 Git 仓库

---

**文档版本**: 1.0.0  
**最后更新**: 2026-02-01
