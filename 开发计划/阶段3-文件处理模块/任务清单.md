# 阶段3：文件处理模块

**阶段状态**: 待开发  
**优先级**: P0  
**依赖**: 阶段2完成  
**预计工作量**: 中等

---

## 一、阶段目标

完成3个文件处理模块的开发：
1. ZIPProcessor（ZIP处理器）
2. FileIdentifier（文件识别器）
3. FormatConverter（格式转换器）

---

## 二、模块开发顺序

```
FileIdentifier（文件识别）← 基础，其他模块可能依赖
      ↓
ZIPProcessor（ZIP处理）← 卡片文件核心功能
      ↓
FormatConverter（格式转换）← 依赖前两个模块
```

---

## 三、任务清单

### 模块3.1：FileIdentifier（文件识别器）

#### 任务3.1.1：阅读需求文档和技术文档

**相关文档**:
- `需求文档/文件-FileIdentifier-需求.md`
- `技术文档/文件-FileIdentifier-技术.md`

---

#### 任务3.1.2：定义模块接口

```typescript
export interface IFileIdentifier {
  // 识别文件类型
  identify(input: FileInput): Promise<FileTypeResult>;
  
  // 批量识别
  identifyBatch(inputs: FileInput[]): Promise<FileTypeResult[]>;
  
  // 注册自定义类型
  registerType(definition: FileTypeDefinition): void;
  
  // 获取支持的类型列表
  getSupportedTypes(): FileTypeDefinition[];
}

export interface FileInput {
  path?: string;
  buffer?: ArrayBuffer;
  stream?: ReadableStream;
}

export interface FileTypeResult {
  type: string;              // 类型标识，如 'card', 'image/jpeg'
  extension: string;         // 扩展名，如 '.card', '.jpg'
  mimeType: string;          // MIME类型
  confidence: number;        // 置信度 0-1
  handler?: string;          // 处理器模块名
}

export interface FileTypeDefinition {
  type: string;
  extensions: string[];
  mimeTypes: string[];
  magicBytes?: number[];     // 文件头魔数
  validator?: (buffer: ArrayBuffer) => boolean;
}
```

---

#### 任务3.1.3：实现文件头检测

**功能要求**:
1. 读取文件头（前64字节）
2. 匹配已知文件类型的魔数
3. 支持自定义魔数规则

**魔数定义示例**:
```typescript
const MAGIC_BYTES: Record<string, number[]> = {
  'application/zip': [0x50, 0x4B, 0x03, 0x04],  // PK..
  'image/jpeg': [0xFF, 0xD8, 0xFF],
  'image/png': [0x89, 0x50, 0x4E, 0x47],        // .PNG
  'image/gif': [0x47, 0x49, 0x46],              // GIF
  'application/pdf': [0x25, 0x50, 0x44, 0x46],  // %PDF
  'video/mp4': [0x00, 0x00, 0x00, 0x18, 0x66, 0x74, 0x79, 0x70], // ftyp
};
```

---

#### 任务3.1.4：实现扩展名检测

**功能要求**:
1. 根据文件扩展名判断类型
2. 维护扩展名到类型的映射表
3. 支持 .card 和 .box 薯片专有格式

---

#### 任务3.1.5：实现薯片文件验证

**功能要求**:
1. 验证 .card 文件结构
2. 验证 .box 文件结构
3. 检查必需的配置文件是否存在

---

#### 任务3.1.6：整合并测试

**验收标准**:
- [ ] 常见格式识别正确
- [ ] 薯片格式验证正确
- [ ] 测试覆盖率 ≥ 80%

---

### 模块3.2：ZIPProcessor（ZIP处理器）

#### 任务3.2.1：阅读需求文档和技术文档

**相关文档**:
- `需求文档/文件-ZIPProcessor-需求.md`
- `技术文档/文件-ZIPProcessor-技术.md`

---

#### 任务3.2.2：定义模块接口

```typescript
export interface IZIPProcessor {
  // 创建 ZIP
  create(options: ZIPCreateOptions): Promise<ArrayBuffer>;
  
  // 解压 ZIP
  extract(input: ZIPInput, options?: ZIPExtractOptions): Promise<ZIPContents>;
  
  // 读取文件列表
  list(input: ZIPInput): Promise<ZIPFileEntry[]>;
  
  // 读取单个文件
  readFile(input: ZIPInput, path: string): Promise<ArrayBuffer>;
  
  // 添加文件到 ZIP
  addFile(input: ZIPInput, path: string, content: ArrayBuffer): Promise<ArrayBuffer>;
  
  // 删除文件
  removeFile(input: ZIPInput, path: string): Promise<ArrayBuffer>;
}

export interface ZIPCreateOptions {
  files: ZIPFileInput[];
  compression?: 'store' | 'deflate';  // 薯片文件使用 'store'（零压缩）
}

export interface ZIPFileInput {
  path: string;
  content: ArrayBuffer | string;
}

export interface ZIPContents {
  files: ZIPFileEntry[];
}

export interface ZIPFileEntry {
  path: string;
  size: number;
  compressedSize: number;
  isDirectory: boolean;
  lastModified: Date;
  content?: ArrayBuffer;
}
```

---

#### 任务3.2.3：基于 JSZip 实现核心功能

**功能要求**:
1. 使用 JSZip 库
2. 支持创建零压缩率 ZIP（用于卡片文件）
3. 支持流式读取大文件
4. 内存优化

---

#### 任务3.2.4：实现卡片文件专用方法

**功能要求**:
1. `createCard()` - 创建 .card 文件
2. `createBox()` - 创建 .box 文件
3. 自动创建必需的目录结构

---

#### 任务3.2.5：整合并测试

**验收标准**:
- [ ] ZIP 创建/解压正确
- [ ] 卡片文件操作正确
- [ ] 测试覆盖率 ≥ 80%

---

### 模块3.3：FormatConverter（格式转换器）

#### 任务3.3.1：阅读需求文档和技术文档

**相关文档**:
- `需求文档/文件-FormatConverter-需求.md`
- `技术文档/文件-FormatConverter-技术.md`

---

#### 任务3.3.2：定义模块接口

```typescript
export interface IFormatConverter {
  // 检查是否支持转换
  canConvert(from: string, to: string): boolean;
  
  // 执行转换
  convert(input: ConvertInput, targetFormat: string): Promise<ConvertResult>;
  
  // 获取支持的转换
  getSupportedConversions(): ConversionSupport[];
  
  // 注册转换器
  registerConverter(converter: IConverter): void;
}

export interface ConvertInput {
  data: ArrayBuffer | string;
  sourceFormat: string;
  options?: Record<string, unknown>;
}

export interface ConvertResult {
  data: ArrayBuffer | string;
  format: string;
  metadata?: Record<string, unknown>;
}

export interface IConverter {
  sourceFormats: string[];
  targetFormats: string[];
  convert(input: ArrayBuffer, options?: Record<string, unknown>): Promise<ArrayBuffer>;
}
```

---

#### 任务3.3.3：实现文本编码转换

**功能要求**:
1. UTF-8 ↔ UTF-16 ↔ GBK 等
2. 自动检测编码
3. BOM 处理

---

#### 任务3.3.4：实现数据格式转换

**功能要求**:
1. JSON ↔ YAML
2. CSV ↔ JSON
3. 保持数据完整性

---

#### 任务3.3.5：整合并测试

**验收标准**:
- [ ] 编码转换正确
- [ ] 格式转换正确
- [ ] 测试覆盖率 ≥ 80%

---

## 四、验收标准

### 功能验收
- [ ] 三个模块全部实现
- [ ] 所有接口符合设计文档
- [ ] 卡片文件操作正确

### 代码质量
- [ ] 测试覆盖率 ≥ 80%
- [ ] 代码通过 ESLint 检查

---

## 五、完成标志

1. ✅ FileIdentifier 模块完成并测试通过
2. ✅ ZIPProcessor 模块完成并测试通过
3. ✅ FormatConverter 模块完成并测试通过
4. ✅ 模块间集成测试通过
5. ✅ 代码提交到 Git 仓库

---

**文档版本**: 1.0.0  
**最后更新**: 2026-02-01
