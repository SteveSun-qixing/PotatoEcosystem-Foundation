# 阶段7：媒体组件模块

**阶段状态**: 待开发  
**优先级**: P2  
**依赖**: 阶段2, 阶段4, 阶段5完成  
**预计工作量**: 较高  
**可并行**: 与阶段8可并行开发

---

## 一、阶段目标

完成4个媒体组件模块的开发：
1. VideoPlayer（视频播放器）
2. AudioPlayer（音频播放器）
3. ImageViewer（图片查看器）
4. Model3DRenderer（3D模型渲染器）

---

## 二、模块开发顺序

```
ImageViewer（图片查看）← 相对简单
      ↓
AudioPlayer（音频播放）← 中等复杂度
      ↓
VideoPlayer（视频播放）← 较复杂
      ↓
Model3DRenderer（3D渲染）← 最复杂
```

---

## 三、任务清单

### 模块7.1：ImageViewer（图片查看器）

#### 任务7.1.1：定义模块接口

```typescript
export interface IImageViewer {
  // 创建查看器
  create(container: HTMLElement, config?: ImageViewerConfig): ImageViewerInstance;
}

export interface ImageViewerInstance {
  // 图片加载
  load(src: string): Promise<void>;
  
  // 查看操作
  zoomIn(factor?: number): void;
  zoomOut(factor?: number): void;
  zoomTo(scale: number): void;
  resetZoom(): void;
  
  rotate(degrees: number): void;
  flip(direction: 'horizontal' | 'vertical'): void;
  
  // 适配模式
  setFitMode(mode: FitMode): void;
  
  // 状态
  getZoom(): number;
  getRotation(): number;
  getNaturalSize(): { width: number; height: number };
  
  // 事件
  onLoad(handler: () => void): () => void;
  onError(handler: (error: Error) => void): () => void;
  onZoomChange(handler: (zoom: number) => void): () => void;
  
  // 生命周期
  destroy(): void;
}

export type FitMode = 'contain' | 'cover' | 'fill' | 'none' | 'scale-down';

export interface ImageViewerConfig {
  initialZoom?: number;
  minZoom?: number;
  maxZoom?: number;
  fitMode?: FitMode;
  enableZoom?: boolean;
  enablePan?: boolean;
  enableRotate?: boolean;
}
```

#### 任务7.1.2：实现查看器功能

**功能要求**:
1. 支持常见图片格式（JPG, PNG, GIF, WebP, SVG）
2. 缩放（滚轮、双击、按钮）
3. 平移（拖动）
4. 旋转（90度步进）
5. 翻转（水平、垂直）
6. 全屏查看

---

### 模块7.2：AudioPlayer（音频播放器）

#### 任务7.2.1：定义模块接口

```typescript
export interface IAudioPlayer {
  create(container: HTMLElement, config?: AudioPlayerConfig): AudioPlayerInstance;
}

export interface AudioPlayerInstance {
  // 加载
  load(src: string): Promise<void>;
  
  // 播放控制
  play(): Promise<void>;
  pause(): void;
  stop(): void;
  seek(time: number): void;
  
  // 音量
  setVolume(volume: number): void;  // 0-1
  getVolume(): number;
  setMuted(muted: boolean): void;
  isMuted(): boolean;
  
  // 播放速率
  setPlaybackRate(rate: number): void;
  getPlaybackRate(): number;
  
  // 状态
  isPlaying(): boolean;
  getCurrentTime(): number;
  getDuration(): number;
  
  // 波形可视化
  enableVisualization(type: VisualizationType): void;
  disableVisualization(): void;
  
  // 歌词
  loadLyrics(lyrics: LyricsData): void;
  
  // 事件
  onTimeUpdate(handler: (time: number) => void): () => void;
  onEnded(handler: () => void): () => void;
  onError(handler: (error: Error) => void): () => void;
  
  // 生命周期
  destroy(): void;
}

export type VisualizationType = 'waveform' | 'frequency' | 'none';

export interface LyricsData {
  lines: Array<{
    time: number;    // 开始时间（秒）
    text: string;    // 歌词文本
    duration?: number;
  }>;
}

export interface AudioPlayerConfig {
  autoplay?: boolean;
  loop?: boolean;
  volume?: number;
  showControls?: boolean;
  showVisualization?: boolean;
}
```

#### 任务7.2.2：实现播放器功能

**功能要求**:
1. 支持常见音频格式（MP3, WAV, FLAC, OGG）
2. 播放控制（播放、暂停、停止、跳转）
3. 音量控制
4. 播放速率
5. 波形可视化（使用 Web Audio API）
6. 歌词同步显示

---

### 模块7.3：VideoPlayer（视频播放器）

#### 任务7.3.1：定义模块接口

```typescript
export interface IVideoPlayer {
  create(container: HTMLElement, config?: VideoPlayerConfig): VideoPlayerInstance;
}

export interface VideoPlayerInstance {
  // 加载
  load(src: string): Promise<void>;
  
  // 播放控制
  play(): Promise<void>;
  pause(): void;
  stop(): void;
  seek(time: number): void;
  
  // 音量
  setVolume(volume: number): void;
  getVolume(): number;
  setMuted(muted: boolean): void;
  
  // 播放速率
  setPlaybackRate(rate: number): void;
  
  // 全屏
  requestFullscreen(): Promise<void>;
  exitFullscreen(): Promise<void>;
  isFullscreen(): boolean;
  
  // 字幕
  loadSubtitles(subtitles: SubtitleTrack[]): void;
  setSubtitleTrack(trackId: string | null): void;
  getSubtitleTracks(): SubtitleTrack[];
  getCurrentSubtitleTrack(): SubtitleTrack | null;
  
  // 画中画
  requestPictureInPicture(): Promise<void>;
  exitPictureInPicture(): Promise<void>;
  
  // 状态
  isPlaying(): boolean;
  getCurrentTime(): number;
  getDuration(): number;
  getBuffered(): TimeRanges;
  
  // 播放进度记忆
  saveProgress(): void;
  restoreProgress(): Promise<boolean>;
  
  // 事件
  onTimeUpdate(handler: (time: number) => void): () => void;
  onEnded(handler: () => void): () => void;
  onError(handler: (error: Error) => void): () => void;
  onSubtitleChange(handler: (text: string) => void): () => void;
  
  // 生命周期
  destroy(): void;
}

export interface SubtitleTrack {
  id: string;
  src: string;
  language: string;
  label: string;
  default?: boolean;
}

export interface VideoPlayerConfig {
  autoplay?: boolean;
  loop?: boolean;
  muted?: boolean;
  controls?: boolean;
  preload?: 'auto' | 'metadata' | 'none';
  poster?: string;
  playbackRate?: number;
}
```

#### 任务7.3.2：基于 video.js 实现

**功能要求**:
1. 支持常见视频格式（MP4, WebM, AVI）
2. 播放控制（播放、暂停、进度条、音量）
3. 字幕显示和切换
4. 播放速率调节
5. 全屏模式
6. 画中画模式
7. 播放进度记忆

---

### 模块7.4：Model3DRenderer（3D模型渲染器）

#### 任务7.4.1：定义模块接口

```typescript
export interface IModel3DRenderer {
  create(container: HTMLElement, config?: Model3DConfig): Model3DInstance;
}

export interface Model3DInstance {
  // 加载模型
  load(src: string, format?: ModelFormat): Promise<void>;
  
  // 视角控制
  rotate(x: number, y: number, z: number): void;
  setRotation(x: number, y: number, z: number): void;
  resetRotation(): void;
  
  zoom(factor: number): void;
  setZoom(value: number): void;
  resetZoom(): void;
  
  pan(x: number, y: number): void;
  resetView(): void;
  
  // 相机
  setCameraPosition(x: number, y: number, z: number): void;
  setCameraTarget(x: number, y: number, z: number): void;
  
  // 光照
  setLighting(config: LightingConfig): void;
  
  // 材质
  setWireframe(enabled: boolean): void;
  setMaterialColor(color: string): void;
  
  // 动画
  playAnimation(name?: string): void;
  pauseAnimation(): void;
  stopAnimation(): void;
  getAnimations(): string[];
  
  // 渲染
  render(): void;
  setAutoRotate(enabled: boolean, speed?: number): void;
  
  // 截图
  takeSnapshot(): string;  // base64 data URL
  
  // 事件
  onLoad(handler: () => void): () => void;
  onError(handler: (error: Error) => void): () => void;
  
  // 生命周期
  destroy(): void;
}

export type ModelFormat = 'gltf' | 'glb' | 'obj' | 'fbx' | 'stl';

export interface Model3DConfig {
  backgroundColor?: string;
  enableControls?: boolean;
  enableZoom?: boolean;
  enablePan?: boolean;
  enableRotate?: boolean;
  autoRotate?: boolean;
  autoRotateSpeed?: number;
}

export interface LightingConfig {
  ambient?: { color: string; intensity: number };
  directional?: Array<{ color: string; intensity: number; position: [number, number, number] }>;
}
```

#### 任务7.4.2：基于 Three.js 实现

**功能要求**:
1. 支持常见3D格式（GLTF/GLB, OBJ, FBX, STL）
2. 视角控制（旋转、缩放、平移）
3. 光照设置
4. 材质控制
5. 动画播放
6. 自动旋转展示
7. 截图功能

---

## 四、验收标准

- [ ] 四个模块全部实现
- [ ] 视频播放器支持字幕
- [ ] 3D渲染器支持主流格式
- [ ] 测试覆盖率 ≥ 80%
- [ ] 代码提交到 Git 仓库

---

**文档版本**: 1.0.0  
**最后更新**: 2026-02-01
