# 阶段6：文本处理模块

**阶段状态**: 待开发  
**优先级**: P1  
**依赖**: 阶段2完成  
**预计工作量**: 中等  
**可并行**: 与阶段4、阶段5可并行开发

---

## 一、阶段目标

完成4个文本处理模块的开发：
1. RichTextRenderer（富文本渲染器）
2. MarkdownParser（Markdown解析器）
3. CodeHighlighter（代码高亮器）
4. TextEditor（文本编辑器）

---

## 二、模块开发顺序

```
CodeHighlighter（代码高亮）← 独立，其他模块可能依赖
      ↓
MarkdownParser（Markdown解析）← 依赖 CodeHighlighter
      ↓
RichTextRenderer（富文本渲染）← 基础渲染能力
      ↓
TextEditor（文本编辑器）← 整合编辑能力
```

---

## 三、任务清单

### 模块6.1：CodeHighlighter（代码高亮器）

#### 任务6.1.1：定义模块接口

```typescript
export interface ICodeHighlighter {
  // 高亮代码
  highlight(code: string, language: string): HighlightResult;
  
  // 自动检测语言
  detectLanguage(code: string): DetectResult;
  
  // 获取支持的语言
  getSupportedLanguages(): LanguageInfo[];
  
  // 主题管理
  setTheme(themeId: string): void;
  getTheme(): string;
  getAvailableThemes(): ThemeInfo[];
  
  // 行号
  renderWithLineNumbers(code: string, language: string, options?: LineNumberOptions): string;
}

export interface HighlightResult {
  html: string;
  language: string;
  relevance: number;
}

export interface LanguageInfo {
  id: string;
  name: string;
  aliases: string[];
}

export interface ThemeInfo {
  id: string;
  name: string;
  type: 'light' | 'dark';
}

export interface LineNumberOptions {
  startLine?: number;
  highlightLines?: number[];
}
```

#### 任务6.1.2：基于 highlight.js 实现

**功能要求**:
1. 支持 50+ 编程语言
2. 支持多种高亮主题（github, monokai, dracula 等）
3. 支持行号显示
4. 支持行高亮

---

### 模块6.2：MarkdownParser（Markdown解析器）

#### 任务6.2.1：定义模块接口

```typescript
export interface IMarkdownParser {
  // 解析 Markdown
  parse(markdown: string, options?: ParseOptions): ParseResult;
  
  // 解析为 AST
  parseToAST(markdown: string): MarkdownAST;
  
  // 配置
  setOption(key: string, value: unknown): void;
  
  // 扩展
  use(extension: MarkdownExtension): void;
}

export interface ParseOptions {
  gfm?: boolean;           // GitHub Flavored Markdown
  breaks?: boolean;        // 换行符转 <br>
  sanitize?: boolean;      // HTML 清理
  smartypants?: boolean;   // 智能标点
  headerIds?: boolean;     // 标题 ID
  mangle?: boolean;        // 邮箱混淆
}

export interface ParseResult {
  html: string;
  toc?: TocItem[];         // 目录
  metadata?: Record<string, unknown>;  // Front Matter
}

export interface TocItem {
  level: number;
  text: string;
  id: string;
  children?: TocItem[];
}

export interface MarkdownExtension {
  name: string;
  renderer?: Record<string, (token: unknown) => string>;
  tokenizer?: Record<string, (src: string) => unknown>;
}
```

#### 任务6.2.2：基于 marked 实现

**功能要求**:
1. 支持标准 Markdown 语法
2. 支持 GFM 扩展
3. 支持代码高亮（集成 CodeHighlighter）
4. 支持目录生成
5. 支持 Front Matter

---

### 模块6.3：RichTextRenderer（富文本渲染器）

#### 任务6.3.1：定义模块接口

```typescript
export interface IRichTextRenderer {
  // 渲染富文本
  render(content: RichTextContent): HTMLElement;
  
  // 解析 HTML 为富文本结构
  parseHTML(html: string): RichTextContent;
  
  // 序列化为 HTML
  toHTML(content: RichTextContent): string;
  
  // 样式
  setStyles(styles: RichTextStyles): void;
}

export interface RichTextContent {
  type: 'document';
  content: RichTextNode[];
}

export type RichTextNode =
  | ParagraphNode
  | HeadingNode
  | ListNode
  | BlockquoteNode
  | CodeBlockNode
  | ImageNode
  | TextNode;

export interface TextNode {
  type: 'text';
  text: string;
  marks?: TextMark[];
}

export type TextMark =
  | { type: 'bold' }
  | { type: 'italic' }
  | { type: 'underline' }
  | { type: 'strike' }
  | { type: 'code' }
  | { type: 'link'; attrs: { href: string } }
  | { type: 'color'; attrs: { color: string } };
```

#### 任务6.3.2：实现渲染功能

**功能要求**:
1. 支持常见格式（加粗、斜体、下划线等）
2. 支持标题层级
3. 支持列表（有序、无序）
4. 支持链接和图片
5. 支持代码块

---

### 模块6.4：TextEditor（文本编辑器）

#### 任务6.4.1：定义模块接口

```typescript
export interface ITextEditor {
  // 创建编辑器
  create(container: HTMLElement, config?: EditorConfig): TextEditorInstance;
}

export interface TextEditorInstance {
  // 内容操作
  getValue(): string;
  setValue(value: string): void;
  insertText(text: string, position?: number): void;
  
  // 选择
  getSelection(): Selection;
  setSelection(start: number, end: number): void;
  
  // 历史
  undo(): void;
  redo(): void;
  canUndo(): boolean;
  canRedo(): boolean;
  
  // 搜索
  find(text: string, options?: FindOptions): FindResult[];
  replace(text: string, replacement: string, options?: FindOptions): number;
  
  // 事件
  onChange(handler: (value: string) => void): () => void;
  onSelectionChange(handler: (selection: Selection) => void): () => void;
  
  // 生命周期
  focus(): void;
  blur(): void;
  destroy(): void;
}

export interface EditorConfig {
  value?: string;
  placeholder?: string;
  readOnly?: boolean;
  lineNumbers?: boolean;
  wordWrap?: boolean;
  tabSize?: number;
}

export interface Selection {
  start: number;
  end: number;
  text: string;
}
```

#### 任务6.4.2：实现编辑器

**功能要求**:
1. 基础文本编辑
2. 撤销/重做
3. 搜索/替换
4. 行号显示
5. 自动换行

---

## 四、验收标准

- [ ] 四个模块全部实现
- [ ] 代码高亮支持主流语言
- [ ] Markdown 解析符合 GFM 规范
- [ ] 测试覆盖率 ≥ 80%
- [ ] 代码提交到 Git 仓库

---

**文档版本**: 1.0.0  
**最后更新**: 2026-02-01
