# 阶段9：卡片渲染模块

**阶段状态**: 待开发  
**优先级**: P2  
**依赖**: 阶段2-8所有模块完成  
**预计工作量**: 高（核心模块）

---

## 一、阶段目标

完成4个卡片渲染模块的开发，这是公共基础层的核心功能：
1. CardRenderer（卡片渲染引擎）
2. BaseCardRenderers（基础卡片渲染器集合）
3. BoxRenderer（箱子渲染引擎）
4. ThemeEngine（主题引擎）

---

## 二、模块开发顺序

```
ThemeEngine（主题引擎）← 其他渲染器需要
      ↓
BaseCardRenderers（基础卡片渲染器）← 26种卡片类型
      ↓
CardRenderer（卡片渲染引擎）← 组合基础卡片
      ↓
BoxRenderer（箱子渲染引擎）← 依赖卡片渲染
```

---

## 三、任务清单

### 模块9.1：ThemeEngine（主题引擎）

#### 任务9.1.1：阅读设计文档

**相关文档**:
- `技术文档/04-卡片渲染系统设计.md`
- `需求文档/03-卡片渲染模块需求.md`
- `生态设计原稿（一切标准）/30-卡片渲染机制详解.md`

---

#### 任务9.1.2：定义模块接口

```typescript
export interface IThemeEngine {
  // 加载主题包
  loadTheme(themeId: string): Promise<Theme>;
  
  // 应用主题
  applyToHTML(html: string, themeId: string): Promise<string>;
  applyToElement(element: HTMLElement, themeId: string): void;
  
  // 创建主题背景
  createThemeBackground(themeId: string, metadata: CardMetadata): Promise<HTMLIFrameElement>;
  
  // 主题层级解析
  resolveTheme(config: ThemeHierarchyConfig): string;
  
  // 主题管理
  getLoadedThemes(): Theme[];
  isThemeLoaded(themeId: string): boolean;
  unloadTheme(themeId: string): void;
  
  // 缓存管理
  clearCache(): void;
}

export interface Theme {
  id: string;              // 格式：发行商:主题名
  name: string;
  version: string;
  type: 'light' | 'dark';
  
  // 样式内容
  cssVariables: Record<string, string>;
  cssContent: string;
  
  // 组件样式
  componentStyles: Record<string, string>;
  
  // 资源
  assets?: ThemeAssets;
}

export interface ThemeHierarchyConfig {
  componentTheme?: string;
  cardTheme?: string;
  appTheme?: string;
  globalTheme?: string;
}

export interface ThemeAssets {
  backgroundImage?: string;
  icons?: Record<string, string>;
}
```

#### 任务9.1.3：实现主题加载

**功能要求**:
1. 解析主题包结构
2. 提取 CSS 变量和样式
3. 缓存已加载主题

#### 任务9.1.4：实现主题应用

**功能要求**:
1. CSS 变量注入
2. 组件类型样式匹配
3. 层级覆盖（组件 > 卡片 > 应用 > 全局）

#### 任务9.1.5：实现主题背景

**功能要求**:
1. 生成背景网页
2. 支持装饰元素
3. 透明度控制

---

### 模块9.2：BaseCardRenderers（基础卡片渲染器集合）

#### 任务9.2.1：定义通用接口

```typescript
export interface IBaseCardRenderer {
  // 渲染基础卡片
  render(config: BaseCardConfig, options?: RenderOptions): Promise<string>;
  
  // 获取支持的卡片类型
  getSupportedType(): string;
  
  // 获取渲染器信息
  getInfo(): RendererInfo;
}

export interface BaseCardConfig {
  id: string;
  type: string;
  theme?: string;
  content: unknown;
}

export interface RenderOptions {
  interactive?: boolean;
  readonly?: boolean;
  quality?: 'low' | 'medium' | 'high';
  themeId?: string;
}

export interface RendererInfo {
  type: string;
  name: string;
  version: string;
  dependencies: string[];
}
```

#### 任务9.2.2：实现文本类渲染器

**渲染器列表**:
1. `RichTextCardRenderer` - 富文本卡片
2. `MarkdownCardRenderer` - Markdown 卡片
3. `CodeBlockCardRenderer` - 代码块卡片

**依赖模块**:
- RichTextRenderer
- MarkdownParser
- CodeHighlighter

---

#### 任务9.2.3：实现媒体类渲染器

**渲染器列表**:
1. `ImageCardRenderer` - 图片卡片
2. `VideoCardRenderer` - 视频卡片
3. `AudioCardRenderer` - 音频卡片
4. `Model3DCardRenderer` - 3D模型卡片

**依赖模块**:
- ImageViewer
- VideoPlayer
- AudioPlayer
- Model3DRenderer

---

#### 任务9.2.4：实现交互类渲染器

**渲染器列表**:
1. `ListCardRenderer` - 列表卡片（待办、有序、无序）
2. `RatingCardRenderer` - 打分卡片
3. `WebPageCardRenderer` - 网页卡片
4. `GameCardRenderer` - 游戏卡片（iframe 嵌入）
5. `AppCardRenderer` - 应用卡片（iframe 嵌入）

---

#### 任务9.2.5：实现专业类渲染器

**渲染器列表**:
1. `CalendarCardRenderer` - 日历卡片
2. `OneDayCardRenderer` - 一天卡片
3. `GanttChartCardRenderer` - 甘特图卡片
4. `HeatmapCardRenderer` - 热力图卡片
5. `MindMapCardRenderer` - 思维导图卡片
6. `InfiniteCanvasCardRenderer` - 无限画布卡片
7. `MapCardRenderer` - 地图卡片

---

#### 任务9.2.6：实现内容类渲染器

**渲染器列表**:
1. `SeriesCardRenderer` - 剧集卡片
2. `ImageTextCardRenderer` - 图文卡片
3. `PostCardRenderer` - 帖子卡片
4. `ChatRecordCardRenderer` - 聊天记录卡片

---

#### 任务9.2.7：实现信息类渲染器

**渲染器列表**:
1. `BusinessCardRenderer` - 名片卡片
2. `ProductCardRenderer` - 商品卡片
3. `AppleDeviceCardRenderer` - 果式设备卡片

---

### 模块9.3：CardRenderer（卡片渲染引擎）

#### 任务9.3.1：定义模块接口

```typescript
export interface ICardRenderer {
  // 渲染卡片
  render(request: CardRenderRequest): Promise<CardRenderResult>;
  
  // 解析卡片（不渲染）
  parse(cardId: string): Promise<CardStructure>;
  
  // 销毁渲染结果
  dispose(renderId: string): void;
  
  // 注册基础卡片渲染器
  registerRenderer(renderer: IBaseCardRenderer): void;
  
  // 获取已注册渲染器
  getRenderer(type: string): IBaseCardRenderer | null;
}

export interface CardRenderRequest {
  card_id: string;
  container_id: string;
  options?: {
    theme_id?: string;
    interactive?: boolean;
    readonly?: boolean;
    quality?: 'low' | 'medium' | 'high';
    lazy_load?: boolean;
    virtual_scroll?: boolean;
  };
}

export interface CardRenderResult {
  render_id: string;
  frame: HTMLIFrameElement;
  metadata: CardMetadata;
  timestamp: number;
}

export interface CardStructure {
  metadata: CardMetadata;
  base_cards: BaseCardInfo[];
  theme_config?: ThemeConfig;
}

export interface CardMetadata {
  id: string;
  name: string;
  created_at: string;
  modified_at: string;
  theme?: string;
  tags?: string[];
}
```

#### 任务9.3.2：实现卡片解析

**功能要求**:
1. 使用 ZIPProcessor 读取 .card 文件
2. 解析 metadata.yaml
3. 解析 structure.yaml
4. 读取 content/ 下的配置文件

---

#### 任务9.3.3：实现基础卡片渲染

**功能要求**:
1. 根据类型调用对应 BaseCardRenderer
2. 创建 iframe 窗口
3. 设置 iframe 背景透明

---

#### 任务9.3.4：实现组合渲染

**功能要求**:
1. 垂直排列所有基础卡片 iframe
2. 创建菜单栏
3. 应用主题背景
4. 生成最终的大 iframe

---

#### 任务9.3.5：实现性能优化

**功能要求**:
1. 懒加载（进入视口才渲染）
2. 虚拟滚动（大卡片优化）
3. 渲染缓存
4. 增量渲染

---

### 模块9.4：BoxRenderer（箱子渲染引擎）

#### 任务9.4.1：定义模块接口

```typescript
export interface IBoxRenderer {
  // 渲染箱子
  render(request: BoxRenderRequest): Promise<BoxRenderResult>;
  
  // 解析箱子
  parse(boxId: string): Promise<BoxStructure>;
  
  // 布局插件管理
  registerLayoutPlugin(plugin: ILayoutPlugin): void;
  getLayoutPlugin(type: string): ILayoutPlugin | null;
}

export interface BoxRenderRequest {
  box_id: string;
  container_id: string;
  options?: {
    theme_id?: string;
    interactive?: boolean;
    load_external?: boolean;
    layout_config?: unknown;
  };
}

export interface BoxRenderResult {
  render_id: string;
  frame: HTMLIFrameElement;
  metadata: BoxMetadata;
  timestamp: number;
}

export interface BoxStructure {
  metadata: BoxMetadata;
  cards: CardSummary[];
  layout_config: LayoutConfig;
}

export interface ILayoutPlugin {
  type: string;
  name: string;
  
  render(params: {
    cards: CardSummary[];
    config: LayoutConfig;
  }): Promise<string>;
  
  getDefaultConfig(): LayoutConfig;
}
```

#### 任务9.4.2：实现箱子解析

**功能要求**:
1. 使用 ZIPProcessor 读取 .box 文件
2. 解析配置文件
3. 处理内部和外部卡片引用

---

#### 任务9.4.3：实现布局插件系统

**功能要求**:
1. 插件注册和加载
2. 插件配置传递
3. 默认布局插件

---

#### 任务9.4.4：实现基础布局插件

**布局插件列表**:
1. `ListLayoutPlugin` - 列表布局
2. `GridLayoutPlugin` - 网格布局
3. `WaterfallLayoutPlugin` - 瀑布流布局
4. `InfiniteDesktopLayoutPlugin` - 无限桌面布局

---

## 四、验收标准

### 功能验收
- [ ] 四个模块全部实现
- [ ] 26种基础卡片渲染器完成
- [ ] 4种箱子布局插件完成
- [ ] 主题系统正常工作

### 渲染验收
- [ ] 卡片文件可正确解析
- [ ] 基础卡片正确渲染到 iframe
- [ ] 复合卡片正确组合
- [ ] 箱子布局正确显示

### 性能验收
- [ ] 懒加载正常工作
- [ ] 大量卡片时不卡顿
- [ ] 内存使用合理

### 代码质量
- [ ] 测试覆盖率 ≥ 80%
- [ ] 代码提交到 Git 仓库

---

## 五、完成标志

1. ✅ ThemeEngine 模块完成
2. ✅ 26种 BaseCardRenderers 完成
3. ✅ CardRenderer 模块完成
4. ✅ BoxRenderer 模块完成
5. ✅ 4种布局插件完成
6. ✅ 集成测试通过
7. ✅ 性能测试达标

---

**文档版本**: 1.0.0  
**最后更新**: 2026-02-01
