# 阶段2：系统服务模块

**阶段状态**: 待开发  
**优先级**: P0（最高）  
**依赖**: 阶段1完成  
**预计工作量**: 中等

---

## 一、阶段目标

完成4个系统服务模块的开发，这些模块是所有其他模块的基础依赖：
1. DataSerializer（数据序列化器）
2. LogSystem（日志系统）
3. I18nSystem（多语言系统）
4. ConfigManager（配置管理器）

---

## 二、模块开发顺序

```
DataSerializer（数据序列化）
      ↓
LogSystem（日志系统）← 依赖 DataSerializer
      ↓
ConfigManager（配置管理）← 依赖 DataSerializer, LogSystem
      ↓
I18nSystem（多语言系统）← 依赖 DataSerializer, ConfigManager
```

---

## 三、任务清单

### 模块2.1：DataSerializer（数据序列化器）

#### 任务2.1.1：阅读需求文档和技术文档

**任务描述**: 阅读并理解 DataSerializer 模块的需求和技术设计。

**相关文档**:
- `需求文档/系统-DataSerializer-需求.md`
- `技术文档/系统-DataSerializer-技术.md`

**验收标准**:
- [ ] 理解模块功能需求
- [ ] 理解接口设计
- [ ] 理解技术实现方案

---

#### 任务2.1.2：创建模块目录结构

**任务描述**: 创建 DataSerializer 模块的目录结构。

**目录结构**:
```
src/system/data-serializer/
├── index.ts                 # 模块入口
├── data-serializer.ts       # 主实现
├── parsers/
│   ├── yaml-parser.ts       # YAML解析器
│   ├── json-parser.ts       # JSON解析器
│   └── index.ts
├── validators/
│   ├── schema-validator.ts  # Schema验证器
│   └── index.ts
├── types/
│   └── index.ts             # 类型定义
└── __tests__/
    ├── data-serializer.test.ts
    ├── yaml-parser.test.ts
    └── json-parser.test.ts
```

**验收标准**:
- [ ] 目录结构符合规范
- [ ] 文件命名正确

---

#### 任务2.1.3：定义模块接口

**任务描述**: 定义 DataSerializer 模块的接口。

**接口定义**:
```typescript
// src/system/data-serializer/types/index.ts

export interface IDataSerializer {
  // YAML 操作
  parseYAML<T>(content: string): T;
  stringifyYAML(data: unknown): string;
  
  // JSON 操作
  parseJSON<T>(content: string): T;
  stringifyJSON(data: unknown, pretty?: boolean): string;
  
  // 通用操作
  parse<T>(content: string, format: DataFormat): T;
  stringify(data: unknown, format: DataFormat, options?: StringifyOptions): string;
  
  // Schema 验证
  validate<T>(data: unknown, schema: JSONSchema): ValidationResult<T>;
}

export type DataFormat = 'yaml' | 'json';

export interface StringifyOptions {
  pretty?: boolean;
  indent?: number;
}

export interface ValidationResult<T> {
  valid: boolean;
  data?: T;
  errors?: ValidationError[];
}

export interface ValidationError {
  path: string;
  message: string;
  keyword: string;
}
```

**验收标准**:
- [ ] 接口定义完整
- [ ] 类型安全
- [ ] 文档注释完善

---

#### 任务2.1.4：实现 YAML 解析器

**任务描述**: 基于 js-yaml 库实现 YAML 解析和生成功能。

**功能要求**:
1. 支持解析 YAML 字符串为 JavaScript 对象
2. 支持将 JavaScript 对象序列化为 YAML 字符串
3. 支持多文档 YAML
4. 错误处理和友好提示

**实现示例**:
```typescript
// src/system/data-serializer/parsers/yaml-parser.ts
import yaml from 'js-yaml';

export class YAMLParser {
  parse<T>(content: string): T {
    try {
      return yaml.load(content) as T;
    } catch (error) {
      throw new ChipsError(
        'SER-1001',
        `Failed to parse YAML: ${(error as Error).message}`,
        { content: content.substring(0, 100) }
      );
    }
  }

  stringify(data: unknown, options?: { indent?: number }): string {
    try {
      return yaml.dump(data, {
        indent: options?.indent ?? 2,
        lineWidth: -1,
        noRefs: true
      });
    } catch (error) {
      throw new ChipsError(
        'SER-1002',
        `Failed to stringify YAML: ${(error as Error).message}`
      );
    }
  }
}
```

**验收标准**:
- [ ] 解析功能正确
- [ ] 序列化功能正确
- [ ] 错误处理完善
- [ ] 单元测试覆盖率 ≥ 80%

---

#### 任务2.1.5：实现 JSON 解析器

**任务描述**: 实现 JSON 解析和生成功能。

**功能要求**:
1. 支持解析 JSON 字符串
2. 支持序列化为 JSON（可选美化输出）
3. 支持大数字处理
4. 错误处理

**验收标准**:
- [ ] 解析功能正确
- [ ] 序列化功能正确
- [ ] 单元测试通过

---

#### 任务2.1.6：实现 Schema 验证器

**任务描述**: 实现基于 JSON Schema 的数据验证功能。

**功能要求**:
1. 支持 JSON Schema Draft-07
2. 返回详细的验证错误信息
3. 支持自定义验证规则

**验收标准**:
- [ ] 验证功能正确
- [ ] 错误信息详细
- [ ] 单元测试通过

---

#### 任务2.1.7：整合并测试

**任务描述**: 整合所有组件，创建主类并完成测试。

**验收标准**:
- [ ] 模块可正常导入使用
- [ ] 所有接口实现完整
- [ ] 测试覆盖率 ≥ 80%

---

### 模块2.2：LogSystem（日志系统）

#### 任务2.2.1：阅读需求文档和技术文档

**相关文档**:
- `需求文档/系统-LogSystem-需求.md`
- `技术文档/系统-LogSystem-技术.md`

---

#### 任务2.2.2：创建模块目录结构

**目录结构**:
```
src/system/log-system/
├── index.ts
├── log-system.ts           # 主实现
├── logger.ts               # Logger 类
├── transports/
│   ├── console-transport.ts
│   ├── file-transport.ts
│   └── index.ts
├── formatters/
│   ├── default-formatter.ts
│   ├── json-formatter.ts
│   └── index.ts
├── types/
│   └── index.ts
└── __tests__/
    └── log-system.test.ts
```

---

#### 任务2.2.3：定义模块接口

**接口定义**:
```typescript
// src/system/log-system/types/index.ts

export interface ILogSystem {
  debug(message: string, context?: LogContext): void;
  info(message: string, context?: LogContext): void;
  warn(message: string, context?: LogContext): void;
  error(message: string, error?: Error, context?: LogContext): void;
  
  setLevel(level: LogLevel): void;
  getLevel(): LogLevel;
  
  addTransport(transport: ILogTransport): void;
  removeTransport(transportId: string): void;
  
  query(options: LogQueryOptions): Promise<LogEntry[]>;
  clear(options?: LogClearOptions): Promise<void>;
}

export type LogLevel = 'debug' | 'info' | 'warn' | 'error';

export interface LogContext {
  module?: string;
  action?: string;
  userId?: string;
  requestId?: string;
  data?: Record<string, unknown>;
}

export interface LogEntry {
  timestamp: number;
  level: LogLevel;
  message: string;
  context?: LogContext;
  error?: {
    name: string;
    message: string;
    stack?: string;
  };
}

export interface ILogTransport {
  id: string;
  write(entry: LogEntry): void | Promise<void>;
}
```

---

#### 任务2.2.4：实现日志核心功能

**功能要求**:
1. 支持四个日志级别：debug, info, warn, error
2. 支持日志级别过滤
3. 支持结构化日志上下文
4. 线程安全（异步处理）

---

#### 任务2.2.5：实现日志传输器

**功能要求**:
1. ConsoleTransport：输出到控制台
2. FileTransport：输出到文件（支持日志轮转）
3. 支持自定义传输器

---

#### 任务2.2.6：实现日志格式化器

**功能要求**:
1. DefaultFormatter：人类可读格式
2. JSONFormatter：JSON 格式（便于分析）

---

#### 任务2.2.7：整合并测试

**验收标准**:
- [ ] 所有日志级别正常工作
- [ ] 传输器正常工作
- [ ] 测试覆盖率 ≥ 80%

---

### 模块2.3：ConfigManager（配置管理器）

#### 任务2.3.1：阅读需求文档和技术文档

**相关文档**:
- `需求文档/系统-ConfigManager-需求.md`
- `技术文档/系统-ConfigManager-技术.md`

---

#### 任务2.3.2：创建模块目录结构

**目录结构**:
```
src/system/config-manager/
├── index.ts
├── config-manager.ts       # 主实现
├── config-store.ts         # 配置存储
├── config-watcher.ts       # 配置监听
├── types/
│   └── index.ts
└── __tests__/
    └── config-manager.test.ts
```

---

#### 任务2.3.3：定义模块接口

**接口定义**:
```typescript
// src/system/config-manager/types/index.ts

export interface IConfigManager {
  // 读取配置
  get<T>(key: string, defaultValue?: T): T | undefined;
  getAll(): Record<string, unknown>;
  
  // 写入配置
  set(key: string, value: unknown): void;
  setMultiple(configs: Record<string, unknown>): void;
  
  // 删除配置
  delete(key: string): boolean;
  
  // 检查配置
  has(key: string): boolean;
  
  // 配置监听
  watch(key: string, callback: ConfigChangeCallback): () => void;
  
  // 配置加载/保存
  load(filePath: string): Promise<void>;
  save(filePath?: string): Promise<void>;
  
  // 配置合并（层级覆盖）
  merge(source: Record<string, unknown>, scope?: ConfigScope): void;
}

export type ConfigScope = 'default' | 'system' | 'user' | 'runtime';

export type ConfigChangeCallback = (
  newValue: unknown,
  oldValue: unknown,
  key: string
) => void;
```

---

#### 任务2.3.4：实现配置存储

**功能要求**:
1. 支持点分隔路径访问（如 `cache.maxSize`）
2. 支持类型安全的读取
3. 支持深度合并

---

#### 任务2.3.5：实现层级配置覆盖

**功能要求**:
1. 支持四层配置：default < system < user < runtime
2. 高层级配置覆盖低层级
3. 支持配置来源追踪

---

#### 任务2.3.6：实现配置监听

**功能要求**:
1. 支持监听特定配置项的变化
2. 支持通配符监听
3. 变化时触发回调

---

#### 任务2.3.7：整合并测试

**验收标准**:
- [ ] 配置读写正常
- [ ] 层级覆盖正确
- [ ] 监听机制正常
- [ ] 测试覆盖率 ≥ 80%

---

### 模块2.4：I18nSystem（多语言系统）

#### 任务2.4.1：阅读需求文档和技术文档

**相关文档**:
- `需求文档/系统-I18nSystem-需求.md`
- `技术文档/系统-I18nSystem-技术.md`
- `生态共用/11-多语言系统规范.md`

---

#### 任务2.4.2：创建模块目录结构

**目录结构**:
```
src/system/i18n-system/
├── index.ts
├── i18n-system.ts          # 主实现
├── vocabulary-store.ts     # 词汇存储
├── interpolator.ts         # 变量插值
├── types/
│   └── index.ts
└── __tests__/
    └── i18n-system.test.ts
```

---

#### 任务2.4.3：定义模块接口

**接口定义**:
```typescript
// src/system/i18n-system/types/index.ts

export interface II18nSystem {
  // 文本翻译
  t(code: string, vars?: Record<string, string | number>): string;
  
  // 语言管理
  setLanguage(lang: SupportedLanguage): void;
  getLanguage(): SupportedLanguage;
  getSupportedLanguages(): SupportedLanguage[];
  
  // 词汇表管理
  loadVocabulary(vocabulary: VocabularyData): void;
  registerVocabulary(code: string, translations: LanguageTranslations): void;
  
  // 批量翻译
  translateBatch(codes: string[]): Record<string, string>;
}

export type SupportedLanguage = 'zh-CN' | 'zh-TW' | 'en-US' | 'ja-JP' | 'ko-KR';

export interface VocabularyData {
  version: string;
  vocabulary: Record<string, LanguageTranslations>;
}

export type LanguageTranslations = Record<SupportedLanguage, string>;
```

---

#### 任务2.4.4：实现词汇存储

**功能要求**:
1. 存储词汇编码和多语言文本映射
2. 支持按编码查找
3. 支持缓存优化

---

#### 任务2.4.5：实现变量插值

**功能要求**:
1. 支持 `{varName}` 格式的变量
2. 支持数字格式化
3. 支持安全转义（防注入）

**实现示例**:
```typescript
// src/system/i18n-system/interpolator.ts

export function interpolate(
  text: string, 
  vars: Record<string, string | number>
): string {
  return text.replace(/\{(\w+)\}/g, (match, key) => {
    const value = vars[key];
    if (value === undefined) {
      return match;
    }
    // 转义 HTML 特殊字符，防止 XSS
    return escapeHtml(String(value));
  });
}

function escapeHtml(str: string): string {
  return str
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}
```

---

#### 任务2.4.6：实现语言切换

**功能要求**:
1. 支持运行时语言切换
2. 语言切换时清理缓存
3. 通知监听者语言变化

---

#### 任务2.4.7：创建基础词汇表

**功能要求**:
1. 创建 i18n/core.yaml 核心词汇
2. 创建 i18n/ui.yaml UI 词汇
3. 包含常用词汇的5语言翻译

---

#### 任务2.4.8：整合并测试

**验收标准**:
- [ ] 翻译功能正常
- [ ] 变量插值正确
- [ ] 语言切换正常
- [ ] 测试覆盖率 ≥ 80%

---

## 四、验收标准

### 功能验收
- [ ] 四个模块全部实现
- [ ] 所有接口符合设计文档
- [ ] 模块间依赖正确

### 代码质量
- [ ] 测试覆盖率 ≥ 80%
- [ ] 代码通过 ESLint 检查
- [ ] TypeScript 编译无错误

### 文档验收
- [ ] 每个模块有 README
- [ ] 接口有 JSDoc 注释
- [ ] 使用示例完整

---

## 五、完成标志

当以下条件都满足时，阶段2完成：

1. ✅ DataSerializer 模块完成并测试通过
2. ✅ LogSystem 模块完成并测试通过
3. ✅ ConfigManager 模块完成并测试通过
4. ✅ I18nSystem 模块完成并测试通过
5. ✅ 模块间集成测试通过
6. ✅ 所有测试覆盖率 ≥ 80%
7. ✅ 代码提交到 Git 仓库

---

**文档版本**: 1.0.0  
**最后更新**: 2026-02-01
