# Chromium内核封装 - 需求文档

## 模块定位

Chromium内核封装是公共基础层的核心运行环境之一,为整个薯片生态提供网页渲染能力。薯片生态中的所有界面都基于网页技术实现,Chromium内核负责将HTML、CSS、JavaScript转换为用户可见的图形界面。

这个模块不是简单地集成Chromium,而是对Chromium进行了深度封装,使其符合薯片生态的架构要求。它通过微内核的路由系统对外提供服务,支持多窗口渲染,处理网页安全沙箱,管理资源加载。

## 功能需求

### 网页渲染引擎

提供完整的网页渲染能力,支持最新的HTML5标准。能够解析HTML文档结构,渲染CSS样式,执行JavaScript代码。支持现代网页特性,包括Flexbox布局、Grid布局、CSS变量、动画和过渡效果。

渲染引擎需要高性能,页面加载要快速流畅。对于静态内容要能够缓存渲染结果,避免重复计算。对于动态内容要能够高效更新,只重绘变化的部分。

### 多窗口管理

支持同时渲染多个独立的网页窗口。每个窗口有独立的渲染上下文,窗口之间不会相互影响。当用户打开多张卡片时,每张卡片在独立的网页窗口中渲染,它们可以显示不同的内容,使用不同的主题。

窗口的创建要快速,切换要流畅。窗口可以隐藏或显示,隐藏的窗口暂停渲染以节省资源。窗口可以独立刷新,不影响其他窗口。

### 安全沙箱

提供网页安全沙箱机制,隔离不受信任的网页内容。当卡片嵌入外部网页时,这些网页运行在沙箱中,不能访问本地文件系统,不能读取用户数据,不能与父窗口通信。

沙箱提供多个安全级别,内部可信内容运行在宽松模式,外部不可信内容运行在严格模式。沙箱规则可以配置,根据内容来源选择合适的安全策略。

### 资源加载

处理网页资源的加载,包括HTML文档、CSS样式表、JavaScript脚本、图片、字体等。支持本地资源和网络资源的加载。对于本地资源,通过文件路径加载。对于网络资源,通过HTTP协议下载。

资源加载要支持缓存,已下载的资源缓存到本地,下次直接从缓存读取。支持资源预加载,提前加载即将使用的资源。支持懒加载,延迟加载暂时不需要的资源。

### 开发者工具

集成开发者工具,方便调试网页内容。开发者可以查看DOM结构,检查CSS样式,调试JavaScript代码。可以查看网络请求,分析页面性能,监控内存使用。

开发者工具可以通过快捷键或菜单打开。在生产模式下,开发者工具默认禁用,只有开发模式才启用。

### 版本管理

管理Chromium版本,保持与上游的同步更新。定期更新到最新的稳定版本,获取安全补丁和性能优化。支持版本锁定,确保生态的稳定性。

提供版本信息查询接口,上层可以获取当前使用的Chromium版本号,判断是否支持特定的网页特性。

## 接口需求

### 窗口创建接口

提供创建网页渲染窗口的接口。调用时传入窗口配置,包括初始URL、窗口大小、安全级别等参数。接口返回窗口标识,后续操作通过这个标识引用窗口。

### 内容加载接口

提供加载网页内容的接口。可以加载HTML文档,也可以直接加载HTML字符串。支持设置基础URL,用于解析相对路径。

### 窗口控制接口

提供控制窗口的接口,包括显示、隐藏、刷新、关闭窗口。可以获取窗口的渲染状态,判断窗口是否已加载完成。

### 通信桥接口

提供JavaScript与原生代码的通信接口。网页中的JavaScript可以调用原生功能,原生代码可以执行网页中的JavaScript。通信要通过微内核路由,确保安全性。

### 事件监听接口

提供监听网页事件的接口。可以监听页面加载完成事件、导航事件、错误事件等。当事件触发时,通过回调通知调用方。

## 非功能需求

### 性能要求

页面加载要快速,首屏渲染时间控制在一秒以内。页面滚动要流畅,帧率保持在60fps。内存占用要合理,长时间运行不能出现内存泄漏。

### 稳定性要求

渲染引擎要稳定运行,不能崩溃。即使某个窗口的内容有问题,也只影响那个窗口,不影响其他窗口和整个软件。

### 兼容性要求

支持各种网页内容,兼容标准的HTML、CSS、JavaScript代码。对于非标准代码,尽可能容错处理。

### 安全性要求

严格执行安全沙箱规则,防止恶意网页攻击。防止跨站脚本攻击,防止跨域访问,防止内容注入。
