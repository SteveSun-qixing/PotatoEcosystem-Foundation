# 富文本渲染器 - 需求文档

## 模块定位

富文本渲染器是公共基础层的文本处理组件,为整个生态提供格式化文本的显示能力。富文本卡片、帖子卡片等需要显示带格式文本的场景通过这个模块实现。它将富文本格式转换为可视化的HTML显示,支持加粗、斜体、标题、列表、颜色等各种格式。

这个模块封装了富文本的解析和渲染逻辑,对外提供简洁的接口。插件开发者只需要传入富文本内容和显示参数,就能在界面中显示格式化的文本,保持原有的格式和样式。

富文本渲染器通过微内核的路由系统对外提供服务,支持多实例,可以同时渲染多段富文本内容。每个渲染器实例独立工作,有自己的渲染上下文和配置。

## 功能需求

### 格式支持

支持常见的文本格式,包括加粗、斜体、下划线、删除线。支持文本颜色和背景色,用户可以设置任意颜色。支持字体大小调整,从小号到大号多个级别。支持字体类型选择,包括系统字体和网页字体。

支持段落格式,包括左对齐、居中对齐、右对齐、两端对齐。支持行距调整,紧密、正常、宽松等预设,或自定义行距值。支持段落缩进,首行缩进和悬挂缩进。

支持标题格式,从一级标题到六级标题,不同级别有不同的大小和样式。标题自动编号,根据层级生成编号。

支持列表,包括无序列表、有序列表、任务列表。列表可以嵌套,支持多级列表。列表项可以有不同的标记样式,比如实心圆点、空心圆点、数字、字母等。

### 链接和图片

支持超链接,文本可以包含链接,点击跳转到目标URL。链接样式可以自定义,包括颜色、下划线、悬停效果等。支持链接预览,悬停在链接上显示目标地址或预览内容。

支持图片嵌入,富文本中可以插入图片。图片可以是本地文件或网络URL。图片尺寸可以调整,支持等比缩放或自定义宽高。图片位置可以是行内、居中、左浮动、右浮动。

图片要延迟加载,只加载可见区域的图片,提高性能。图片加载失败显示占位符,提示用户图片不可用。

### 表格

支持表格,富文本可以包含表格元素。表格有表头、表体、表尾,单元格可以合并。单元格支持文本格式,包括加粗、居中等。

表格样式可以自定义,包括边框、背景色、间距等。表格可以有斑马条纹,交替行不同颜色,方便阅读。

表格响应式布局,小屏幕上表格自动缩放或横向滚动,保证内容可见。

### 引用和代码

支持引用块,引用他人的文字或重要的提示信息。引用块有特殊样式,比如左侧竖线、背景色、斜体等,与正文区分。

支持行内代码,用特殊样式显示代码关键字或命令。代码使用等宽字体,有背景色突出显示。

支持代码块,显示多行代码。代码块不支持语法高亮,语法高亮由代码高亮器模块提供。代码块只负责显示纯文本代码,保持缩进和换行。

### 分割线和空白

支持分割线,在内容之间插入水平线,分隔不同部分。分割线样式可以选择,实线、虚线、点线等。

支持空白控制,保留段落之间的空白,保留段落内的换行。支持不换行空格,多个空格显示为多个空格,不合并。

### 特殊符号

支持特殊符号和表情符号。特殊符号包括数学符号、货币符号、箭头符号等。表情符号使用Unicode Emoji,显示彩色表情图标。

支持上标和下标,用于数学公式、化学式、脚注等。上标显示在基线上方,下标显示在基线下方,字体缩小。

### 样式主题

渲染器支持样式主题,不同主题有不同的颜色和字体方案。主题通过CSS变量定义,可以快速切换主题而不修改内容。

默认主题适合大多数场景,还可以提供暗色主题、高对比度主题等。用户可以自定义主题,调整颜色、字体、间距等样式参数。

### 选择和复制

渲染的文本支持选择,用户可以用鼠标选中文本。选中的文本高亮显示,可以复制到剪贴板。复制时保留格式信息,粘贴到其他富文本编辑器时格式不丢失。

支持全选,快捷键全选所有文本。支持取消选择,点击空白区域取消选择。

### 性能优化

渲染要高效,大段文本快速渲染,不阻塞界面。使用虚拟滚动,只渲染可见区域的内容,超出视口的内容不渲染,滚动时动态渲染。

渲染结果缓存,相同内容不重复渲染,从缓存读取。格式变化时局部更新,只更新变化的部分,不重新渲染整个文本。

## 接口需求

### 渲染器创建接口

提供创建渲染器实例的接口,传入容器元素和初始配置。配置包括主题、是否只读、是否显示行号等。返回渲染器实例标识。

### 渲染内容接口

提供渲染富文本内容的接口,传入富文本数据。数据格式可以是HTML、富文本JSON、或自定义格式。渲染器解析数据,生成HTML,显示在容器中。

### 更新内容接口

提供更新内容的接口,传入新的富文本数据。渲染器对比新旧内容,只更新变化的部分,提高性能。

### 样式控制接口

提供设置主题的接口,切换不同的样式主题。提供调整字体大小、行距等样式参数的接口。

### 选择接口

提供获取选中文本的接口,返回选中的文本内容和格式信息。提供设置选择范围的接口,程序化选中指定范围的文本。

### 事件监听接口

提供监听事件的接口,事件包括点击链接、点击图片、选择变化等。

### 销毁接口

提供销毁渲染器实例的接口,清理DOM元素,释放资源。

## 非功能需求

### 性能要求

渲染要快速,小段文本立即显示,大段文本渐进渲染。滚动要流畅,虚拟滚动保证性能。内存占用要合理,不会因为渲染大量文本导致内存溢出。

### 显示质量要求

文本显示要清晰,字体渲染平滑。格式还原要准确,加粗就是加粗,颜色就是指定的颜色。布局要正确,段落对齐、列表缩进都要符合预期。

### 兼容性要求

支持各种富文本格式,兼容常见的富文本编辑器输出。在不同浏览器和平台上显示一致。

### 用户体验要求

文本可读性要好,字体大小适中,行距舒适,颜色对比清晰。链接和图片交互自然,点击有反馈。选择操作流畅,复制粘贴方便。
