# 公共基础层 - 卡片渲染模块需求

## 模块定位

卡片渲染模块是公共基础层的核心功能之一，提供完整的卡片和箱子渲染能力。任何使用 SDK 的开发者都可以在自己的产品中实现卡片的查看、交互和使用。

## CardRenderer（卡片渲染引擎）

卡片渲染引擎负责解析和渲染 .card 文件的完整流程。

**功能需求**：

解析卡片文件时，使用 ZIPProcessor 模块读取压缩包内容，读取 .card/metadata.yaml 获取卡片元数据，读取 .card/structure.yaml 获取卡片结构和基础卡片列表，读取 content/ 目录下每个基础卡片的配置文件。

渲染卡片时，根据 structure.yaml 中的顺序，逐个渲染基础卡片。对于每个基础卡片：
1. 根据类型（type 字段）选择对应的 BaseCardRenderer
2. BaseCardRenderer 调用基础卡片插件的前端代码（HTML结构、JS交互逻辑）
3. 将配置数据（从 content/ID.yaml 读取）填充到前端模板
4. 生成完整的 HTML 网页
5. 创建 iframe 窗口并加载该网页
6. 设置 iframe 背景为透明，使其与整体卡片窗口融为一体

每个基础卡片渲染为一个独立的 iframe 窗口。最后，将所有基础卡片的 iframe 垂直排列，添加菜单栏（显示卡片名称和操作按钮），应用卡片级主题作为整体背景网页，组合成一个完整的大 iframe 窗口交付给调用方。

处理嵌套卡片时，如果基础卡片本身是一个嵌套的复合卡片，递归调用卡片渲染引擎，渲染嵌套卡片的内容。

应用主题时，读取卡片级别和组件级别的主题配置，调用主题引擎（ThemeEngine）加载对应主题包，将主题样式应用到各个组件。

**接口需求**：

提供 renderCard 接口，接收卡片文件路径或卡片数据对象，返回渲染结果（DOM 元素或网页框架组件）。

提供 parseCard 接口，只解析卡片结构不渲染，返回卡片的元数据和结构信息。

提供配置选项，包括是否应用主题、是否启用交互、渲染质量等。

## BaseCardRenderers（基础卡片渲染器）

包含所有 26 种基础卡片的渲染器，每个渲染器负责一种卡片类型。

**通用渲染器接口**：

每个渲染器都实现统一的接口，接收配置对象（从 content/ID.yaml 解析得到），接收主题配置（可选），返回渲染结果（网页内容或 DOM 元素）。

**具体渲染器需求**：

每个 BaseCardRenderer 负责调用对应的基础卡片插件的前端代码。基础卡片插件包含：
- **渲染组件**（前端代码）：定义该卡片如何显示，包括 HTML 结构、CSS 样式接口点、JavaScript 交互逻辑
- **编辑组件**：在编辑引擎中使用，用于设置卡片参数

渲染流程示例：
- **富文本卡片渲染器**：调用富文本卡片插件的前端代码，将配置中的文本内容、格式样式填充到 HTML 模板，生成富文本显示网页
- **视频卡片渲染器**：调用视频卡片插件的前端代码（包含视频播放器界面），将配置中的视频路径、封面、字幕等数据传入，生成视频播放器网页。插件内部调用 VideoPlayer 模块获得底层播放能力
- **图片卡片渲染器**：调用图片卡片插件的前端代码，传入图片路径和显示参数，生成图片查看器网页

每个渲染器都处理资源路径的解析，相对路径转换为绝对路径，外部资源路径验证可用性，网络资源通过 HTTPClient 或 CacheManager 获取。

**主题应用**：

每个渲染器支持主题注入，从主题包中提取对应组件的样式代码，应用到渲染结果上。如果组件配置指定了主题，使用指定主题。如果没有指定，使用上级主题或系统默认主题。

## BoxRenderer（箱子渲染引擎）

箱子渲染引擎负责解析和渲染 .box 文件。

**功能需求**：

解析箱子文件时，使用 ZIPProcessor 读取，读取 .box/metadata.yaml 获取箱子元数据，读取 .box/structure.yaml 获取卡片列表，读取 .box/content.yaml 获取布局配置。

对于卡片列表中的每个卡片，判断卡片是在箱子内部还是外部引用。内部卡片从箱子根目录读取，外部卡片根据路径或 URL 获取。

渲染箱子时：
1. 根据布局配置中的布局类型（layout_type 字段）选择布局插件
2. 布局插件包含完整的前端代码（HTML、CSS、JavaScript），定义该布局如何排列和展示卡片
3. 将卡片列表和布局配置数据传递给布局插件
4. 布局插件调用其前端代码，生成展示网页
5. 每个卡片显示为卡片项（封面图或摘要信息）
6. 创建 iframe 窗口并加载该展示网页
7. 用户点击某个卡片项时，触发事件，调用 CardRenderer 渲染完整卡片

**布局插件协议**：

定义布局插件的标准接口，布局插件接收卡片列表和布局配置，返回渲染结果。箱子渲染引擎负责加载布局插件，调用插件接口，显示渲染结果。

## ThemeEngine（主题引擎）

主题引擎负责主题包的管理和应用。

**功能需求**：

加载主题包时，解析主题包的结构，读取主题配置和样式文件，注册主题包到主题注册表。

应用主题时，根据主题标识（"发行商：主题名"）查找主题包，根据组件类型提取对应的样式代码，将样式注入到组件的渲染结果。

处理主题层级时，从组件主题、卡片主题、应用主题、全局主题依次查找，使用最高优先级的主题。如果某层级没有设置主题（配置为空），自动使用上一层级主题。

**主题缓存**：

主题引擎维护主题缓存，已加载的主题包保存在内存中，避免重复加载。主题包更新时，清理缓存重新加载。

---

## 完整渲染流程示例

### 场景：渲染一个包含视频和富文本的复合卡片

1. **CardRenderer 接收渲染请求**
   - 输入：卡片 ID 或卡片文件路径
   - 目标容器 ID

2. **解析卡片文件**
   - 使用 ZIPProcessor 读取 .card 文件
   - 解析 metadata.yaml（卡片名称、作者等）
   - 解析 structure.yaml（基础卡片列表：[视频卡片, 富文本卡片]）
   - 读取 content/ 目录下的配置文件

3. **渲染基础卡片 - 视频卡片**
   - CardRenderer 调用视频卡片的 BaseCardRenderer
   - BaseCardRenderer 读取 content/video-001.yaml 配置文件（视频路径、封面、字幕等）
   - 调用视频卡片插件的前端代码
   - 插件生成 HTML 网页：
     ```html
     <div class="video-card">
       <video-player video-src="video.mp4" poster="cover.jpg">
         <subtitle src="subtitle.srt" lang="zh-CN">
       </video-player>
     </div>
     ```
   - 创建 iframe 窗口，加载该网页
   - 返回 iframe 元素

4. **渲染基础卡片 - 富文本卡片**
   - CardRenderer 调用富文本卡片的 BaseCardRenderer
   - BaseCardRenderer 读取 content/text-001.yaml 配置文件（文本内容、格式）
   - 调用富文本卡片插件的前端代码
   - 插件生成 HTML 网页：
     ```html
     <div class="richtext-card">
       <h2>标题</h2>
       <p>段落内容...</p>
     </div>
     ```
   - 创建 iframe 窗口，加载该网页
   - 返回 iframe 元素

5. **组合所有 iframe**
   - 将视频卡片的 iframe 和富文本卡片的 iframe 垂直排列
   - 创建菜单栏（显示卡片名称、操作按钮）
   - 应用卡片级主题（ThemeEngine）作为整体背景网页

6. **生成最终的大 iframe**
   - 将菜单栏、所有基础卡片 iframe、主题背景组合到一个大网页中
   - 创建最终的 iframe 窗口并加载该大网页
   - 返回这个大 iframe 给调用方（Viewer、Editor 等）

7. **调用方显示**
   - 将接收到的大 iframe 嵌入到界面中
   - 用户看到完整的卡片，可以观看视频、阅读文本

---

## 关键设计点

### 1. 基础卡片插件的前端代码

每个基础卡片插件包含完整的前端实现：
- **HTML 结构**：定义卡片的界面结构
- **CSS 接口点**：暴露样式类名和变量，供主题注入
- **JavaScript 逻辑**：实现交互功能（播放控制、滚动、点击等）

示例 - 视频卡片插件的前端代码：
```javascript
// 视频卡片插件的渲染组件
class VideoCardRenderer {
  render(config, container) {
    // 创建 HTML 结构
    const html = `
      <div class="video-card">
        <video-player 
          src="${config.videoPath}" 
          poster="${config.posterPath}"
          controls="true">
        </video-player>
        <div class="video-info">
          <h3>${config.title}</h3>
          <p>${config.description}</p>
        </div>
      </div>
    `;
    
    container.innerHTML = html;
    
    // 添加交互逻辑
    this.setupVideoPlayer(container, config);
  }
  
  setupVideoPlayer(container, config) {
    // 初始化视频播放器（调用 VideoPlayer 模块）
    // 添加字幕、播放控制等功能
  }
}
```

### 2. iframe 的作用

- **每个基础卡片一个 iframe**：确保样式和脚本的隔离
- **iframe 背景透明**：与整体卡片窗口融为一体
- **最终交付一个大 iframe**：包含所有内容，方便嵌入任何产品

### 3. 主题系统的集成

- 基础卡片插件的前端代码**不包含样式**，只定义结构和逻辑
- 样式通过 CSS 类名和变量暴露接口点
- ThemeEngine 根据主题配置注入样式到各个 iframe
- 支持原子级主题配置（组件级、卡片级、应用级、全局级）

---

这四个模块（CardRenderer、BaseCardRenderers、BoxRenderer、ThemeEngine）共同构成公共基础层的卡片渲染能力，让任何开发者通过 SDK 都可以在自己的产品中实现卡片的完整渲染和交互。
