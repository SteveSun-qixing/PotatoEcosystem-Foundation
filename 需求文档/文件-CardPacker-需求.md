# 卡片打包器 - 需求文档

## 模块定位

卡片打包器是公共基础层的文件处理组件，负责卡片文件夹与 .card 文件之间的转换。薯片生态中的卡片文件本质是零压缩的 ZIP 压缩包，编辑引擎在工作区中以解压后的文件夹形式存储卡片，编辑完成后通过打包器将文件夹打包成标准的 .card 文件，供查看器和其他软件使用。

打包器建立在 ZIP 处理器之上，专注于卡片格式的业务逻辑。它理解卡片的目录结构规范，知道 .card 配置文件夹、content 文件夹、资源文件应该如何组织，能够验证卡片结构的正确性，确保生成的文件符合薯片生态的卡片格式标准。

## 功能需求

支持将卡片文件夹打包为 .card 文件。打包时遍历文件夹的所有内容，按照卡片格式规范组织目录结构，使用零压缩模式创建 ZIP 文件，将扩展名改为 .card。打包过程中自动验证文件夹结构，确保 .card 配置文件夹和必需的配置文件都存在。

支持将 .card 文件解包为文件夹。解包时将 .card 文件作为 ZIP 文件解压到指定目录，解压后的文件夹结构与打包前完全一致。解包完成后验证目录结构是否符合卡片格式规范，为编辑引擎提供可直接读写的文件夹。

支持验证卡片结构的完整性。验证功能检查卡片是否包含必需的文件和目录，包括 .card 配置文件夹、metadata.yaml 元数据文件、structure.yaml 结构文件、cover.html 封面文件、content 内容文件夹。还会验证配置文件的格式是否正确，资源引用是否有效。验证功能可用于打包前检查文件夹，也可用于解包后检查 .card 文件。

支持在不完全解包的情况下读取卡片元数据。元数据读取功能直接从 .card 文件中提取 metadata.yaml 的内容，解析后返回卡片的基本信息，包括名称、创建时间、主题配置、标签、文件统计等。这让应用可以快速获取卡片信息用于文件列表显示或预览，无需解压整个卡片。

## 接口需求

提供打包接口，接收卡片文件夹路径和输出 .card 文件路径。接口遍历文件夹，验证结构，创建零压缩 ZIP，输出 .card 文件。打包失败时返回详细的错误信息，说明哪个验证步骤未通过。

提供解包接口，接收 .card 文件路径和输出目录路径。接口解压 .card 文件到指定目录，验证解压后的结构，返回解包结果。解包失败时返回错误信息。

提供验证接口，接收卡片文件夹路径或 .card 文件路径。接口检查卡片结构的完整性，返回验证结果和详细的检查报告。报告包含每个检查项的通过状态和失败原因。

提供元数据读取接口，接收 .card 文件路径。接口从 ZIP 中直接读取 metadata.yaml，解析后返回元数据对象。读取失败时返回错误信息。

## 非功能需求

打包和解包要快速，使用零压缩模式减少 CPU 开销，使用流式处理避免内存压力。支持大卡片文件，能处理包含大量资源的卡片。验证过程要全面但高效，避免重复读取文件。元数据读取要轻量，不加载整个 .card 文件到内存。错误信息要清晰准确，帮助用户定位问题。
