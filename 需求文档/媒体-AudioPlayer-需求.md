# 音频播放器 - 需求文档

## 模块定位

音频播放器是公共基础层的核心媒体组件,为整个生态提供音频播放能力。音乐卡片等需要播放音频的场景通过这个模块实现。它是一个可以被其他模块调用的播放组件,而不是独立的音乐播放应用。

这个模块封装了音频解码、播放控制、音频可视化等功能,对外提供统一简洁的接口。插件开发者只需要传入音频文件路径和配置参数,就能在界面中显示音频播放器,包括播放控制、进度显示、音频波形等元素。

音频播放器通过微内核的路由系统对外提供服务,支持多实例,可以同时播放多个音频或管理播放队列。每个播放器实例独立工作,有自己的播放状态和控制接口。

## 功能需求

### 音频格式支持

支持常见的音频格式,包括MP3、WAV、FLAC、AAC、OGG、M4A等。支持不同的比特率和采样率,从低质量的语音录音到高保真的无损音频。

对于不支持的格式,给出明确的错误提示,告诉用户哪种格式不支持,建议转换格式。不能静默失败,也不能导致播放器崩溃。

### 播放控制

提供完整的播放控制功能。支持播放和暂停,点击播放按钮开始播放,再次点击暂停。支持停止,停止后回到音频开头。支持快进和快退,可以跳转到音频的任意位置。

支持上一曲和下一曲,当有播放列表时,可以切换到列表中的其他音频。支持随机播放,从列表中随机选择音频播放。支持循环模式,包括单曲循环、列表循环、顺序播放。

支持播放速度调节,可以慢速或快速播放。常用速度有0.5倍、0.75倍、1倍、1.25倍、1.5倍、2倍。对于有声书或播客,变速播放很有用。

### 音量控制

提供音量调节功能,用户可以调整播放音量。音量范围从0到100,0是静音,100是最大音量。支持静音切换,快速静音或取消静音。

提供音量平衡控制,调节左右声道的音量比例。支持音频效果,包括均衡器、混响、立体声增强等。

音量设置要持久化保存,记住用户的偏好,下次打开时恢复。

### 歌词显示

支持加载和显示歌词。歌词格式支持LRC等常见格式。歌词可以嵌入在音频文件的标签中,也可以是外部歌词文件。

歌词与音频同步显示,当前播放的歌词高亮显示,其他歌词显示为普通样式。支持歌词滚动,当前歌词始终保持在视图中央或顶部。

歌词样式可以自定义,包括字体大小、颜色、对齐方式等。支持翻译歌词,同时显示原文和译文。

点击歌词可以跳转到对应位置播放,方便用户定位到想听的部分。

### 音频可视化

提供音频波形可视化,根据音频数据实时绘制波形图或频谱图。波形图显示音频的振幅随时间的变化,频谱图显示不同频率的能量分布。

可视化样式可以选择,包括条形图、波形图、圆形谱图等不同风格。颜色和动画效果可以自定义,配合主题系统。

可视化要流畅,帧率保持在30fps以上。不能因为绘制可视化影响音频播放的流畅性。

### 播放列表

支持播放列表管理,可以添加多个音频到列表,按顺序播放。可以调整列表中音频的顺序,删除音频,清空列表。

播放列表要持久化保存,应用关闭后列表仍然保留。支持多个播放列表,用户可以创建不同的列表,比如收藏列表、最近播放列表等。

从列表中选择音频时,立即开始播放。播放完当前音频自动播放列表中的下一个。

### 音频信息显示

显示音频的元数据信息,包括标题、艺术家、专辑、时长、比特率、采样率等。信息从音频文件的ID3标签或其他元数据标签读取。

显示专辑封面,如果音频文件包含封面图片,提取并显示。如果没有封面,显示默认图片或占位符。

显示当前播放进度,包括已播放时长和总时长。进度条直观显示播放位置,用户可以拖动进度条跳转。

### 播放模式

支持多种播放模式。顺序播放按列表顺序播放所有音频,播放完最后一个停止。列表循环播放完所有音频后从头开始。单曲循环重复播放当前音频。随机播放从列表中随机选择音频播放。

播放模式可以随时切换,切换后立即生效。当前播放的音频不中断,但下一曲的选择按新模式执行。

### 后台播放

支持后台播放,应用最小化或切换到其他界面时,音频继续播放。系统通知区域显示播放信息和控制按钮,用户可以在通知区域控制播放。

支持媒体键控制,键盘或耳机上的播放暂停、上一曲、下一曲按键可以控制播放器。

### 音频输出设备

支持选择音频输出设备,当有多个音频输出设备时,用户可以选择通过哪个设备播放。比如内置扬声器、外接音响、蓝牙耳机等。

输出设备变化时,自动切换或提示用户。比如插入耳机时,询问是否切换到耳机播放。

## 接口需求

### 播放器创建接口

提供创建播放器实例的接口,传入容器元素和初始配置。配置包括音频源、是否自动播放、初始音量、是否显示可视化等。返回播放器实例标识。

### 播放控制接口

提供播放、暂停、停止、上一曲、下一曲、跳转到指定位置、调整播放速度等控制接口。

### 音量控制接口

提供设置音量、静音、取消静音、调整音效等接口。

### 歌词控制接口

提供加载歌词、显示隐藏歌词、设置歌词样式等接口。

### 播放列表接口

提供添加音频到列表、移除音频、清空列表、调整顺序、切换播放模式等接口。

### 状态查询接口

提供查询播放状态、当前播放位置、音量、播放模式等信息的接口。

### 事件监听接口

提供监听播放器事件的接口。事件包括播放开始、播放暂停、播放结束、切换歌曲、进度变化、错误发生等。

### 销毁接口

提供销毁播放器实例的接口,释放资源,清理内存。

## 非功能需求

### 性能要求

音频加载要快速,点击播放后立即开始播放,延迟不超过500毫秒。播放要流畅,不能有杂音或断断续续。快进快退要响应迅速。

CPU和内存占用要合理,播放音频是轻量操作,不能占用过多资源。音频可视化要高效,绘制不影响播放性能。

### 音质要求

音频解码要保证音质,不能有明显失真。对于无损音频,完整保留音质细节。支持高采样率和高比特率的音频。

### 兼容性要求

在不同平台上保持一致的功能和体验。支持各种常见音频格式,满足用户的使用需求。

### 用户体验要求

界面要简洁直观,控制元素清晰易用。响应要及时,操作立即有反馈。歌词显示要准确同步,可视化效果要美观流畅。
