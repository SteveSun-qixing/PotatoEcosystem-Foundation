# Electron框架 - 需求文档

## 模块定位

Electron框架是薯片生态的桌面应用封装层,让基于网页技术的应用可以打包成独立的桌面软件。它提供了网页应用和操作系统之间的桥梁,使网页可以访问文件系统、调用系统API、集成系统功能。

薯片生态本质上是网页应用,但需要作为桌面软件分发和运行。Electron框架让这成为可能,它将Chromium内核、Node.js运行时、系统集成能力打包在一起,形成完整的桌面应用环境。

这个模块不是直接使用原生Electron,而是对其进行封装适配,使其符合薯片生态的架构规范。所有对Electron功能的访问都通过微内核路由,所有系统能力都以服务形式提供。

## 功能需求

### 应用程序生命周期管理

管理桌面应用的完整生命周期,从启动到退出的整个过程。应用启动时初始化运行环境,加载配置,创建主窗口。应用运行时处理各种事件,包括窗口事件、系统事件、用户输入。应用退出时保存状态,清理资源,优雅关闭。

支持应用的多种启动方式。可以通过桌面图标启动,可以通过命令行启动并传递参数,可以通过文件关联启动并打开指定文件。启动时可以携带参数,应用根据参数执行不同的初始化流程。

应用退出要考虑数据安全。如果有未保存的修改,提示用户保存。如果有正在进行的任务,等待任务完成或询问用户是否取消。支持强制退出,但要记录日志便于排查问题。

### 原生窗口管理

提供原生窗口的创建和管理能力。每个原生窗口是操作系统级别的窗口,有标题栏、边框、最小化最大化关闭按钮。窗口可以设置大小、位置、是否可调整大小、是否总在最前。

支持无边框窗口,完全自定义窗口外观。支持透明窗口,实现不规则形状的窗口。支持窗口阴影和毛玻璃效果,让界面更加美观。

窗口要支持记忆功能。应用关闭时记录窗口的位置和大小,下次启动时恢复到之前的状态。支持多显示器,窗口可以在不同显示器之间移动,正确处理不同显示器的缩放比例。

### 文件系统访问

提供访问本地文件系统的能力。可以读取文件内容,写入文件,创建和删除文件,创建和删除目录。可以遍历目录,列出目录中的文件。可以监听文件变化,当文件被修改时收到通知。

文件操作要处理各种平台差异。不同操作系统的路径分隔符不同,文件权限机制不同。封装要屏蔽这些差异,提供统一的接口。

支持文件对话框,弹出系统原生的文件选择对话框。用户可以选择文件或目录,可以设置文件类型过滤器。支持保存对话框,让用户选择保存位置。

### 系统集成

集成系统的各种功能。可以访问系统托盘,在托盘中显示图标和菜单。可以发送系统通知,在屏幕角落弹出消息提示。可以注册全局快捷键,即使应用不在前台也能响应快捷键。

可以注册文件关联,将特定文件类型绑定到应用。用户双击.card文件时,自动用薯片软件打开。可以注册URL协议,通过chips://协议打开应用。

可以与系统剪贴板交互,读取剪贴板内容,写入内容到剪贴板。支持多种数据类型,包括文本、图片、文件路径。

### 原生菜单

提供原生菜单的创建和管理。可以创建应用菜单栏,macOS系统中显示在屏幕顶部,Windows和Linux显示在窗口顶部。可以创建上下文菜单,右键点击时弹出。

菜单项支持文本、图标、快捷键、分隔符。菜单项可以是可点击的命令,也可以是包含子菜单的分组。菜单项可以有选中状态,可以禁用和启用。

菜单要支持动态更新。根据应用状态动态调整菜单项,比如文件已保存时"保存"按钮变灰。支持菜单的国际化,根据系统语言显示对应文本。

### 进程通信

提供主进程和渲染进程之间的通信机制。主进程是Node.js环境,可以访问文件系统和系统API。渲染进程是网页环境,运行网页代码。两个进程需要通信来协同工作。

通信采用异步消息传递,避免阻塞。渲染进程向主进程发送请求,主进程处理后返回结果。主进程可以主动向渲染进程发送消息,通知渲染进程更新界面。

通信要通过微内核路由,不允许渲染进程直接调用主进程功能。这确保了安全性和统一的权限管理。

### 自动更新

支持应用的自动更新机制。定期检查更新服务器,查询是否有新版本。如果有新版本,下载更新包,验证完整性和签名。

下载完成后提示用户安装更新。可以选择立即安装,也可以下次启动时安装。安装过程要保证数据安全,更新失败能够回滚到旧版本。

支持增量更新,只下载变化的部分,减少下载量。支持后台更新,不影响用户使用。

## 接口需求

### 窗口操作接口

提供创建窗口、关闭窗口、显示窗口、隐藏窗口、最小化窗口、最大化窗口等操作接口。提供设置窗口标题、图标、大小、位置的接口。

### 文件操作接口

提供读取文件、写入文件、删除文件、创建目录、列出目录等文件系统操作接口。提供打开文件对话框、保存文件对话框的接口。

### 系统功能接口

提供访问系统托盘、发送系统通知、注册全局快捷键、操作剪贴板等系统功能接口。

### 菜单管理接口

提供创建菜单、更新菜单、移除菜单的接口。提供菜单项点击事件的监听接口。

### 应用控制接口

提供退出应用、重启应用、获取应用信息、设置应用配置的接口。

## 非功能需求

### 跨平台要求

支持Windows、macOS、Linux三大桌面平台。在不同平台上保持功能一致,接口统一。自动处理平台差异,上层模块不需要针对不同平台编写代码。

### 性能要求

应用启动要快速,桌面软件的启动时间控制在三秒以内。文件操作要高效,读写大文件不阻塞界面。进程通信延迟要低,确保界面响应流畅。

### 稳定性要求

应用要稳定运行,不能出现崩溃。即使某个功能出错,也不影响整个应用。关键操作要有重试机制,网络请求失败能够自动重试。

### 安全性要求

文件操作要验证权限,不能访问未授权的文件。系统功能的调用要经过权限检查,防止恶意代码滥用系统资源。
