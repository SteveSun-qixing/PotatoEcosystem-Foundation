# 3D模型渲染器 - 需求文档

## 模块定位

3D模型渲染器是公共基础层的媒体组件,为整个生态提供三维模型的显示和交互能力。3D模型卡片等需要展示三维内容的场景通过这个模块实现。它是一个可以被其他模块调用的渲染组件,而不是独立的3D建模或查看应用。

这个模块封装了3D模型加载、渲染、光照、材质、相机控制等功能,对外提供简洁统一的接口。插件开发者只需要传入模型文件路径和渲染参数,就能在界面中显示三维模型,并提供用户友好的交互操作。

3D模型渲染器通过微内核的路由系统对外提供服务,支持多实例,可以同时渲染多个模型。每个渲染器实例独立工作,有自己的渲染上下文、场景和相机。

## 功能需求

### 模型格式支持

支持常见的3D模型格式,包括GLTF、GLB、OBJ、FBX、STL、DAE等。GLTF是推荐格式,支持完整的场景、材质、动画、骨骼等信息。OBJ格式简单通用,STL格式用于3D打印模型。

对于不支持的格式,给出明确的错误提示,告诉用户哪种格式不支持,建议转换格式或使用其他工具。

支持带纹理的模型,纹理图片与模型文件分离或嵌入在模型文件中。支持多材质模型,不同部分使用不同材质。

### 3D渲染

使用WebGL渲染三维模型,利用GPU加速提高渲染性能。渲染要流畅,帧率保持在30fps以上,复杂模型也能顺畅显示。

支持基础的光照模型,包括环境光、平行光、点光源、聚光灯。光照让模型有立体感,材质在不同光照下呈现不同效果。

支持阴影渲染,模型投射阴影到地面或其他物体,增加真实感。阴影可以开启或关闭,根据性能需求调整。

支持透明材质,模型的半透明部分正确渲染,透过模型可以看到背后的内容。透明度由材质的alpha通道或不透明度属性控制。

### 相机控制

提供灵活的相机控制,用户可以从不同角度查看模型。支持轨道控制,相机围绕模型旋转,始终朝向模型中心。鼠标拖动旋转视角,滚轮缩放距离,右键拖动平移。

支持多种投影模式。透视投影模拟人眼视觉,近大远小,有景深效果。正交投影没有透视畸变,常用于工程图。

支持相机预设,提供前视图、侧视图、顶视图等预设角度,点击按钮快速切换到预设角度。

相机状态可以保存和恢复,记住用户的查看角度,下次打开恢复到上次的视角。

### 模型交互

支持模型的选择和高亮,点击模型的某个部分,该部分高亮显示,可以查看该部分的信息或执行操作。

支持模型的测量,测量模型的尺寸、距离、角度等。在模型上选择两点,显示两点之间的距离。

支持模型的剖切,使用剖切平面切开模型,查看内部结构。剖切平面可以移动和旋转,从不同角度剖切。

### 材质和纹理

正确渲染模型的材质,包括基础颜色、金属度、粗糙度、法线贴图、AO贴图等PBR材质属性。材质让模型看起来像金属、塑料、木头等不同质感。

纹理贴图要正确映射到模型表面,纹理不扭曲不错位。支持多层纹理,基础颜色纹理、法线纹理、金属粗糙度纹理等叠加使用。

材质可以动态调整,运行时修改材质参数,实时预览效果。比如调整颜色、改变金属度、增加粗糙度等。

### 动画播放

支持模型动画播放,如果模型包含动画数据,可以播放动画。动画包括骨骼动画、变形动画、路径动画等。

提供动画控制,播放、暂停、停止动画。调整播放速度,慢速或快速播放。循环播放或播放一次后停止。

动画进度可以拖动,跳转到动画的任意位置。显示动画信息,包括动画名称、时长、当前进度等。

如果模型包含多个动画,可以切换播放不同动画。比如角色模型包含走路动画、跑步动画、跳跃动画等。

### 环境和背景

支持设置渲染环境,包括背景颜色、背景图片、环境贴图。环境贴图影响模型的反射和环境光,让模型融入环境。

支持天空盒,使用全景图作为背景,营造场景氛围。天空盒可以是静态图片或动态的天空效果。

支持地面网格,显示参考网格帮助理解模型的尺寸和位置。网格可以显示或隐藏,网格线的颜色和间距可以调整。

### 渲染质量

提供多种渲染质量设置,适应不同性能需求。高质量模式开启所有特效,包括阴影、反射、抗锯齿。低质量模式关闭部分特效,提高帧率。

支持抗锯齿,消除模型边缘的锯齿,让边缘平滑。使用FXAA、SMAA等抗锯齿算法。

支持环境光遮蔽,增加模型凹陷处的阴影,提升立体感和真实感。

### 截图和导出

支持截图功能,将当前渲染画面保存为图片。图片格式支持PNG、JPEG。截图尺寸可以自定义,支持高分辨率截图。

支持导出模型,将当前场景或模型导出为标准格式。导出时保留材质和纹理信息。

### 性能监控

显示渲染性能信息,包括当前帧率、渲染时间、多边形数量等。帮助用户了解性能状况,调整渲染质量。

提供性能统计,记录平均帧率、最低帧率、最高帧率。识别性能瓶颈,给出优化建议。

## 接口需求

### 渲染器创建接口

提供创建渲染器实例的接口,传入容器元素和初始配置。配置包括模型源、渲染质量、是否显示控制按钮等。返回渲染器实例标识。

### 加载模型接口

提供加载模型的接口,传入模型文件路径。支持加载单个模型或场景文件。

### 相机控制接口

提供设置相机位置、旋转、缩放的接口。提供切换投影模式、应用预设视角的接口。

### 渲染控制接口

提供设置渲染质量、开启关闭阴影、调整光照等接口。提供暂停和恢复渲染的接口。

### 动画控制接口

提供播放、暂停、停止动画的接口。提供调整播放速度、跳转到指定时间的接口。

### 材质控制接口

提供修改材质参数的接口,调整颜色、金属度、粗糙度等属性。

### 交互接口

提供选择模型部分、测量距离、剖切模型等交互功能的接口。

### 状态查询接口

提供查询渲染状态、相机状态、动画状态等信息的接口。

### 事件监听接口

提供监听渲染器事件的接口。事件包括模型加载完成、加载失败、相机变化、动画播放完成等。

### 销毁接口

提供销毁渲染器实例的接口,释放资源,清理内存。

## 非功能需求

### 性能要求

模型加载要快速,小模型立即显示,大模型渐进加载。渲染要流畅,帧率保持在30fps以上,复杂场景也能顺畅交互。

相机控制要响应迅速,拖动旋转跟手性好,延迟低。缩放平移要平滑,没有卡顿。

内存占用要合理,渲染大模型不会占用过多内存。不再查看的模型及时清理,避免内存泄漏。

### 渲染质量要求

模型显示要清晰,边缘平滑无锯齿。材质渲染要真实,光照效果自然。纹理要清晰,不模糊不失真。

阴影要柔和,不要有明显的锯齿边缘。透明物体的渲染要正确,透明度准确,不出现渲染错误。

### 兼容性要求

支持各种常见3D模型格式,满足用户的使用需求。在不同平台上保持一致的功能和体验。支持不同性能的设备,自动调整渲染质量。

### 用户体验要求

界面要简洁直观,控制元素清晰易用。操作要自然,符合3D查看的惯例。错误提示要友好,帮助用户解决问题。
