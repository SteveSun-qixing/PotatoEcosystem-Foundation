# HTTP客户端 - 技术文档

## 架构设计

HTTP客户端基于Fetch API或Axios库构建。Fetch是浏览器原生API,兼容性好,但功能有限。Axios是流行的HTTP库,功能丰富,支持拦截器、取消等高级特性。

客户端维护请求队列,管理所有进行中的请求。每个请求有唯一标识,可以通过标识取消请求。队列有并发限制,超过限制的请求等待。

拦截器使用责任链模式,请求经过所有请求拦截器处理,响应经过所有响应拦截器处理。拦截器可以修改请求参数,可以转换响应数据,可以统一处理错误。

## 接口定义

请求接口接收配置对象,配置包括URL、方法、头部、请求体、超时等参数。接口创建请求,添加到队列,发送请求,返回Promise。Promise resolve响应对象或reject错误对象。

取消接口接收请求标识或取消token,查找对应请求,调用abort方法取消。取消后Promise被reject,错误类型是取消错误。

拦截器接口接收拦截器函数,添加到拦截器链。请求拦截器接收请求配置,返回修改后的配置。响应拦截器接收响应对象,返回处理后的数据。

## 使用方式

插件需要访问网络API时,通过微内核调用HTTP客户端。传入API地址和参数,客户端发送请求,返回响应数据。

请求拦截器添加认证信息,从本地存储读取token,添加到请求头。响应拦截器处理错误,统一处理401未授权、500服务器错误等状态码。

## 技术细节

使用AbortController取消请求,创建AbortController,将signal传给fetch或axios,调用abort方法取消。

超时使用竞态Promise实现,创建超时Promise和请求Promise,使用Promise.race,哪个先完成使用哪个结果。超时Promise在指定时间后reject超时错误。

重试使用递归实现,请求失败时检查重试次数,如果还有重试机会,延迟后重新发送请求。指数退避策略,每次重试延迟加倍。
