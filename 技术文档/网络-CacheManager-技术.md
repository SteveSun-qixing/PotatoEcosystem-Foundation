# 缓存管理器 - 技术文档

## 架构设计

缓存管理器使用浏览器的Cache API或IndexedDB存储缓存数据。Cache API是专门用于网络资源缓存的API,与Service Worker配合使用。IndexedDB是通用的客户端数据库,可以存储任意数据。

缓存策略使用多层缓存,内存缓存和持久化缓存。内存缓存速度快但容量小,持久化缓存容量大但速度慢。资源首先查找内存缓存,未命中查找持久化缓存,再未命中从网络加载。

缓存键使用URL的哈希值,避免URL过长或包含特殊字符。缓存元数据包括过期时间、ETag、大小等信息,与缓存数据一起存储。

LRU策略使用双向链表和哈希表实现。链表按访问时间排序,最近访问的在头部,最久未访问的在尾部。哈希表快速查找节点。访问缓存时移动节点到头部,清理时从尾部删除。

## 接口定义

缓存接口接收URL、资源数据和缓存选项,缓存选项包括过期时间、优先级等。接口将资源存储到缓存,更新元数据,更新LRU链表。

读取接口接收URL,首先查找内存缓存,命中直接返回。未命中查找持久化缓存,找到加载到内存缓存并返回。都未命中返回null。

清理接口清空缓存,删除所有缓存项,重置统计信息。也可以指定URL,只删除对应的缓存。

## 使用方式

图片加载时,先查询缓存管理器是否有缓存。有缓存直接使用,无缓存从网络加载,加载完成后存入缓存。

视频播放时,查询视频文件缓存,有缓存直接播放,无缓存下载并缓存。视频分块缓存,只缓存已播放的部分。

## 技术细节

Cache API使用,调用caches.open打开缓存,调用cache.put存储资源,调用cache.match查找资源,调用cache.delete删除资源。

IndexedDB使用,创建对象存储,使用URL作为键存储资源。使用事务保证操作原子性。使用游标遍历存储,统计大小或清理过期项。

缓存验证使用条件请求,发送If-None-Match头包含ETag,或If-Modified-Since头包含时间戳。服务器验证后返回304 Not Modified表示未修改,或200 OK返回新资源。
