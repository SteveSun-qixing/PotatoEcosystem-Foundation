# 下载管理器 - 技术文档

## 架构设计

下载管理器使用任务队列管理下载任务。每个任务包含URL、保存路径、状态、进度等信息。任务状态包括等待、下载中、暂停、完成、失败。

下载使用流式处理,响应数据以流的方式读取,边下载边写入文件,不需要一次性加载整个文件到内存。使用ReadableStream和WritableStream API实现流式下载。

断点续传使用HTTP Range请求,请求时指定Range头,从指定位置开始下载。服务器返回206 Partial Content响应,包含请求范围的数据。

任务队列有并发限制,同时下载的任务数量有上限。超过限制的任务进入等待状态,等待队列中有空位时开始下载。

## 接口定义

创建任务接口接收URL和保存路径,创建下载任务,添加到队列,返回任务ID。如果队列未满,立即开始下载,否则进入等待状态。

控制接口接收任务ID和操作类型,执行对应操作。暂停停止下载,保存当前进度。恢复从上次进度继续下载。取消删除任务和临时文件。重试重新开始下载。

查询接口接收任务ID,返回任务状态对象,包含状态、已下载大小、总大小、速度、剩余时间等信息。

## 使用方式

用户下载资源时,插件调用下载管理器创建下载任务。管理器在后台下载,定期触发进度事件通知插件,插件更新界面显示进度。

下载完成后,管理器触发完成事件,插件显示下载完成提示,提供打开文件或打开目录的选项。

## 技术细节

断点续传实现,下载前检查本地是否有临时文件,如果有读取文件大小作为已下载大小。发送Range请求,Range头设置为`bytes=已下载大小-`,请求剩余部分。

下载速度计算,记录上次统计时间和已下载大小,当前时间和大小与上次比较,计算增量除以时间差,得到速度。剩余时间用剩余大小除以当前速度估算。

文件写入使用文件流,打开文件流,响应数据到达时写入流,下载完成关闭流。使用追加模式,断点续传时不覆盖已有数据,从文件末尾追加新数据。
