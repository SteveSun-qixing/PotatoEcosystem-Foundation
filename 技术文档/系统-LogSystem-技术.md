# 日志系统 - 技术文档

## 架构设计

日志系统使用分层架构,包括日志器、处理器、格式化器。日志器接收日志记录请求,创建日志对象。处理器决定如何处理日志,输出到哪里。格式化器格式化日志为字符串。

日志器按模块组织,每个模块有自己的日志器。日志器有名称和级别,名称通常是模块路径。日志器继承父日志器的配置,形成层级结构。

处理器有多种类型,ConsoleHandler输出到控制台,FileHandler输出到文件,RemoteHandler发送到远程服务器。一个日志器可以有多个处理器,日志同时输出到多个目标。

格式化器将日志对象格式化为字符串,包含时间戳、级别、模块、消息、上下文。支持自定义格式,使用模板定义输出格式。

## 接口定义

记录日志接口接收级别、消息、上下文数据,创建日志对象,传递给所有处理器。级别低于日志器级别的日志被过滤,不记录。

配置接口设置全局配置或日志器配置,包括级别、处理器列表、格式等。配置持久化保存,应用启动时加载。

查询接口接收查询条件,包括时间范围、级别、模块、关键字。查询日志文件或日志数据库,返回匹配的日志记录。

## 使用方式

模块记录日志时,获取模块的日志器,调用debug、info、warn、error方法。传入消息和上下文数据,日志系统自动添加时间戳、模块名等信息。

开发模式设置日志级别为Debug,输出所有日志到控制台。生产模式设置级别为Info或Warn,只输出重要日志,日志写入文件。

错误发生时记录Error级别日志,包含错误堆栈和上下文信息。日志分析工具解析日志文件,统计错误频率,识别问题模式。

## 技术细节

异步日志使用队列缓冲日志,后台线程或定时器批量写入。记录日志时只添加到队列,立即返回,不阻塞。写入使用文件流,追加模式写入日志文件。

日志轮转监控文件大小,超过限制关闭当前文件,重命名为备份文件,创建新文件继续写入。备份文件名包含时间戳,如app.log.2026-01-31。

压缩使用gzip压缩旧日志,压缩后删除原文件。定期清理过期日志,只保留最近一段时间的日志。

远程日志使用HTTP POST发送日志到日志服务器,日志格式为JSON。批量发送减少请求次数,本地缓存失败的日志,网络恢复后重试。
