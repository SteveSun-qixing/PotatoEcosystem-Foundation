# 富文本渲染器 - 技术文档

## 架构设计

### 整体架构

富文本渲染器基于成熟的富文本库构建,使用Quill、ProseMirror或类似的库作为底层实现。在其之上封装符合薯片生态规范的接口层。

架构分为三层。底层是富文本引擎层,负责富文本的解析和渲染。中间是渲染控制层,管理渲染过程、性能优化、样式主题。上层是服务接口层,通过微内核路由对外提供服务。

渲染器支持多实例,实例管理器负责创建、跟踪、销毁渲染器实例。每个实例有独立的渲染上下文、文档模型、DOM容器。

### 文档模型

富文本使用文档模型表示,文档由节点树组成。节点类型包括段落、文本、标题、列表、图片等。每个节点有类型、属性、子节点。

文本节点包含文本内容和格式标记。格式标记是标记数组,每个标记有类型和属性,比如加粗标记、颜色标记等。标记应用到文本范围,多个标记可以叠加。

文档模型与显示分离,模型是抽象的数据结构,渲染器将模型转换为DOM显示。模型变化时,渲染器更新DOM,保持同步。

### 渲染引擎

渲染引擎将文档模型转换为HTML DOM。遍历文档节点树,为每个节点创建对应的DOM元素。段落节点创建p元素,标题节点创建h1-h6元素,文本节点创建text节点。

格式标记转换为CSS样式或HTML标签。加粗标记使用strong标签或font-weight样式。颜色标记使用color样式。链接标记使用a标签。

渲染使用增量更新,文档变化时不重新渲染整个文档,只更新变化的节点。对比新旧文档树,找出差异,只更新差异部分的DOM。

### 样式系统

样式使用CSS变量定义,变量包括字体、颜色、间距等参数。主题是CSS变量的集合,切换主题更新变量值,样式自动应用。

渲染器生成的HTML使用语义化的class,不包含行内样式。所有样式通过外部CSS定义,便于主题定制。

支持自定义样式,用户可以注入自定义CSS,覆盖默认样式。自定义样式在主题样式之后加载,优先级更高。

## 接口定义

### 创建渲染器

创建渲染器接口接收容器元素和配置对象。容器元素是HTML元素,渲染器渲染在这个容器中。配置对象包含主题标识、是否只读、是否显示行号等参数。

接口创建渲染器实例,初始化文档模型,渲染到容器,返回实例标识符。创建是同步的,立即返回实例标识。

### 渲染内容

渲染内容接口接收富文本数据,数据格式可以是HTML字符串、富文本JSON、Delta格式等。解析数据为文档模型,渲染到容器。

渲染是异步的,解析和渲染在后台执行。渲染完成后触发完成事件,通知调用方。

### 更新内容

更新内容接口接收新的富文本数据,对比新旧数据,计算差异,增量更新文档模型和DOM。更新比完全重新渲染快得多。

### 样式控制

设置主题接口接收主题标识,加载主题的CSS变量,应用到渲染器。主题切换时,所有样式自动更新,不需要重新渲染。

调整样式参数接口接收参数对象,包括字体大小、行距等。更新对应的CSS变量,样式立即生效。

### 事件监听

事件监听接口接收事件名称和回调函数,将回调注册到事件列表。支持的事件包括点击链接、点击图片、选择变化、渲染完成等。

事件通过微内核的事件总线分发,订阅者通过事件总线接收事件。

### 销毁渲染器

销毁接口清理渲染器资源,移除DOM元素,清理事件监听,释放文档模型。从实例管理器中移除记录。

## 使用方式

### 创建和渲染

富文本卡片插件需要显示富文本时,通过微内核向富文本渲染器模块发送创建请求。请求包含容器元素的标识和渲染器配置。

渲染器模块创建渲染器实例,返回实例标识。然后插件发送渲染内容请求,传入富文本数据。渲染器解析数据,渲染到容器。

### 样式主题

插件可以设置渲染器的主题,匹配卡片的整体风格。发送设置主题请求,渲染器加载主题样式,文本显示更新。

用户切换应用主题时,插件同步更新渲染器主题,保持一致的视觉体验。

### 交互处理

用户点击富文本中的链接时,渲染器触发点击链接事件。插件监听事件,获取链接URL,决定如何处理,比如在新窗口打开或在当前窗口跳转。

用户选择文本时,渲染器触发选择变化事件。插件可以监听事件,实现复制按钮或其他功能。

### 清理资源

卡片关闭时,插件发送销毁渲染器请求。渲染器清理资源,移除DOM,释放内存。

## 技术细节

### 虚拟滚动

大段文本使用虚拟滚动优化性能。只渲染可见区域的内容,视口外的内容不渲染。滚动时,动态加载进入视口的内容,卸载离开视口的内容。

虚拟滚动维护滚动位置和可见范围,计算应该渲染的节点范围。创建占位元素撑开滚动高度,在可见位置渲染实际内容。

### 增量更新

增量更新使用差异算法,对比新旧文档树,找出变化的节点。变化类型包括插入、删除、移动、更新属性。

根据变化类型执行相应的DOM操作。插入创建新元素,删除移除元素,移动调整元素位置,更新修改属性或样式。

差异算法要高效,避免不必要的DOM操作。使用启发式算法,快速识别变化,减少比较次数。

### 性能优化

使用DocumentFragment批量更新DOM。创建DocumentFragment,在其中构建DOM结构,一次性插入到文档。这减少重排和重绘次数。

使用requestAnimationFrame驱动渲染,保证渲染与屏幕刷新同步。只在需要更新时渲染,内容没有变化不重新渲染。

延迟加载图片和其他资源,使用Intersection Observer API检测元素是否进入视口,进入时才加载资源。
