# 视频播放器 - 技术文档

## 架构设计

### 整体架构

视频播放器基于成熟的开源视频库构建,不从零实现复杂的视频解码和渲染。使用video.js或类似的库作为底层实现,在其之上封装符合薯片生态规范的接口层。

分为四个主要层次。最底层是视频解码层,使用浏览器原生的视频解码能力或软解码库。解码层之上是播放器核心层,提供播放控制、状态管理等核心功能。核心层之上是界面层,渲染播放器的控制界面。最上层是服务接口层,通过微内核路由对外提供服务。

播放器支持多实例,每个实例独立管理自己的状态。实例管理器负责创建、跟踪、销毁播放器实例。实例通过唯一标识符区分,所有操作都基于实例标识符。

### 解码策略

优先使用硬件解码,充分利用GPU的视频解码能力,减少CPU占用,提高解码效率。检测设备是否支持硬件解码,支持则使用硬件解码,不支持则回退到软件解码。

使用浏览器原生的video元素,利用浏览器内置的解码器。浏览器已经实现了主流视频格式的解码,不需要自己实现。对于浏览器不支持的格式,使用JavaScript实现的软解码库,如Broadway.js或FFmpeg.js。

解码器要处理各种异常情况。视频文件损坏时,尝试跳过损坏部分继续播放。解码失败时,给出明确的错误信息。

### 播放器核心

播放器核心维护播放状态机。状态包括未加载、加载中、已加载、播放中、暂停、停止、错误等。状态之间的转换有明确的规则,只能按照规定的路径转换。

核心管理播放时间轴,跟踪当前播放位置。提供精确的进度控制,支持跳转到任意位置。使用requestAnimationFrame定时更新进度,确保进度显示平滑。

核心实现缓冲管理,预先缓冲一段视频数据,避免播放中断。当网络速度慢时,降低清晰度保证流畅播放。当缓冲不足时,暂停播放等待缓冲。

### 界面渲染

播放器界面使用HTML和CSS实现,覆盖在video元素之上。界面包括控制条、播放按钮、进度条、音量控制、全屏按钮等元素。

界面支持自定义主题,通过CSS变量定义颜色、字体、尺寸等样式。主题切换时,更新CSS变量值,界面自动应用新样式。

界面元素支持自适应布局,根据播放器容器的大小调整元素位置和尺寸。小尺寸时隐藏次要控制,只显示核心功能。

控制条支持自动隐藏,播放时几秒后自动隐藏,鼠标移动时重新显示。暂停时始终显示控制条。

### 字幕渲染

字幕解析器读取字幕文件,解析字幕内容和时间戳。支持SRT、VTT等常见格式。解析后的字幕存储为时间轴结构,方便查找指定时间的字幕。

字幕渲染器在video元素上方叠加字幕文本。使用HTML元素显示字幕,支持富文本格式。字幕样式通过CSS控制,包括字体、颜色、背景、位置等。

字幕同步机制确保字幕与视频保持同步。根据当前播放时间,查找应该显示的字幕。播放位置变化时,实时更新字幕显示。

## 接口定义

### 创建播放器

创建播放器接口接收容器元素和配置对象。容器元素是HTML元素,播放器渲染在这个容器中。配置对象包含视频源URL、是否自动播放、初始音量、是否显示控制条等参数。

接口创建播放器实例,分配唯一标识符,初始化播放器状态,渲染界面,返回实例标识符。创建是异步的,返回Promise,播放器就绪后Promise resolve。

### 加载视频

加载视频接口接收视频源URL或文件路径,解析为实际的资源位置。通过资源管理系统获取视频数据,传递给video元素加载。

支持加载本地文件和网络视频。本地文件通过文件协议加载,网络视频通过HTTP协议加载。加载过程显示加载动画,加载完成后显示第一帧画面。

### 播放和暂停

播放接口调用video元素的play方法,开始播放视频。暂停接口调用pause方法,暂停播放。接口是异步的,操作完成后Promise resolve。

播放失败时,Promise被拒绝,包含错误信息。常见的失败原因包括视频未加载、格式不支持、解码错误等。

### 跳转播放位置

跳转接口接收目标时间,以秒为单位。设置video元素的currentTime属性,跳转到目标位置。跳转后触发seeked事件,通知订阅者。

跳转要处理边界情况。目标时间小于零时,跳转到开头。目标时间大于总时长时,跳转到结尾。

### 音量控制

音量设置接口接收音量值,范围0到1。设置video元素的volume属性。静音接口设置muted属性为true,取消静音设置为false。

音量变化时触发volumechange事件。音量值持久化保存,下次打开播放器时恢复。

### 播放速度

播放速度接口接收速度倍数,范围0.25到4。设置video元素的playbackRate属性。速度变化立即生效,音频自动变调保持正常音调。

### 字幕操作

加载字幕接口接收字幕文件URL,下载并解析字幕文件。解析完成后,将字幕轨道添加到播放器。

切换字幕接口接收字幕轨道标识,切换到指定字幕。显示或隐藏字幕接口控制字幕的可见性。

设置字幕样式接口接收样式对象,包含字体大小、颜色、背景色等属性。更新CSS变量,应用新样式。

### 全屏控制

进入全屏接口调用元素的requestFullscreen方法,退出全屏调用exitFullscreen方法。全屏状态变化时触发fullscreenchange事件。

全屏要处理不同浏览器的API差异。不同浏览器的全屏API有不同的前缀,封装统一的接口屏蔽差异。

### 事件订阅

事件订阅接口接收事件名称和回调函数,将回调注册到事件列表。支持的事件包括播放开始、播放暂停、播放结束、时间更新、音量变化、错误发生等。

事件通过微内核的事件总线分发,订阅者通过事件总线接收事件。事件对象包含事件类型、播放器标识、时间戳、相关数据等信息。

### 销毁播放器

销毁接口停止播放,移除界面元素,清理事件监听,释放资源。从实例管理器中移除实例记录。销毁后播放器实例不再可用,尝试操作会报错。

## 使用方式

### 创建和初始化

视频卡片插件需要播放视频时,通过微内核向视频播放器模块发送创建请求。请求包含容器元素的标识和播放器配置。

播放器模块创建播放器实例,渲染到指定容器中。返回播放器实例标识,插件保存这个标识,后续操作使用这个标识。

### 加载和播放

创建播放器后,发送加载视频请求,传入视频文件路径。播放器通过资源管理系统获取视频,加载到video元素。加载完成后,如果配置了自动播放,自动开始播放,否则显示播放按钮等待用户点击。

用户点击播放按钮时,插件发送播放请求。播放器开始播放视频,触发播放开始事件。插件可以监听这个事件,执行相关逻辑。

### 控制播放

用户与播放器交互时,比如点击暂停按钮、拖动进度条、调节音量,事件传递到插件。插件发送相应的控制请求到播放器,播放器执行操作并更新界面。

播放器状态变化时,触发事件通知插件。插件根据状态变化更新自己的界面,比如显示播放中或已暂停的提示。

### 字幕和多音轨

视频包含字幕时,插件在创建播放器时传入字幕配置。播放器加载并显示字幕,字幕与视频同步显示。

用户切换字幕或音轨时,插件发送切换请求。播放器切换到指定的字幕或音轨,继续播放。

### 进度记忆

播放器定期触发进度更新事件,插件监听事件,将进度保存到卡片的配置文件中。下次打开卡片时,插件从配置读取进度,在创建播放器时设置初始播放位置。播放器跳转到该位置,用户从上次停止的地方继续观看。

### 清理资源

卡片关闭时,插件发送销毁播放器请求。播放器停止播放,清理资源,移除界面元素。释放内存,确保不会因为播放器实例未销毁导致内存泄漏。

## 技术细节

### 硬件加速

检测设备是否支持硬件加速视频解码。查询浏览器支持的视频编解码器,检查是否有硬件加速标记。如果支持,设置video元素使用硬件解码。

硬件解码大幅降低CPU占用,提高解码效率。特别是高清视频,软件解码可能导致卡顿,硬件解码流畅播放。

### 自适应码率

对于网络视频,实现自适应码率切换。检测网络速度和缓冲状态,动态选择合适的清晰度。网络好时选择高清晰度,网络差时降低清晰度保证流畅。

使用HLS或DASH协议实现自适应码率。视频源提供多个清晰度版本,播放器根据条件选择版本。切换清晰度时尽可能平滑,避免明显的画质跳变。

### 缓冲策略

实现智能缓冲策略,预先加载足够的视频数据。缓冲区太小容易卡顿,太大浪费内存和带宽。根据网络速度动态调整缓冲区大小。

缓冲不足时,暂停播放显示缓冲动画。缓冲充足后自动恢复播放。跳转到新位置时,清空缓冲区,重新缓冲新位置的数据。

### 错误恢复

捕获解码错误、网络错误、格式错误等各种错误。记录错误日志,显示友好的错误提示。尝试自动恢复,比如网络错误时重试加载。

无法恢复的错误,停止播放,显示错误界面,告诉用户发生了什么问题。提供刷新或重新加载的选项。

### 性能监控

监控播放器的性能指标,包括解码帧率、丢帧数、缓冲时间、内存占用等。性能异常时记录日志,帮助排查问题。

提供性能调优选项,用户可以根据设备性能调整播放器设置。低端设备降低清晰度,关闭部分特效,确保流畅播放。
