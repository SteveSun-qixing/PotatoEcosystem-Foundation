# 拖拽系统 - 技术文档

## 架构设计

拖拽系统使用HTML5 Drag and Drop API,监听dragstart、drag、dragover、drop等事件。封装API提供更友好的接口,简化拖拽实现。

系统维护拖动上下文,记录拖动的数据、源元素、当前目标等信息。拖动开始时创建上下文,拖动结束时清理上下文。

拖拽预览使用DataTransfer的setDragImage方法,设置自定义预览元素。预览元素可以是任意DOM元素,系统自动渲染为半透明预览。

放置目标注册表记录所有目标元素和验证函数。拖动到元素上时,查找注册表,调用验证函数判断是否可以放置。可以放置显示高亮,不可以显示禁止光标。

## 接口定义

注册拖动源接口接收元素和配置,配置包括拖动数据、拖动效果、预览元素等。接口设置元素的draggable属性为true,监听dragstart事件,事件中设置拖动数据和预览。

注册放置目标接口接收元素和验证函数,将元素添加到目标注册表。监听dragover事件,事件中调用验证函数,可以放置调用preventDefault允许放置,不可以放置不调用,浏览器显示禁止光标。

拖拽事件监听接口注册全局拖拽事件回调,事件包括拖动开始、拖动结束、成功放置、取消拖动。事件对象包含拖动数据、源元素、目标元素等信息。

## 使用方式

卡片编辑引擎标记基础卡片为可拖动,用户拖动卡片时,设置卡片数据为拖动数据。拖动到另一个位置时,插件判断是否可以放置,可以放置显示插入标记,放置后插入卡片。

文件管理器拖动文件到卡片窗口,判断文件类型,创建对应的基础卡片。拖动视频文件创建视频卡片,拖动图片文件创建图片卡片。

## 技术细节

拖动数据使用DataTransfer对象,调用setData设置数据,getData读取数据。数据类型是MIME类型,如text/plain、text/html、application/json等。

跨窗口拖拽使用postMessage通信,拖动数据通过消息传递。源窗口发送拖动开始消息,目标窗口接收消息,验证后发送允许放置消息。放置后发送放置消息,源窗口处理放置逻辑。

触摸拖拽使用Touch事件,监听touchstart长按判断开始拖动,touchmove移动预览元素,touchend判断放置位置,触发放置事件。
