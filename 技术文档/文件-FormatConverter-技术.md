# 格式转换器 - 技术文档

## 架构设计

格式转换器针对不同类型的转换使用不同的策略。图片转换使用Canvas API,加载图片到Canvas,调整参数,导出为目标格式。文本编码转换使用TextEncoder和TextDecoder API。

音视频转换使用WebCodecs API或FFmpeg.wasm。WebCodecs利用硬件加速,性能好但兼容性有限。FFmpeg.wasm是FFmpeg的WebAssembly版本,兼容性好但性能稍差。

转换任务使用队列管理,支持并发转换多个文件。任务有优先级,高优先级任务先执行。任务可以暂停和恢复,可以取消。

## 接口定义

转换接口接收源文件、目标格式和转换参数,创建转换任务,添加到任务队列。任务开始时触发开始事件,转换过程中定期触发进度事件,完成时触发完成事件。

查询进度接口根据任务ID返回当前进度,进度是0到100的百分比。取消接口停止指定任务,清理资源,触发取消事件。

## 使用方式

用户上传不支持格式的图片时,插件调用格式转换器转换为支持的格式。转换完成后,使用转换后的文件创建卡片。

视频卡片需要生成缩略图时,调用格式转换器从视频提取帧,转换为图片,作为封面使用。

## 技术细节

图片转换使用Canvas的toDataURL或toBlob方法,导出指定格式的图片。调整质量参数控制压缩率,调整尺寸使用Canvas的drawImage缩放。

音视频转换使用FFmpeg命令行,通过FFmpeg.wasm执行。构建FFmpeg命令,传入输入文件和输出参数,FFmpeg处理转换,输出转换后的文件。

使用Web Worker执行转换,避免阻塞主线程。转换是CPU密集型操作,在Worker中执行,主线程保持响应。转换完成后,Worker将结果传回主线程。
