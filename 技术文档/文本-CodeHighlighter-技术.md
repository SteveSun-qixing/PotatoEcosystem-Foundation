# 代码高亮器 - 技术文档

## 架构设计

代码高亮器基于成熟的高亮库构建,使用highlight.js、Prism或Shiki等库作为底层实现。这些库包含数百种语言的语法定义,支持多种高亮主题。

高亮过程包括词法分析和着色两个阶段。词法分析识别代码中的关键字、标识符、字符串、注释等语法元素。着色为每个元素添加CSS class,通过主题样式表显示颜色。

支持Web Worker高亮,将高亮计算移到Worker线程,避免阻塞主线程。对于大段代码,Worker后台处理,完成后将结果返回主线程显示。

## 接口定义

高亮接口接收代码文本、语言标识和配置选项,返回高亮后的HTML或class标记。语言标识用于选择语法规则,配置选项包括是否显示行号、高亮特定行等。

主题接口加载指定主题的CSS样式表,应用到高亮代码。主题是CSS文件,定义不同语法元素的颜色。

## 使用方式

代码块卡片插件需要高亮代码时,通过微内核向代码高亮器发送高亮请求。传入代码和语言,接收高亮HTML,渲染到界面。

Markdown解析器解析代码块时,调用代码高亮器处理代码内容,将高亮结果嵌入Markdown渲染的HTML中。

## 技术细节

使用语法树解析提高准确性,不只是简单的正则匹配,而是构建语法树,准确识别语法元素。

使用虚拟滚动处理大文件,只高亮可见区域的代码,滚动时动态高亮新出现的代码。使用增量高亮,代码变化时只重新高亮变化的行。
