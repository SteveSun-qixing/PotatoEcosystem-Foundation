# 配置管理器 - 技术文档

## 架构设计

配置管理器维护多个配置层,每层是配置对象。配置层按优先级排序,从低到高是默认、系统、用户、运行时。读取配置时,从高优先级层开始查找,找到就返回,找不到查找下一层。

配置使用嵌套对象表示,支持任意深度的层级结构。配置路径映射到对象属性路径,如"window.size.width"映射到config.window.size.width。

监听器注册表记录所有监听器,键是配置路径,值是回调函数数组。配置变化时,查找注册表,调用所有相关的回调函数。

持久化使用文件存储,用户配置保存为JSON或YAML文件。配置变化时延迟写入,避免频繁IO。应用退出时强制写入,确保不丢失。

## 接口定义

读取配置接口接收路径字符串,split路径为数组,遍历配置层查找。找到返回值,找不到返回默认值或undefined。

写入配置接口接收路径和值,解析路径,定位到目标对象和属性。设置属性值,触发变更事件,通知监听器。标记配置已修改,延迟持久化。

监听接口接收路径和回调,将回调添加到监听器注册表。返回取消监听函数,调用取消函数移除监听器。

## 使用方式

模块初始化时读取配置,获取需要的配置项。配置项不存在使用默认值,保证模块正常工作。

用户修改设置时,写入配置到用户配置层。配置立即生效,监听器收到通知,更新界面或行为。

模块需要响应配置变化时,注册监听器。配置改变时,监听器回调被调用,模块执行相应逻辑。

## 技术细节

配置查找使用reduce遍历路径,从根对象开始,逐级访问属性。如路径"a.b.c",reduce从config开始,访问config.a,再访问config.a.b,最后访问config.a.b.c。

深度监听使用Proxy代理配置对象,拦截属性访问和设置。设置属性时触发set陷阱,检查路径是否有监听器,调用回调。嵌套对象递归代理,监听深层属性变化。

延迟写入使用防抖,配置变化后不立即写入,等待一段时间,期间再变化重新计时。超时后批量写入所有变化的配置,减少IO次数。

配置迁移使用版本号,配置文件包含版本号,加载时检查版本。版本低于当前版本,执行迁移脚本,更新配置结构,更新版本号,保存配置。
