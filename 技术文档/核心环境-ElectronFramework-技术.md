# Electron框架 - 技术文档

## 架构设计

### 整体架构

Electron框架封装采用三层架构。底层是原生Electron框架,提供基础的桌面应用能力。中间是封装适配层,将Electron的接口转换为薯片生态的标准接口,并与微内核集成。上层是服务接口层,通过微内核路由对外提供各种桌面能力。

主进程是应用的核心,负责窗口管理、系统集成、文件操作等。渲染进程运行网页内容,负责界面显示和用户交互。主进程和渲染进程通过IPC进程间通信机制交互,但这个通信要经过微内核路由,不是直接通信。

### 进程模型

采用主进程加多个渲染进程的模型。主进程只有一个,在应用启动时创建,负责应用的整体控制。每个窗口对应一个渲染进程,窗口之间互相隔离。

主进程是特权进程,可以访问所有Node.js API和系统功能。渲染进程是受限进程,只能访问经过授权的功能。渲染进程要使用系统功能时,向主进程发送请求,主进程验证权限后执行操作。

进程崩溃恢复机制确保稳定性。如果渲染进程崩溃,主进程检测到后可以重启该窗口。如果主进程崩溃,整个应用退出,但会记录崩溃日志,下次启动时尝试恢复状态。

### 窗口管理

窗口管理器维护所有窗口的生命周期。创建窗口时分配窗口ID,初始化窗口配置,创建对应的渲染进程。窗口配置包括尺寸、位置、是否可调整大小、是否有边框等。

窗口状态持久化,应用关闭时保存所有窗口的位置和大小。下次启动时从配置文件读取,恢复窗口到之前的状态。支持多显示器,记录窗口所在的显示器,下次启动时如果该显示器仍然连接,窗口恢复到该显示器。

无边框窗口通过设置窗口属性实现。窗口没有系统标题栏,完全由网页内容控制外观。需要在网页中实现拖动区域,让用户可以拖动窗口。实现自定义的最小化最大化关闭按钮。

### 文件系统桥接

文件系统桥接将Node.js的fs模块封装为服务接口。所有文件操作都通过微内核路由,不允许渲染进程直接使用fs模块。这样可以统一管理文件访问权限,记录文件操作日志,处理错误和异常。

文件路径统一使用绝对路径,屏蔽平台差异。Windows使用反斜杠,Unix使用正斜杠,封装层统一转换。文件权限在不同平台的表示不同,封装层提供统一的权限模型。

文件监听使用原生的文件系统监听API。当文件或目录发生变化时,触发事件通知。监听要高效,避免轮询方式,使用操作系统提供的事件通知机制。

## 接口定义

### 窗口创建

窗口创建接口接收窗口配置,返回窗口ID。配置包括窗口宽度高度、最小和最大尺寸、是否可调整、是否有边框、是否透明、背景色等。

创建窗口是异步操作,立即返回窗口ID,实际创建在后台完成。可以监听窗口就绪事件,确认窗口已经创建并加载完成。

### 窗口控制

窗口控制接口通过窗口ID操作窗口。可以显示隐藏窗口,最小化最大化还原窗口,关闭窗口,设置窗口焦点。可以移动窗口到指定位置,调整窗口大小,设置窗口置顶。

所有操作都是异步的,通过Promise返回操作结果。如果操作失败,Promise被拒绝,包含错误信息。

### 文件读写

文件读取接口传入文件路径,返回文件内容。支持读取文本文件和二进制文件。对于文本文件,可以指定编码格式。对于二进制文件,返回Buffer对象。

文件写入接口传入路径和内容,将内容写入文件。如果文件不存在,创建新文件。如果文件已存在,覆盖或追加内容。写入完成后返回成功标志。

提供流式读写接口,处理大文件。流式读取不一次性加载整个文件,而是分块读取,避免内存溢出。流式写入逐步写入数据,提高性能。

### 文件对话框

文件对话框接口弹出系统原生的文件选择对话框。可以选择文件或目录,可以单选或多选。可以设置对话框标题,设置文件类型过滤器,设置默认路径。

用户选择文件后,对话框返回文件路径列表。如果用户取消,返回空列表。对话框是模态的,弹出时阻塞窗口,用户必须完成选择或取消。

保存对话框让用户选择保存位置和文件名。可以设置默认文件名,设置文件扩展名。用户确认后返回保存路径。

### 系统托盘

系统托盘接口在任务栏创建托盘图标。可以设置图标图片,设置工具提示文本,设置托盘菜单。

托盘图标支持点击事件,用户点击图标时触发回调。可以实现单击显示窗口,双击退出应用等交互。托盘菜单提供常用操作的快捷入口。

### 系统通知

系统通知接口发送桌面通知。通知包含标题、正文、图标。通知显示在屏幕角落,几秒后自动消失。用户可以点击通知,触发回调函数。

通知要符合系统规范,在不同平台使用平台原生的通知样式。Windows使用Action Center通知,macOS使用Notification Center通知。

### 全局快捷键

全局快捷键接口注册系统级快捷键。即使应用不在前台,按下快捷键也会触发应用响应。可以注册多个快捷键,每个快捷键绑定一个回调函数。

快捷键要避免冲突,注册前检查快捷键是否被其他应用占用。如果冲突,注册失败并提示用户。快捷键要支持组合键,包括Ctrl、Shift、Alt等修饰键。

## 使用方式

### 应用初始化

应用启动时,Electron框架模块自动初始化。创建主进程,加载配置,注册系统功能。然后创建主窗口,加载应用的主界面。

初始化过程中,模块向微内核注册所有服务接口。其他模块可以通过微内核调用这些服务,访问桌面功能。

### 创建应用窗口

上层模块需要创建窗口时,通过微内核发送窗口创建请求。请求包含窗口配置,Electron模块创建窗口并返回窗口ID。

窗口创建后,可以加载网页内容。将Chromium内核渲染的网页内容显示在窗口中。一个原生窗口包含一个或多个网页渲染窗口。

### 文件操作

插件需要访问文件系统时,通过微内核发送文件操作请求。请求包含操作类型和参数,Electron模块执行文件操作,返回结果。

所有文件路径都经过资源管理系统解析。插件使用标准化的资源标识符,资源管理系统转换为实际的文件路径,传递给Electron模块。

### 系统集成

应用使用系统功能时,通过接口调用。比如显示通知时,发送通知请求到Electron模块,模块调用系统API弹出通知。

系统托盘、全局快捷键等功能在应用启动时初始化。配置文件中定义这些功能的参数,Electron模块读取配置并注册功能。

### 菜单管理

应用菜单在主进程中定义和管理。菜单配置使用声明式方式,描述菜单结构、菜单项、快捷键等。Electron模块解析配置,创建原生菜单。

菜单项的点击事件通过微内核路由到对应的处理函数。比如"打开文件"菜单项点击后,路由到文件管理模块,弹出文件选择对话框。

## 技术细节

### 安全上下文

渲染进程默认禁用Node.js集成,只能使用网页API。这防止网页代码直接访问文件系统和系统功能。需要系统功能时,必须通过微内核路由请求。

主进程验证所有来自渲染进程的请求,检查权限。只有授权的操作才能执行,未授权的请求被拒绝并记录日志。

### 进程通信

主进程和渲染进程通过IPC通信,但不直接使用Electron的ipcMain和ipcRenderer,而是封装为服务调用。渲染进程调用服务时,请求发送到微内核,微内核路由到主进程对应的服务处理函数。

通信采用序列化机制,JavaScript对象序列化为JSON传输,接收方反序列化。支持传输复杂数据结构,包括嵌套对象、数组、Buffer等。

### 资源打包

应用打包时,Electron运行时、Node.js运行时、应用代码、依赖库打包在一起。使用asar格式压缩资源,减小体积。

打包配置指定要包含的文件,排除不需要的文件。开发时的源码不打包,只打包编译后的代码。资源文件要优化,压缩图片,精简CSS和JavaScript。

### 自动更新实现

自动更新使用Electron的autoUpdater模块。配置更新服务器地址,应用定期检查更新。检查到新版本时,下载更新包,验证签名。

更新包下载完成后,应用重启并安装更新。安装过程使用原子操作,确保更新成功或完全回滚,不会出现中间状态。
