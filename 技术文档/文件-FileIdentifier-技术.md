# 文件识别器 - 技术文档

## 架构设计

文件识别器使用规则匹配机制,维护文件类型规则表。规则包括扩展名规则和magic number规则。扩展名规则最简单最快,magic number规则更准确但需要读取文件。

识别流程先尝试扩展名匹配,大多数情况扩展名就能识别类型。如果扩展名不可靠或不存在,读取文件头,匹配magic number。magic number是文件开头的特定字节序列,不同格式有不同的magic number。

规则表可以扩展,插件可以注册新的文件类型规则,添加对自定义格式的支持。

## 接口定义

识别接口接收文件路径或File对象,首先检查扩展名,查找扩展名规则。如果找到,返回对应类型。如果没找到或需要确认,读取文件前几个字节,匹配magic number规则,返回类型。

MIME类型接口根据文件类型返回MIME字符串,使用预定义的类型到MIME的映射表。类型判断接口检查文件类型是否属于指定类别,比如image类别包括jpeg、png等类型。

## 使用方式

用户从系统拖拽文件到应用时,微内核调用文件识别器判断文件类型。根据类型决定如何处理,卡片文件打开卡片,图片文件创建图片卡片,视频文件创建视频卡片。

插件需要判断文件类型时,通过微内核调用文件识别器。比如图片卡片插件上传文件时,先识别是否是图片,不是图片拒绝上传。

## 技术细节

magic number匹配使用前缀树优化查找速度。将所有magic number组织成前缀树,读取文件头后,在树中查找匹配的规则,快速定位类型。

使用缓存避免重复识别,识别结果与文件路径关联缓存。再次识别同一文件时,从缓存读取,不需要重新识别。文件修改时缓存失效。
