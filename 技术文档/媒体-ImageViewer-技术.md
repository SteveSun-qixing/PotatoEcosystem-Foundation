# 图片查看器 - 技术文档

## 架构设计

### 整体架构

图片查看器基于HTML5 Canvas和CSS Transform构建。Canvas用于高性能的图片渲染和缩放,CSS Transform用于流畅的平移和旋转动画。两种技术结合,提供高质量高性能的图片查看体验。

架构分为四层。底层是图片加载层,负责从各种来源加载图片数据。加载层之上是渲染层,负责将图片绘制到Canvas或渲染为HTML元素。渲染层之上是交互层,处理用户的缩放平移旋转操作。最上层是服务接口层,通过微内核路由对外提供服务。

查看器支持多实例,实例管理器负责创建、跟踪、销毁查看器实例。每个实例有独立的渲染上下文、显示状态、图片数据。

### 图片加载

图片加载使用Image对象或Fetch API。对于本地图片,使用文件协议或data URL加载。对于网络图片,使用HTTP协议加载。

加载过程显示进度,对于大图片,使用渐进式加载,先显示低分辨率预览,再逐步显示高分辨率版本。

图片加载完成后,提取图片的宽度高度等信息,计算适配参数。如果图片包含EXIF数据,解析EXIF提取元数据和旋转信息。

加载失败时,记录错误日志,显示错误占位图,提供重试机制。

### 渲染引擎

渲染引擎使用Canvas绘制图片。创建Canvas元素作为渲染目标,Canvas尺寸与容器尺寸一致。使用Canvas的drawImage方法绘制图片,根据缩放和平移参数调整绘制位置和尺寸。

渲染支持高质量插值,使用imageSmoothingQuality属性设置插值质量为高。这在缩放时保持图片清晰,减少锯齿和模糊。

对于矢量图SVG,直接使用img元素渲染,不用Canvas。SVG支持无限缩放而不失真,直接渲染效果更好。

渲染性能优化,使用离屏Canvas预渲染,减少主Canvas的绘制次数。使用requestAnimationFrame驱动渲染,保证流畅的帧率。

### 缩放算法

缩放维护缩放级别状态,表示当前缩放比例。缩放级别1表示原始大小,大于1表示放大,小于1表示缩小。

缩放时计算新的绘制尺寸,图片尺寸乘以缩放级别。调整绘制位置,保持缩放中心不变。缩放中心可以是图片中心,也可以是鼠标指向的位置。

缩放边界限制,最小缩放不小于适配容器的尺寸,最大缩放不超过1000%。达到边界时,给出视觉反馈,比如短暂的弹簧动画。

缩放动画使用插值算法,从当前缩放级别平滑过渡到目标级别。使用easing函数控制动画速度,开始和结束时减速,中间加速。

### 平移算法

平移维护平移偏移状态,表示图片相对于容器的偏移量。偏移量是二维向量,包含水平和垂直偏移。

平移时更新偏移量,偏移量加上鼠标或触摸的移动距离。边界检测防止平移超出范围,图片边缘不能离开容器边缘。

平移性能优化,使用CSS Transform的translate属性实现平移,硬件加速提高性能。平移不重新绘制图片,只移动图片位置,减少计算开销。

惯性滑动,触摸释放后根据速度继续滑动一段距离,模拟物理惯性。使用减速动画,速度逐渐降低直到停止。

### 旋转处理

旋转维护旋转角度状态,表示图片旋转的角度。角度以度为单位,0度是原始方向,90度顺时针旋转,270度逆时针旋转。

旋转时使用CSS Transform的rotate属性实现旋转动画。旋转后重新计算适配参数,使图片完整显示在容器中。

旋转状态持久化保存,与图片路径关联。下次加载同一图片时,自动应用旋转状态。

### 多图管理

多图浏览维护图片列表,列表包含所有图片的路径和元数据。维护当前索引,指向当前显示的图片。

切换图片时,更新当前索引,加载并显示新图片。预加载相邻图片,提前加载前一张和后一张,减少切换延迟。

缩略图生成,对于图片列表,生成缩略图显示在导航栏。缩略图使用小尺寸渲染,减少内存占用。缩略图懒加载,只生成可见区域的缩略图。

## 接口定义

### 创建查看器

创建查看器接口接收容器元素和配置对象。容器元素是HTML元素,查看器渲染在这个容器中。配置对象包含初始图片源、显示模式、是否显示控制按钮等参数。

接口创建查看器实例,创建Canvas元素,初始化渲染上下文,渲染界面,返回实例标识符。创建是同步的,立即返回实例标识。

### 加载图片

加载图片接口接收图片路径或URL,解析为实际的资源位置。通过资源管理系统获取图片数据,创建Image对象加载。

支持加载单张图片或图片列表。加载完成后,解析图片信息,计算适配参数,渲染图片。加载失败时,触发错误事件,显示错误占位图。

### 缩放控制

缩放接口接收目标缩放级别和缩放中心。更新缩放状态,重新计算绘制参数,触发渲染更新。缩放动画平滑过渡到目标级别。

提供放大缩小接口,按固定步长增加或减少缩放级别。提供适配接口,自动计算合适的缩放级别使图片完整显示。

### 平移控制

平移接口接收偏移量,更新平移状态,移动图片位置。边界检测防止超出范围。

平移不需要显式调用接口,用户拖动自动平移。接口主要用于程序化控制,比如自动居中或移动到特定位置。

### 旋转控制

旋转接口接收旋转方向,顺时针或逆时针。更新旋转角度,触发旋转动画,重新计算适配参数。

提供重置旋转接口,将旋转角度恢复到0度。旋转状态持久化保存到本地存储。

### 显示模式

设置显示模式接口接收模式标识,包括包含、覆盖、填充、原始尺寸。更新显示模式状态,重新计算适配参数,触发渲染更新。

显示模式变化时,缩放和平移状态重置,图片重新适配到容器。

### 全屏控制

进入全屏接口调用容器元素的requestFullscreen方法,容器进入全屏。退出全屏调用exitFullscreen方法。全屏状态变化时触发fullscreenchange事件。

全屏时,查看器填充整个屏幕,背景变暗,隐藏其他界面元素。仍然支持所有查看操作。

### 导航控制

切换到上一张接口将当前索引减一,加载并显示前一张图片。切换到下一张接口将索引加一,显示后一张图片。索引到达边界时循环或停止,根据配置决定。

跳转接口接收目标索引,直接跳转到指定图片。检查索引有效性,无效索引不执行操作。

### 状态查询

状态查询接口返回查看器的当前状态,包括当前图片路径、缩放级别、旋转角度、平移偏移、显示模式等信息。

图片信息查询接口返回当前图片的元数据,包括尺寸、大小、格式、EXIF信息等。

### 事件订阅

事件订阅接口接收事件名称和回调函数,将回调注册到事件列表。支持的事件包括图片加载完成、加载失败、缩放变化、旋转变化、切换图片、进入退出全屏等。

事件通过微内核的事件总线分发,订阅者通过事件总线接收事件。事件对象包含事件类型、查看器标识、时间戳、相关数据等信息。

### 销毁查看器

销毁接口清理查看器资源,移除Canvas元素,清理事件监听,释放图片缓存,从实例管理器中移除记录。销毁后查看器实例不再可用。

## 使用方式

### 创建和初始化

图片卡片插件需要显示图片时,通过微内核向图片查看器模块发送创建请求。请求包含容器元素的标识和查看器配置。

查看器模块创建查看器实例,渲染到指定容器中。返回查看器实例标识,插件保存这个标识,后续操作使用这个标识。

### 加载和显示

创建查看器后,发送加载图片请求,传入图片文件路径。查看器通过资源管理系统获取图片,加载到Image对象。

加载完成后,解析图片尺寸,根据显示模式计算适配参数。在Canvas上绘制图片,图片显示在容器中。如果配置了自动适配,图片自动调整大小完整显示。

### 用户交互

用户与图片交互时,比如双击放大、拖动平移、鼠标滚轮缩放,事件由查看器捕获并处理。查看器更新显示状态,触发渲染更新,图片响应用户操作。

查看器状态变化时,触发事件通知插件。插件可以监听事件,执行相关逻辑,比如保存缩放级别到配置文件。

### 多图浏览

图片卡片包含多张图片时,插件在加载时传入图片列表。查看器显示第一张图片,提供导航控制。

用户点击上一张下一张按钮或按键盘箭头,事件传递到插件,插件发送切换请求。查看器切换到目标图片,预加载相邻图片,显示平滑的切换动画。

缩略图导航,查看器渲染缩略图列表,用户点击缩略图快速跳转。缩略图懒加载,滚动时动态生成可见区域的缩略图。

### 全屏查看

用户点击全屏按钮或双击图片,插件发送进入全屏请求。查看器进入全屏模式,容器填充整个屏幕,背景变暗。

全屏时仍然支持所有操作,用户可以缩放平移查看细节。按ESC键或点击关闭按钮,插件发送退出全屏请求,查看器退出全屏恢复正常显示。

### 清理资源

卡片关闭时,插件发送销毁查看器请求。查看器停止加载,清理Canvas,释放图片缓存,移除界面元素。确保不会因为查看器实例未销毁导致内存泄漏。

## 技术细节

### 高质量渲染

使用Canvas的imageSmoothingEnabled属性启用图片平滑,imageSmoothingQuality设置为high。这在缩放时使用高质量插值算法,减少锯齿,保持图片清晰。

对于放大超过原始尺寸的情况,使用最近邻插值保留像素的清晰边缘。对于缩小的情况,使用双线性或双三次插值保留细节。

渲染时考虑设备像素比,高分辨率屏幕使用更高的渲染分辨率,保证清晰显示。Canvas尺寸乘以像素比,绘制上下文缩放像素比倍数。

### 性能优化

使用离屏Canvas预渲染,将图片绘制到离屏Canvas,再将离屏Canvas复制到主Canvas。这减少主Canvas的绘制次数,提高性能。

使用requestAnimationFrame驱动渲染,保证渲染与屏幕刷新同步,帧率稳定。只在需要更新时渲染,状态没有变化不重新绘制。

大图片使用分块渲染,将图片分成多个块,只渲染可见区域的块。这减少绘制量,提高大图片的缩放平移性能。

### 内存管理

图片缓存使用LRU策略,最近使用的图片保留在缓存中,最久未使用的清理。缓存大小有限制,超过限制时自动清理。

离屏Canvas复用,不为每次渲染创建新的离屏Canvas,复用已有的Canvas。这减少内存分配和垃圾回收开销。

查看器销毁时,清理所有资源,包括Canvas元素、Image对象、事件监听、缓存数据。防止内存泄漏。

### 触摸手势

支持触摸设备的手势操作。单指滑动平移图片,双指捏合缩放图片。使用Touch事件API捕获触摸事件,计算手势参数。

双指捏合时,计算两指之间距离的变化,距离增加表示放大,距离减少表示缩小。计算缩放中心,两指中点作为缩放中心。

手势识别要准确,区分不同手势。单指滑动和双指捏合不能混淆。手势响应要流畅,延迟低,跟手性好。

### 动图播放

GIF动图使用img元素渲染,不用Canvas。浏览器原生支持GIF动画播放,直接使用img元素效果最好。

提供动图控制,暂停和继续播放修改img元素的src,停止时显示第一帧,播放时显示完整GIF。

逐帧播放使用Canvas绘制GIF的每一帧,手动控制帧的切换。解析GIF文件,提取所有帧,按需绘制指定帧。
