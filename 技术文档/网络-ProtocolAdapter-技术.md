# 协议适配器 - 技术文档

## 架构设计

协议适配器使用策略模式,每个协议有对应的适配器实现。适配器实现统一的接口,包括读取、写入、列出、删除等操作。

适配器管理器维护协议注册表,记录每个协议的适配器。资源访问时,解析资源标识符,提取协议类型,查找对应适配器,调用适配器方法访问资源。

资源标识符采用URL格式,协议名+冒号+路径,如file:///path/to/file、http://example.com/image.jpg、webdav://server/dir/file等。

认证信息存储在认证管理器中,与主机地址关联。访问需要认证的资源时,从认证管理器获取认证信息,传递给适配器。

## 接口定义

读取接口接收资源标识符,解析协议,查找适配器,调用适配器的读取方法,返回资源内容。内容可以是Buffer、Blob或Stream。

写入接口接收标识符和内容,调用适配器的写入方法,将内容写入目标位置。列出接口调用适配器的列出方法,返回文件列表,每个文件包含名称、大小、修改时间等元数据。

注册协议接口接收协议名称和适配器类,将适配器注册到注册表。适配器类实现标准接口,管理器创建适配器实例,使用实例处理请求。

## 使用方式

卡片引用外部资源时,使用协议适配器访问资源。资源标识符可以是本地文件、网络URL、WebDAV路径等,适配器自动选择合适的协议处理。

插件可以注册自定义协议,比如chips://协议访问卡片内部资源,plugin://协议访问插件资源。注册适配器实现协议逻辑,上层使用统一接口访问。

## 技术细节

HTTP适配器使用Fetch API或Axios发送HTTP请求,处理响应,返回资源数据。支持认证头,从认证管理器获取token,添加到请求头。

WebDAV适配器使用WebDAV协议的HTTP方法,PROPFIND列出目录,GET读取文件,PUT写入文件,DELETE删除文件。解析XML响应,提取文件元数据。

S3适配器使用AWS SDK或兼容的SDK,调用S3 API访问对象存储。使用Access Key和Secret Key认证,生成签名头,发送请求到S3端点。

文件适配器使用File System Access API或Electron的fs模块,访问本地文件系统。浏览器环境使用File System Access API请求权限,Node环境使用fs模块直接访问。
