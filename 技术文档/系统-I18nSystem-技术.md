# 多语言系统 - 技术文档

## 架构设计

多语言系统维护语言包注册表,存储所有语言的翻译数据。语言包是键值对映射,键是翻译键,值是翻译文本。

翻译键使用点分隔的路径格式,如common.save、message.success、error.not_found。路径表示翻译的层级关系,便于组织管理。

当前语言存储在全局状态,所有翻译请求使用当前语言。切换语言更新全局状态,触发界面更新事件,组件响应事件重新渲染文本。

变量替换使用模板语法,占位符用花括号包围,如"Hello {name}"。翻译时解析模板,将占位符替换为变量值。

复数形式使用ICU MessageFormat,根据数量选择文本。格式如"{count, plural, =0{no items} =1{one item} other{# items}}",count=0显示"no items",count=1显示"one item",其他显示"# items"。

## 接口定义

翻译接口接收翻译键和变量对象,查找当前语言的语言包,获取翻译文本。如果文本包含占位符,替换为变量值。如果找不到翻译,返回翻译键或默认文本。

切换语言接口接收语言代码,更新全局当前语言状态。如果语言包未加载,先加载语言包。触发语言变化事件,通知所有组件。

加载语言包接口接收语言代码和语言包数据或URL,将语言包注册到注册表。如果是URL,异步加载语言包文件,加载完成注册。

## 使用方式

组件显示文本时,调用翻译接口获取翻译文本。传入翻译键和变量,接口返回当前语言的文本,组件渲染文本。

用户切换语言时,调用切换语言接口。接口加载新语言包,更新全局状态,触发事件。组件监听事件,重新调用翻译接口,更新界面文本。

插件注册时提供语言包,多语言系统合并插件语言包到系统语言包。插件使用翻译接口获取自己的翻译文本。

## 技术细节

语言包格式使用JSON或YAML,嵌套对象表示层级关系。如{"common": {"save": "保存", "cancel": "取消"}}。

翻译查找使用路径查找算法,split翻译键为路径数组,遍历数组在语言包中查找。如"common.save"分解为["common", "save"],先查找common对象,再查找save属性。

回退机制,找不到翻译时回退到默认语言。如当前语言是日文,日文语言包没有某个键,回退到英文语言包查找,再没有返回翻译键。

缓存翻译结果,相同翻译键和变量的结果缓存起来,避免重复查找和替换。语言包更新或语言切换时清空缓存。
