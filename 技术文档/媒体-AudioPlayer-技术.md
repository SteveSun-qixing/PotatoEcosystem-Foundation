# 音频播放器 - 技术文档

## 架构设计

### 整体架构

音频播放器基于Web Audio API和HTML5 Audio元素构建。Web Audio API提供强大的音频处理能力,支持音效、可视化、音频分析等高级功能。HTML5 Audio元素提供基础的音频播放能力,兼容性好。

架构分为四层。底层是音频解码层,使用浏览器原生解码器或软解码库。解码层之上是播放器核心层,管理播放状态、播放列表、播放控制。核心层之上是音频处理层,实现可视化、音效等功能。最上层是服务接口层,通过微内核路由对外提供服务。

播放器支持多实例,实例管理器负责创建、跟踪、销毁播放器实例。每个实例有独立的音频上下文、播放状态、播放列表。

### 音频处理

使用Web Audio API创建音频处理管道。音频源节点从audio元素或音频数据创建,连接到各种处理节点,处理节点连接到目标节点输出。

处理节点包括增益节点控制音量,均衡器节点调整频率,分析节点提取音频数据用于可视化。节点之间可以灵活组合,构建复杂的音频处理流程。

音频上下文在播放器创建时初始化,在播放器销毁时关闭,释放资源。

### 播放控制

播放器核心维护播放状态机,状态包括未加载、加载中、已加载、播放中、暂停、停止、错误等。状态转换有明确的规则,只能按照规定的路径转换。

播放控制使用audio元素的play、pause、stop方法。跳转使用currentTime属性。音量使用volume属性。这些操作通过Promise异步执行,操作完成或失败后Promise resolve或reject。

播放位置使用定时器定期更新,触发进度更新事件。定时器使用requestAnimationFrame,确保更新平滑且高效。

### 播放列表管理

播放列表是音频项的数组,每个音频项包含音频源、标题、艺术家、时长等信息。列表管理器提供添加、删除、排序、查询等操作。

播放列表持久化保存到本地存储,使用JSON格式序列化。应用重启时从本地存储加载,恢复播放列表。

播放模式决定下一曲的选择策略。顺序播放按索引递增选择,循环播放到结尾后回到开头,随机播放使用随机数选择。

### 歌词同步

歌词解析器读取LRC格式的歌词文件,解析歌词内容和时间戳。解析后的歌词存储为时间轴结构,每个时间点对应一句歌词。

歌词渲染器在界面显示歌词,根据当前播放时间查找应该显示的歌词。当前歌词高亮显示,其他歌词显示为普通样式。

歌词自动滚动,当前歌词始终保持在视图中间。点击歌词时,获取歌词对应的时间戳,跳转到该时间播放。

### 音频可视化

可视化使用Web Audio API的AnalyserNode分析音频数据。AnalyserNode提取音频的频域数据或时域数据,频域数据是频谱,时域数据是波形。

可视化渲染器使用Canvas绘制可视化效果。根据音频数据绘制条形图、波形图、圆形谱图等。使用requestAnimationFrame定期更新画面,保持流畅的动画效果。

可视化样式通过CSS变量控制颜色和尺寸,配合主题系统。可视化算法可以扩展,支持不同的视觉效果。

## 接口定义

### 创建播放器

创建播放器接口接收容器元素和配置对象。容器元素是HTML元素,播放器渲染在这个容器中。配置对象包含初始音频源、是否自动播放、初始音量、是否显示可视化等参数。

接口创建播放器实例,初始化音频上下文,创建处理管道,渲染界面,返回实例标识符。创建是异步的,返回Promise,播放器就绪后Promise resolve。

### 加载音频

加载音频接口接收音频源URL或文件路径,解析为实际的资源位置。通过资源管理系统获取音频数据,传递给audio元素加载。

支持加载本地文件和网络音频。加载完成后,解析音频元数据,提取标题、艺术家、专辑、封面等信息。如果有歌词文件,自动加载歌词。

### 播放和暂停

播放接口调用audio元素的play方法,开始播放音频。暂停接口调用pause方法,暂停播放。接口是异步的,操作完成后Promise resolve。

播放失败时,Promise被拒绝,包含错误信息。常见的失败原因包括音频未加载、格式不支持、解码错误等。

### 跳转播放位置

跳转接口接收目标时间,以秒为单位。设置audio元素的currentTime属性,跳转到目标位置。跳转后触发seeked事件,通知订阅者。

跳转要处理边界情况。目标时间小于零时,跳转到开头。目标时间大于总时长时,跳转到结尾。

### 音量和音效

音量设置接口接收音量值,范围0到1。设置audio元素的volume属性或增益节点的gain值。静音接口设置muted属性。

音效设置接口接收音效参数,配置均衡器节点的参数。均衡器支持调整不同频段的增益,实现重低音增强、人声突出等效果。

### 播放列表操作

添加到列表接口接收音频项,将其添加到播放列表数组。移除接口接收音频项标识,从列表中删除。调整顺序接口接收新的索引数组,重新排列列表。

播放列表变化后,持久化保存到本地存储。触发播放列表变化事件,通知订阅者。

### 播放模式

设置播放模式接口接收模式标识,包括顺序、循环、单曲循环、随机。更新播放模式状态,影响下一曲的选择逻辑。

切换播放模式时,不影响当前播放的音频,但下一曲按新模式选择。

### 歌词操作

加载歌词接口接收歌词文件URL,下载并解析歌词文件。解析完成后,将歌词数据存储,开始同步显示。

显示隐藏歌词接口控制歌词的可见性。设置歌词样式接口接收样式对象,更新歌词的字体、颜色、位置等样式。

### 可视化控制

启用或禁用可视化接口控制可视化的显示。切换可视化样式接口接收样式标识,切换到不同的可视化效果。

设置可视化参数接口接收配置对象,调整可视化的灵敏度、平滑度、颜色等参数。

### 事件订阅

事件订阅接口接收事件名称和回调函数,将回调注册到事件列表。支持的事件包括播放开始、播放暂停、播放结束、切换歌曲、时间更新、音量变化、错误发生等。

事件通过微内核的事件总线分发,订阅者通过事件总线接收事件。事件对象包含事件类型、播放器标识、时间戳、相关数据等信息。

### 销毁播放器

销毁接口停止播放,关闭音频上下文,移除界面元素,清理事件监听,释放资源。从实例管理器中移除实例记录。

## 使用方式

### 创建和初始化

音乐卡片插件需要播放音频时,通过微内核向音频播放器模块发送创建请求。请求包含容器元素的标识和播放器配置。

播放器模块创建播放器实例,渲染到指定容器中。返回播放器实例标识,插件保存这个标识,后续操作使用这个标识。

### 加载和播放

创建播放器后,发送加载音频请求,传入音频文件路径。播放器通过资源管理系统获取音频,加载到audio元素。加载完成后,解析元数据,显示音频信息和封面。

如果配置了自动播放,加载完成后自动开始播放。否则显示播放按钮,等待用户点击。用户点击播放按钮时,插件发送播放请求,播放器开始播放音频。

### 播放控制

用户与播放器交互时,比如点击暂停按钮、拖动进度条、调节音量、切换歌曲,事件传递到插件。插件发送相应的控制请求到播放器,播放器执行操作并更新界面。

播放器状态变化时,触发事件通知插件。插件根据状态变化更新自己的界面或执行相关逻辑。

### 播放列表

音乐卡片可以包含播放列表,插件在创建播放器时传入列表配置。播放器加载列表中的所有音频,按顺序播放。

用户切换歌曲时,插件发送切换请求,指定目标歌曲的索引或标识。播放器停止当前歌曲,加载并播放目标歌曲。

播放完一首歌曲自动播放下一首,播放器根据播放模式选择下一首,自动切换。

### 歌词同步

音频包含歌词时,插件在加载音频时传入歌词配置。播放器加载并显示歌词,歌词与音频同步滚动。

用户点击歌词时,事件传递到插件,插件发送跳转请求,播放器跳转到歌词对应的时间播放。

### 可视化效果

如果启用了可视化,播放器在播放时绘制音频可视化效果。可视化与音频同步,根据音频数据实时更新。

插件可以切换可视化样式,发送切换请求,播放器应用新的可视化效果。可视化配合主题系统,根据主题颜色调整可视化的颜色方案。

### 后台播放

应用最小化或切换到其他界面时,音频继续播放。播放器在后台运行,定期更新播放进度,触发事件通知前台。

系统媒体控制集成,播放器信息显示在系统通知区域,用户可以通过系统控制播放。媒体键事件传递到播放器,播放器响应控制。

### 清理资源

卡片关闭时,插件发送销毁播放器请求。播放器停止播放,关闭音频上下文,清理资源,移除界面元素。确保不会因为播放器实例未销毁导致内存泄漏或资源占用。

## 技术细节

### Web Audio API

使用Web Audio API构建音频处理管道。创建AudioContext作为音频处理的上下文。创建MediaElementSourceNode从audio元素获取音频数据。

连接GainNode控制音量,连接BiquadFilterNode实现均衡器,连接AnalyserNode提取数据用于可视化。最后连接到destination输出音频。

节点连接后,形成音频处理图。音频数据流经各个节点,被处理后输出。节点的参数可以动态调整,实时改变音频效果。

### 歌词解析

LRC歌词格式是文本文件,每行是一句歌词加时间戳。时间戳格式是分:秒.毫秒。解析器逐行读取,提取时间戳和歌词文本。

解析后的歌词存储为数组,每个元素包含时间和文本。数组按时间排序,方便查找。播放时,根据当前时间二分查找应该显示的歌词。

### 可视化算法

频谱可视化使用AnalyserNode的getByteFrequencyData方法获取频域数据。数据是数组,每个元素是一个频段的能量值。绘制条形图,每个频段一个条,条的高度表示能量。

波形可视化使用getByteTimeDomainData方法获取时域数据。数据是波形采样,绘制折线图,连接所有采样点。

可视化使用Canvas 2D API绘制。每帧清空画布,获取最新音频数据,绘制新的可视化效果。使用requestAnimationFrame驱动动画,保持流畅。

### 播放模式实现

顺序播放维护当前索引,播放完当前歌曲后索引加一,加载并播放下一首。到达列表末尾停止。

列表循环类似顺序播放,但到达末尾后索引归零,继续播放。单曲循环播放完当前歌曲后重新播放同一首。

随机播放使用随机数生成器选择索引。记录已播放的歌曲,避免短时间内重复播放。列表中所有歌曲都播放过一遍后,清空已播放记录,开始新一轮。

### 性能优化

音频数据缓存,已加载的音频缓存起来,避免重复加载。使用浏览器的缓存机制,网络音频下载后自动缓存。

可视化优化,降低采样率减少绘制量。使用离屏Canvas预渲染,减少主画布的绘制次数。平滑算法减少可视化的抖动。

内存管理,音频播放完后释放缓冲区,长时间不用的数据清理。播放器销毁时关闭音频上下文,释放所有资源。
