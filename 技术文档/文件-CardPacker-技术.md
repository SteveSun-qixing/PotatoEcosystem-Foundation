# 卡片打包器 - 技术文档

## 架构设计

卡片打包器构建在 ZIP 处理器之上，复用 ZIP 处理器的压缩、解压、流式读取能力。打包器专注于卡片格式的业务逻辑，负责目录结构的组织和验证，将卡片格式规范转化为具体的文件操作。

打包器内部维护一份卡片格式规范的结构定义，描述了 .card 配置文件夹应该包含哪些文件，content 文件夹的组织方式，资源文件的命名规则等。所有的打包、解包、验证操作都以这份结构定义为依据。

验证器是打包器的核心组件，提供多层次的结构检查。目录验证检查必需的文件夹是否存在，文件验证检查必需的配置文件是否存在且格式正确，引用验证检查配置文件中引用的资源是否存在。验证器支持部分验证，可以只检查某些层次，满足不同场景的需求。

## 接口定义

打包接口接收源文件夹路径、输出文件路径和可选的配置对象。配置对象可以指定是否在打包前验证结构、是否计算文件校验值等。接口首先执行验证（如果启用），然后遍历源文件夹，调用 ZIP 处理器创建零压缩 ZIP 文件，最后将扩展名改为 .card。打包过程是异步的，返回 Promise。

解包接口接收 .card 文件路径、输出目录路径和可选的配置对象。配置对象可以指定是否覆盖已存在的目录、是否在解包后验证结构等。接口调用 ZIP 处理器解压文件，然后执行验证（如果启用），返回解包结果。解包过程是异步的。

验证接口接收目标路径和验证配置。目标可以是文件夹路径或 .card 文件路径，接口自动判断类型并选择对应的验证流程。验证配置可以指定验证级别，如仅目录验证、仅文件验证、完整验证等。接口返回验证结果对象，包含总体通过状态和各检查项的详细结果。

元数据读取接口接收 .card 文件路径，调用 ZIP 处理器的单文件读取功能，直接读取 .card/metadata.yaml 的内容。读取到的 YAML 文本传递给数据序列化器解析，返回解析后的元数据对象。整个过程不需要解压其他文件，内存占用极小。

## 使用方式

编辑引擎保存卡片时，调用打包器的打包接口。将编辑工作区中的文件夹打包成 .card 文件，保存到用户指定的位置。打包前会自动验证结构，确保生成的文件符合规范。

编辑引擎打开卡片时，调用打包器的解包接口。将 .card 文件解压到编辑工作区，解包后编辑引擎可以直接读写工作区中的文件。

查看器、文件浏览器等需要显示卡片列表时，调用打包器的元数据读取接口。快速获取每个 .card 文件的名称、创建时间等信息，用于列表显示。不需要解压整个卡片，性能开销很小。

导入第三方卡片时，调用打包器的验证接口。检查导入的 .card 文件是否符合格式规范，验证通过才允许导入。验证报告帮助用户了解文件的问题，决定如何处理。

## 技术细节

打包时的目录遍历使用递归方式，按照卡片格式规范的目录顺序添加文件。.card 配置文件夹最先添加，保证元数据文件在 ZIP 的前端，方便快速访问。content 文件夹次之，资源文件最后添加。

验证配置文件时，读取文件内容，调用数据序列化器的 YAML 解析功能。解析成功说明格式正确，然后检查必需字段是否存在，字段值是否符合约束。验证过程中的错误信息记录到验证报告，不中断后续检查。

引用验证检查配置文件中的资源路径。提取所有资源引用，判断路径类型是相对路径、绝对路径还是 URL。相对路径引用需要检查对应的资源文件是否存在于卡片内，绝对路径和 URL 引用只记录不验证。

元数据读取使用 ZIP 处理器的随机访问能力，直接定位到 .card/metadata.yaml 在 ZIP 中的位置，读取该文件的内容。不需要解析整个 ZIP 的目录结构，也不需要读取其他文件，实现最小化的 IO 操作。
