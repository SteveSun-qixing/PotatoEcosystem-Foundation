# 数据序列化器 - 技术文档

## 架构设计

数据序列化器使用成熟的序列化库,JSON使用原生JSON API,YAML使用js-yaml或yaml库。在库的基础上封装统一接口,提供额外功能如验证、转换。

验证使用JSON Schema或类似的Schema语言,定义数据结构规范。验证器根据Schema检查数据,使用ajv或joi库实现验证。

自定义序列化使用注册机制,类型注册序列化函数和反序列化函数。序列化时检查对象类型,找到对应函数调用。反序列化时根据类型标记还原对象。

## 接口定义

序列化接口接收对象和配置,配置包括格式、是否缩进、自定义序列化器等。接口根据格式选择序列化器,调用序列化函数,返回字符串。

反序列化接口接收字符串和配置,配置包括格式、Schema、自定义反序列化器等。接口解析字符串为对象,如果提供Schema验证对象,验证通过返回对象,失败抛出错误。

验证接口接收数据和Schema,使用验证器检查数据。返回验证结果对象,包含是否有效、错误列表。错误对象包含字段路径、错误类型、错误消息。

## 使用方式

卡片保存时,将配置对象序列化为YAML,写入配置文件。YAML格式友好,支持注释,方便手动编辑。

卡片加载时,读取配置文件,反序列化YAML为对象。验证对象结构,检查必需字段是否存在,类型是否正确。验证通过使用配置,失败给出错误提示。

## 技术细节

JSON序列化使用JSON.stringify,传入replacer函数处理特殊类型。Date转换为ISO字符串,RegExp转换为字符串表示。反序列化使用JSON.parse,传入reviver函数还原特殊类型。

YAML序列化使用yaml.dump,设置缩进、流式等选项。YAML支持多行字符串,使用|或>表示。支持锚点和别名,重复数据引用而不复制。

Schema验证使用ajv库,编译Schema为验证函数,验证函数检查数据。错误对象包含详细信息,dataPath指出错误字段路径,message描述错误原因。
