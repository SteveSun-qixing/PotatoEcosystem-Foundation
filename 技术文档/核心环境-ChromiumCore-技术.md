# Chromium内核封装 - 技术文档

## 架构设计

### 整体架构

Chromium内核封装采用分层架构。最底层是Chromium原生引擎,提供基础的网页渲染能力。中间层是封装适配层,将Chromium的接口转换为薯片生态的标准接口。最上层是服务接口层,通过微内核路由对外提供服务。

封装层不直接暴露Chromium的原生接口,而是提供经过抽象的标准化接口。这样做有两个好处:一是上层模块不需要了解Chromium的实现细节,二是将来如果需要替换渲染引擎,只需要修改封装层。

### 进程模型

采用多进程架构,主进程负责窗口管理和路由,渲染进程负责网页渲染。每个网页窗口运行在独立的渲染进程中,进程之间相互隔离。如果某个渲染进程崩溃,只影响对应的窗口,不影响其他窗口。

主进程和渲染进程通过进程间通信机制交互。主进程向渲染进程发送渲染指令,渲染进程将渲染结果返回主进程。通信采用异步消息传递,不阻塞主进程。

### 窗口管理

窗口管理器维护所有活动窗口的注册表。每个窗口有唯一的标识符,窗口管理器记录窗口的状态、配置、所属进程等信息。

窗口支持生命周期管理。创建窗口时分配资源,初始化渲染上下文。显示窗口时启动渲染,隐藏窗口时暂停渲染。关闭窗口时清理资源,销毁渲染进程。

窗口管理器实现窗口池机制。提前创建一些空闲窗口放在池中,当需要新窗口时直接从池中取出,避免临时创建的开销。

## 接口定义

### 窗口创建

窗口创建接口接收窗口配置参数,返回窗口标识。配置参数包括窗口的初始宽度和高度,初始加载的URL或HTML内容,安全沙箱级别,是否启用开发者工具等。

接口采用异步模式,调用后立即返回窗口标识,窗口的实际创建在后台完成。可以监听窗口就绪事件,确认窗口已经创建完成可以使用。

### 内容渲染

内容渲染接口支持两种模式。URL模式传入网页地址,窗口加载指定的网页。HTML模式传入HTML字符串,窗口直接渲染这段内容。

对于HTML模式,还可以设置基础URL,用于解析HTML中的相对路径。比如HTML中引用了图片,基础URL决定了图片的实际路径。

### 通信桥

通信桥提供JavaScript与原生代码的双向通信。网页中的JavaScript通过全局对象调用原生功能,调用请求经过微内核路由到目标模块,结果通过Promise返回。

原生代码可以向网页注入JavaScript代码,也可以调用网页中已有的JavaScript函数。这些操作都要通过微内核验证权限,确保安全。

### 资源拦截

提供资源拦截机制,拦截网页的资源请求。当网页请求加载某个资源时,拦截器可以修改请求,比如重定向到本地文件,或者添加认证信息。

拦截器还可以修改资源响应,比如注入额外的CSS或JavaScript,修改内容类型,处理跨域问题。

### 事件系统

事件系统提供网页事件的监听和分发。支持的事件包括页面加载开始、页面加载完成、页面标题变化、控制台消息、错误事件等。

事件通过微内核的事件总线分发,感兴趣的模块可以订阅这些事件。事件包含事件类型、窗口标识、事件数据等信息。

## 使用方式

### 创建窗口

上层模块需要渲染网页内容时,通过微内核向Chromium内核封装模块发送窗口创建请求。请求包含窗口配置,包括要渲染的内容来源、窗口尺寸、安全设置等。

模块处理请求,创建渲染窗口,返回窗口标识。上层保存这个标识,后续所有对该窗口的操作都使用这个标识。

### 加载内容

获得窗口标识后,发送内容加载请求。可以加载网页URL,也可以加载HTML内容。加载是异步的,可以监听加载完成事件。

对于复合卡片,其窗口加载包含多个基础卡片的HTML框架。对于基础卡片,其内容由对应的插件生成HTML,传递给窗口渲染。

### 窗口控制

通过窗口标识可以控制窗口的显示和隐藏。当卡片窗口被用户关闭时,不销毁窗口而是隐藏,这样用户再次打开时可以快速显示。

可以刷新窗口内容,重新加载当前页面。可以前进后退,对于支持导航的内容实现历史记录功能。

### 通信交互

网页中的JavaScript可以通过注入的全局对象与原生代码通信。比如视频卡片的前端需要播放视频时,调用全局对象的方法,请求传递到微内核,路由到视频播放器模块。

原生代码可以执行网页中的JavaScript,实现对网页的控制。比如当主题切换时,执行JavaScript更新网页的CSS变量。

### 资源管理

网页加载的资源统一通过资源管理系统。当网页请求某个资源时,资源拦截器拦截请求,交给资源管理器处理。资源管理器根据资源路径判断是本地文件还是网络资源,获取资源内容返回。

这样网页不需要知道资源的实际位置,统一使用标准化的资源标识符,资源管理系统负责解析和获取。

## 技术细节

### 沙箱机制

沙箱通过进程隔离和权限限制实现。不受信任的内容运行在独立的渲染进程中,这个进程的权限受限,不能访问文件系统,不能创建网络连接,不能访问系统API。

沙箱进程只能与主进程通信,主进程验证所有请求的合法性。即使沙箱进程被恶意代码控制,也无法突破沙箱的限制。

### 性能优化

采用多种技术优化渲染性能。使用GPU加速,渲染操作在显卡上执行,提高渲染速度。使用分层渲染,将页面分成多个图层,只重绘变化的图层。

实现渲染缓存,对于静态内容缓存渲染结果,避免重复计算。实现增量渲染,只渲染视口内的内容,视口外的内容延迟渲染。

### 内存管理

实现内存回收机制,定期清理不再使用的资源。当窗口关闭时,释放该窗口占用的内存。当内存占用过高时,主动触发垃圾回收。

实现内存限制,每个渲染进程的内存使用有上限,超过限制时强制清理或重启进程。

### 版本更新

定期更新Chromium版本,获取最新的特性和安全补丁。更新采用渐进式策略,先在测试环境验证,确认稳定后推送到生产环境。

维护版本兼容性列表,记录不同版本支持的网页特性,上层模块可以查询兼容性,决定是否使用某个特性。
