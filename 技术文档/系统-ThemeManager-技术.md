# 主题管理器 - 技术文档

## 架构设计

主题管理器采用注册表模式管理主题。系统启动时扫描主题目录，读取每个主题包的配置文件，将主题信息加载到内存中的注册表。注册表是一个 Map 结构，键是主题 ID，值是主题的元数据对象。所有查询操作都基于注册表进行，避免频繁的文件系统访问。

主题目录结构按发行商组织，路径格式为 themes/{publisher}/{theme-name}/。每个主题包目录包含 theme.yaml 配置文件、styles/ 样式文件夹和可选的 assets/ 资源文件夹。样式文件夹中按组件类型组织 CSS 文件，如 base-card.css、video-card.css 等。资源文件夹存放主题使用的图片、图标等静态资源。

默认主题作为系统的兜底方案，存储在应用安装目录的 default-theme/ 子目录中。默认主题的结构与普通主题包相同，但在注册表中标记为系统主题，不允许卸载或修改。主题查询和获取的逻辑中，当请求的主题不存在时，自动回退到默认主题。

## 接口定义

主题列表查询接口返回注册表中所有主题的摘要信息数组。接口支持 filter 参数对象，可以指定 publisher 过滤发行商，指定 componentType 过滤支持的组件类型。过滤在内存中进行，遍历注册表，检查每个主题是否符合条件，返回符合条件的主题列表。

主题详情查询接口接收 themeId 字符串，从注册表中查找对应的主题元数据。如果主题存在，读取主题包的完整配置文件，解析后返回详情对象。详情包含主题的所有配置项，以及支持的组件类型列表、CSS 变量定义、资源清单等扩展信息。

主题内容获取接口接收 themeId 和可选的 componentType 参数。接口定位主题包的 styles 目录，如果指定了组件类型则读取对应的 CSS 文件，否则读取所有 CSS 文件。读取到的 CSS 内容作为字符串返回，软件可以直接注入到页面中使用。

主题安装接口接收 sourcePath 路径参数，可以是主题包压缩文件或主题包目录。接口首先验证源路径的格式，读取配置文件检查必需字段。验证通过后确定目标路径，按照发行商和主题名称组织。如果是压缩文件则解压到目标路径，如果是目录则复制到目标路径。最后更新注册表，将新主题的信息添加进去。

主题卸载接口接收 themeId 参数，首先检查主题是否存在且不是系统主题。检查通过后从注册表移除该主题的记录，然后删除主题包的目录。删除操作使用递归删除，确保清理所有文件。操作完成后返回卸载结果。

资源路径解析接口接收 themeId 和 relativePath 参数，根据主题在注册表中的存储路径，拼接资源的相对路径，返回资源的绝对文件路径。接口会验证路径是否在主题包目录范围内，防止路径穿越攻击。

## 使用方式

软件启动时初始化主题管理器，管理器扫描主题目录建立注册表。软件调用列表查询接口获取可用主题，构建主题选择界面展示给用户。

用户选择主题后，软件调用内容获取接口获取主题的样式。软件将获取到的 CSS 内容注入到页面，应用主题的视觉效果。如果主题包含资源引用，软件调用资源路径解析接口获取实际路径，加载图片图标等资源。

用户从市场下载主题包后，软件调用安装接口将主题包安装到系统。安装完成后注册表自动更新，新主题立即出现在主题选择列表中。用户可以切换到新安装的主题。

用户删除不需要的主题时，软件调用卸载接口移除主题。如果被卸载的主题正在使用，软件需要先切换到其他主题或默认主题，然后再执行卸载。

## 技术细节

注册表使用 Map 数据结构，主题 ID 作为键提供 O(1) 的查找效率。主题 ID 的格式是 {publisher}:{theme-name}，如 "薯片官方:默认主题"。这种格式保证了 ID 的唯一性，同时便于按发行商进行分类。

主题目录扫描使用异步 IO，遍历发行商目录和主题包目录，读取每个 theme.yaml 配置文件。扫描结果缓存在注册表中，后续操作直接使用缓存。文件系统发生变化时，可以调用刷新方法重新扫描，支持增量更新。

CSS 内容获取支持按组件类型分割，减少不必要的数据传输。样式文件按组件类型命名，如 video-card.css、image-card.css 等。获取特定组件的样式时，只读取对应的文件，不加载整个主题包。

安装验证检查配置文件的格式和必需字段，包括 id、name、version、publisher 等。检查样式目录是否存在，至少包含一个 CSS 文件。验证失败返回详细的错误信息，说明哪个检查项未通过。

主题版本管理使用语义化版本号比较。安装时如果目标主题已存在，比较版本号，新版本大于旧版本才执行更新。更新时先备份旧版本，安装完成后删除备份，安装失败则恢复备份，保证操作的原子性。
