# 3D模型渲染器 - 技术文档

## 架构设计

### 整体架构

3D模型渲染器基于Three.js库构建,Three.js是成熟的WebGL封装库,提供完整的3D渲染能力。在Three.js之上封装符合薯片生态规范的接口层,对外提供统一的服务。

架构分为四层。底层是WebGL渲染层,利用GPU进行三维图形渲染。WebGL层之上是Three.js层,封装场景、相机、光照、材质等3D概念。Three.js层之上是渲染控制层,管理渲染循环、性能优化、资源管理。最上层是服务接口层,通过微内核路由对外提供服务。

渲染器支持多实例,实例管理器负责创建、跟踪、销毁渲染器实例。每个实例有独立的WebGL上下文、Three.js场景、渲染器对象。

### 场景管理

Three.js场景是3D对象的容器,包含模型、光照、相机等元素。场景管理器维护场景树,添加删除场景对象,组织对象的层次关系。

场景初始化时,创建基础元素。添加环境光提供基础照明,添加平行光模拟太阳光,添加地面网格作为参考。这些元素可以配置显示或隐藏。

模型加载后,添加到场景中。模型可能包含多个网格对象,每个网格有自己的几何体和材质。遍历模型结构,将所有网格添加到场景。

场景更新循环驱动渲染,使用requestAnimationFrame定期调用渲染函数。渲染函数更新动画、相机、光照,然后渲染场景。

### 模型加载

模型加载使用Three.js的加载器,不同格式使用不同加载器。GLTFLoader加载GLTF和GLB文件,OBJLoader加载OBJ文件,FBXLoader加载FBX文件。

加载器异步加载模型文件,加载完成后解析为Three.js对象。对象包含几何体、材质、纹理、动画等数据。

加载过程显示进度,大模型加载时间长,显示进度条或百分比。加载失败时,捕获错误,显示错误信息。

模型加载后,计算包围盒,确定模型的尺寸和中心。根据包围盒调整相机位置,使模型完整显示在视口中。

### 渲染管线

渲染管线使用Three.js的WebGLRenderer。渲染器创建WebGL上下文,绑定到Canvas元素。设置渲染参数,包括抗锯齿、像素比、色彩空间等。

每帧渲染时,渲染器清空Canvas,然后渲染场景。场景中的所有对象按照深度排序,从后往前渲染。透明对象最后渲染,避免遮挡问题。

渲染管线支持多通道渲染,实现高级效果。第一通道渲染阴影贴图,第二通道渲染主场景,第三通道应用后期处理如抗锯齿、泛光等。

渲染性能优化,使用frustum culling剔除视锥外的对象,不渲染看不见的部分。使用LOD技术,远处的对象使用低精度模型。

### 相机系统

相机使用Three.js的PerspectiveCamera或OrthographicCamera。透视相机模拟人眼,正交相机没有透视效果。

相机控制使用OrbitControls,实现轨道控制。鼠标左键拖动旋转相机,滚轮缩放相机距离,右键拖动平移相机。控制参数可以配置,包括旋转速度、缩放速度、阻尼系数等。

相机状态包括位置、目标点、上方向。状态可以保存和恢复,序列化为JSON保存到本地存储。下次打开时反序列化,恢复相机到上次的状态。

相机预设定义常用视角,比如前视图的相机位置在模型前方,朝向模型中心。应用预设时,相机平滑过渡到预设位置。

### 光照系统

光照使用Three.js的光源对象。环境光提供均匀的基础照明,没有方向,照亮所有表面。平行光模拟太阳光,有方向,所有光线平行。点光源从一点向四周发光,像灯泡。聚光灯有位置和方向,照亮一个锥形区域。

光照参数包括颜色、强度、位置、方向。参数可以动态调整,实时预览效果。光照变化时,场景重新渲染。

阴影使用WebGL的阴影贴图技术。从光源视角渲染场景到阴影贴图,然后在主渲染中使用阴影贴图判断哪里在阴影中。阴影质量由阴影贴图分辨率决定,高分辨率阴影清晰但性能开销大。

### 材质系统

材质使用Three.js的材质对象。基础材质包括MeshBasicMaterial、MeshLambertMaterial、MeshPhongMaterial。PBR材质使用MeshStandardMaterial或MeshPhysicalMaterial,支持金属度粗糙度工作流。

材质参数从模型文件读取,GLTF文件包含完整的材质定义。OBJ文件搭配MTL材质文件,解析MTL获取材质参数。

纹理加载使用TextureLoader,加载图片文件为纹理对象。纹理应用到材质的不同通道,baseColorMap应用到基础颜色,normalMap应用到法线,等等。

材质可以动态修改,运行时改变材质参数,场景实时更新。比如调整材质的颜色属性,模型的颜色立即变化。

### 动画系统

动画使用Three.js的AnimationMixer。模型包含动画数据时,创建AnimationMixer管理动画。从模型提取AnimationClip,添加到Mixer。

动画播放时,Mixer在每帧更新动画时间,计算当前帧的骨骼变换或变形。变换应用到模型,模型呈现动画效果。

动画控制通过AnimationAction实现。Action有播放、暂停、停止等方法。调整Action的timeScale改变播放速度,调整time跳转到指定时间。

多个动画可以混合播放,使用Action的权重控制不同动画的影响程度。比如走路动画和攻击动画混合,角色边走边攻击。

## 接口定义

### 创建渲染器

创建渲染器接口接收容器元素和配置对象。容器元素是HTML元素,渲染器的Canvas渲染在这个容器中。配置对象包含初始模型源、渲染质量、相机预设等参数。

接口创建渲染器实例,创建WebGL上下文,初始化Three.js场景和渲染器,开始渲染循环,返回实例标识符。创建是异步的,返回Promise,渲染器就绪后Promise resolve。

### 加载模型

加载模型接口接收模型文件路径,解析为实际的资源位置。通过资源管理系统获取模型数据,使用对应的加载器加载。

加载完成后,将模型添加到场景,计算包围盒,调整相机使模型完整显示。如果模型包含动画,初始化动画系统。触发加载完成事件。

### 相机控制

设置相机位置接口接收位置向量,更新相机的位置属性。设置相机目标接口接收目标点向量,更新控制器的目标。

应用预设视角接口接收预设标识,比如前视图、侧视图。查找预设的相机参数,相机平滑过渡到预设位置。

切换投影模式接口在透视投影和正交投影之间切换,创建新的相机对象,保持查看角度不变。

### 渲染控制

设置渲染质量接口接收质量标识,包括低、中、高。根据质量调整渲染参数,高质量开启所有特效,低质量关闭部分特效。

开启关闭阴影接口设置渲染器和光源的阴影属性。开启阴影时,光源投射阴影,物体接收阴影。关闭阴影时,不渲染阴影贴图。

暂停和恢复渲染接口控制渲染循环。暂停时停止requestAnimationFrame,不再渲染。恢复时重新启动渲染循环。暂停可以节省资源,不查看时暂停渲染。

### 动画控制

播放动画接口接收动画标识,从模型的动画列表中查找动画,创建Action并播放。暂停接口暂停当前Action,停止接口停止并重置Action。

设置播放速度接口调整Action的timeScale属性,大于1加速,小于1减速。跳转接口设置Action的time属性,跳转到指定时间。

获取动画列表接口返回模型包含的所有动画名称和时长。当前动画状态接口返回正在播放的动画、播放进度、播放速度等信息。

### 材质控制

修改材质接口接收目标对象标识和材质参数。查找场景中的对象,更新其材质属性。材质参数包括颜色、金属度、粗糙度等。

材质变化立即生效,场景在下一帧渲染时应用新材质。材质修改可以撤销,维护材质修改历史。

### 交互控制

选择对象接口接收屏幕坐标,使用射线检测查找坐标处的3D对象。返回对象标识和交点信息。选中的对象高亮显示,添加高亮材质或轮廓线。

测量距离接口接收两点的屏幕坐标,转换为3D坐标,计算空间距离。在场景中绘制测量线和距离标注。

剖切接口接收剖切平面参数,包括位置和法向量。使用Three.js的ClippingPlane实现剖切,平面一侧的几何体被裁剪不显示。

### 截图和导出

截图接口将当前渲染画面保存为图片。读取Canvas的像素数据,转换为PNG或JPEG图片。图片分辨率可以自定义,支持超过Canvas尺寸的高分辨率截图。

导出模型接口将当前场景导出为GLTF文件。使用GLTFExporter遍历场景,序列化为GLTF格式。导出包含模型、材质、纹理等完整信息。

### 事件订阅

事件订阅接口接收事件名称和回调函数,将回调注册到事件列表。支持的事件包括模型加载完成、加载失败、相机变化、动画播放完成、对象选中等。

事件通过微内核的事件总线分发,订阅者通过事件总线接收事件。事件对象包含事件类型、渲染器标识、时间戳、相关数据等信息。

### 销毁渲染器

销毁接口停止渲染循环,清理场景中的所有对象,释放几何体和纹理,销毁WebGL上下文,移除Canvas元素。从实例管理器中移除记录。销毁后渲染器实例不再可用。

## 使用方式

### 创建和初始化

3D模型卡片插件需要显示模型时,通过微内核向3D模型渲染器模块发送创建请求。请求包含容器元素的标识和渲染器配置。

渲染器模块创建渲染器实例,创建Canvas渲染到指定容器中。初始化Three.js场景,添加光照和相机。返回渲染器实例标识,插件保存这个标识。

### 加载和显示

创建渲染器后,发送加载模型请求,传入模型文件路径。渲染器通过资源管理系统获取模型,使用Three.js加载器解析。

加载完成后,将模型添加到场景,自动调整相机位置使模型完整显示。渲染循环开始,模型显示在容器中。用户可以旋转缩放查看模型。

### 用户交互

用户与模型交互时,比如拖动旋转、滚轮缩放、右键平移,OrbitControls捕获事件并更新相机。相机变化时,场景重新渲染,用户看到不同角度的模型。

插件可以监听相机变化事件,保存相机状态到配置文件。下次打开时,从配置读取相机状态,恢复到上次的查看角度。

### 动画播放

模型包含动画时,插件可以发送播放动画请求。渲染器查找动画,创建AnimationAction并播放。动画在渲染循环中更新,模型呈现动画效果。

插件提供动画控制界面,包括播放暂停按钮、进度条、速度调节。用户操作时,插件发送相应的控制请求,渲染器执行操作。

动画播放完成时,触发事件通知插件。插件可以自动播放下一个动画,或循环播放当前动画。

### 材质和光照调整

插件可以提供材质编辑功能,用户调整颜色、金属度、粗糙度等参数。插件发送修改材质请求,渲染器更新材质,模型实时预览效果。

光照也可以调整,改变光照颜色、强度、位置。调整光照改变模型的外观,呈现不同的视觉效果。

### 性能优化

渲染器根据设备性能自动调整渲染质量。检测帧率,如果帧率低于阈值,降低质量保证流畅。如果帧率稳定且高,提升质量改善视觉效果。

插件可以提供质量设置选项,用户手动选择质量级别。高性能设备选择高质量,低性能设备选择低质量。

### 清理资源

卡片关闭时,插件发送销毁渲染器请求。渲染器停止渲染,清理场景,释放几何体纹理,销毁WebGL上下文,移除Canvas。确保不会因为渲染器实例未销毁导致内存泄漏或GPU资源占用。

## 技术细节

### WebGL上下文

WebGL上下文提供GPU渲染能力,Three.js的WebGLRenderer封装WebGL。创建渲染器时,指定Canvas元素,渲染器在Canvas上创建WebGL上下文。

上下文参数包括抗锯齿、alpha透明、深度缓冲等。抗锯齿消除锯齿但有性能开销,根据质量设置决定是否启用。

上下文丢失处理,WebGL上下文可能因为GPU重置等原因丢失。监听webglcontextlost事件,上下文丢失时暂停渲染,等待webglcontextrestored事件,上下文恢复后重新初始化。

### 性能优化

使用几何体合并减少渲染调用次数。多个使用相同材质的网格合并为一个,减少draw call。合并要注意内存,合并后的几何体更大。

使用实例渲染绘制大量相同对象。实例渲染一次draw call绘制多个实例,每个实例有不同的变换。适用于树木、草地等大量重复对象。

使用frustum culling剔除视锥外对象。Three.js自动剔除不在相机视野内的对象,不渲染看不见的部分。

使用LOD技术优化远处对象。创建多个不同精度的模型,根据相机距离选择合适精度。近处使用高精度模型,远处使用低精度模型。

### 阴影优化

阴影贴图分辨率影响阴影质量和性能。高分辨率阴影清晰但渲染慢,低分辨率阴影模糊但快速。根据质量设置调整分辨率。

使用阴影贴图偏移避免阴影痤疮。阴影渲染时的浮点误差导致表面出现条纹,偏移可以消除条纹。

级联阴影贴图优化大场景阴影。将视锥分成多个级联,每个级联使用独立的阴影贴图。近处使用高分辨率,远处使用低分辨率。

### 内存管理

几何体和纹理占用显存,不再使用时要释放。调用geometry.dispose()释放几何体,调用texture.dispose()释放纹理。

渲染器销毁时,遍历场景中所有对象,逐个释放几何体材质纹理。确保所有GPU资源都被清理。

使用纹理压缩减少显存占用。KTX2格式的压缩纹理直接上传GPU,不需要解压,节省显存和带宽。

### 抗锯齿

MSAA多重采样抗锯齿,渲染时每个像素采样多次,取平均值。抗锯齿效果好但性能开销大。

FXAA快速近似抗锯齿,后期处理算法,检测边缘并模糊。性能开销小但效果不如MSAA。

SMAA增强的子像素形态抗锯齿,结合MSAA和FXAA的优点。质量高性能好,推荐使用。

根据质量设置选择抗锯齿算法。高质量使用MSAA或SMAA,低质量使用FXAA或不使用。
