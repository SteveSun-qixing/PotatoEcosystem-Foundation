# Markdown解析器 - 技术文档

## 架构设计

Markdown解析器基于成熟的Markdown库构建,使用marked、markdown-it或remark等库作为底层实现。在其之上封装符合薯片生态规范的接口层。

解析过程分为词法分析、语法分析、渲染三个阶段。词法分析将Markdown文本分解为token流,语法分析将token组织为抽象语法树,渲染将语法树转换为HTML。

支持插件机制,可以扩展解析器的功能。插件可以添加新的语法规则,可以修改渲染逻辑,可以处理特殊的内容类型。

## 接口定义

解析接口接收Markdown文本和配置选项,返回HTML字符串。配置选项包括是否启用GFM扩展、是否解析前置元数据、代码高亮语言等。

渲染器定制接口允许注册自定义渲染函数,处理特定类型的节点。比如自定义链接的渲染,添加图片懒加载,处理内部链接等。

## 使用方式

Markdown卡片插件需要显示Markdown时,通过微内核向Markdown解析器发送解析请求。传入Markdown文本,接收HTML输出,渲染到界面。

代码块的语法高亮通过代码高亮器模块实现,解析器识别代码块的语言,调用高亮器处理,插入高亮后的HTML。

## 技术细节

使用流式解析提高性能,边读取边解析,不需要一次性加载整个文档。使用增量解析,文档变化时只重新解析变化的部分。

安全过滤使用白名单机制,只允许安全的HTML标签和属性,过滤script、iframe等危险标签。使用DOM Purify库进行HTML净化。
